<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Text Roguelike Web</title>
    <style>
        /* 全体のスタイル：レトロな端末風 */
        body {
            background-color: #111; /* 背景をより暗く */
            color: #ccc;
            font-family: 'Courier New', 'Consolas', monospace; /* 等幅フォントを強制 */
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }
        h1 { margin: 10px 0; font-size: 24px; color: #fff; }
        #game-container {
            border: 2px solid #333;
            background-color: #000; /* キャンバス背景は真っ黒 */
            /* 文字がぼやけないようにする設定（ブラウザによる） */
            image-rendering: pixelated; 
        }
        canvas { display: block; }
        #ui {
            width: 640px; /* キャンバス幅に合わせる */
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 18px;
            color: #fff;
        }
        #log {
            width: 640px;
            height: 120px;
            border: 1px solid #333;
            margin-top: 10px;
            padding: 8px;
            overflow-y: scroll;
            font-size: 16px;
            background: #0a0a0a;
            color: #aaa;
            font-family: 'Courier New', monospace;
        }
        .controls {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>

    <h1>Text Roguelike Web</h1>
    
    <div id="ui">
        <span id="stats">HP: 20 | Level: 1</span>
        <span id="floor">Floor: 1</span>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas" width="640" height="480"></canvas>
    </div>

    <div id="log">迷宮探索を開始します...</div>

    <div class="controls">
        操作: 矢印キー または WASD (移動/攻撃)<br>
        記号: <span style="color:yellow">@</span>:あなた <span style="color:red">g</span>:敵 <span style="color:#666">#</span>:壁 <span style="color:#333">.</span>:床 <span style="color:#44f">&gt;</span>:階段
    </div>

<script>
    // --- 設定 ---
    // 文字が見やすいようにサイズを少し大きくしました
    const TILE_SIZE = 24; 
    const ROWS = 20;
    const COLS = 26; // 横幅がはみ出ないように少し調整
    const MAX_ENEMIES = 6;

    // タイルの種類
    const TILE = {
        FLOOR: 0,
        WALL: 1,
        STAIRS: 2
    };

    // --- ゲーム状態 ---
    let canvas, ctx;
    let map = [];
    // 初期HPを少し増やしました
    let player = { x: 1, y: 1, hp: 25, maxHp: 25, level: 1, xp: 0 };
    let enemies = [];
    let floorLevel = 1;
    let messages = [];

    // --- 初期化 ---
    window.onload = () => {
        canvas = document.getElementById('gameCanvas');
        ctx = canvas.getContext('2d');
        
        // キャンバスサイズをタイルサイズに合わせて正確に設定
        canvas.width = COLS * TILE_SIZE;
        canvas.height = ROWS * TILE_SIZE;
        // UIの幅も合わせる
        document.getElementById('ui').style.width = canvas.width + 'px';
        document.getElementById('log').style.width = canvas.width + 'px';

        startLevel();
        document.addEventListener('keydown', handleInput);
        draw(); // 最初の描画
    };

    // --- レベル生成 ---
    function startLevel() {
        map = [];
        enemies = [];
        
        // 全て壁(#)にする
        for (let y = 0; y < ROWS; y++) {
            let row = [];
            for (let x = 0; x < COLS; x++) {
                row.push(TILE.WALL);
            }
            map.push(row);
        }

        // 床(.)を掘る
        let digX = Math.floor(COLS / 2);
        let digY = Math.floor(ROWS / 2);
        // 掘る回数を増やして広めに
        for (let i = 0; i < 400; i++) {
            map[digY][digX] = TILE.FLOOR;
            const dir = Math.floor(Math.random() * 4);
            if (dir === 0) digX++;
            else if (dir === 1) digX--;
            else if (dir === 2) digY++;
            else if (dir === 3) digY--;

            if (digX < 1) digX = 1;
            if (digX >= COLS - 1) digX = COLS - 2;
            if (digY < 1) digY = 1;
            if (digY >= ROWS - 1) digY = ROWS - 2;
        }

        spawnEntity(player);
        spawnStairs();

        for(let i=0; i<MAX_ENEMIES + Math.floor(floorLevel/2); i++) {
            // 敵の種類を少しだけ多様に (名前の頭文字が表示される)
            let type = Math.random();
            let name = "goblin";
            let hp = 8 + floorLevel;
            if (type > 0.7) { name = "orc"; hp += 5; }
            if (type > 0.9) { name = "troll"; hp += 10; }

            let enemy = { x: 0, y: 0, hp: hp, name: name };
            if(spawnEntity(enemy)) {
                enemies.push(enemy);
            }
        }
        
        log(`=== 地下 ${floorLevel} 階 ===`);
        updateUI();
    }

    function spawnEntity(entity) {
        let placed = false;
        let attempts = 0;
        while (!placed && attempts < 100) {
            let x = Math.floor(Math.random() * COLS);
            let y = Math.floor(Math.random() * ROWS);
            if (map[y][x] === TILE.FLOOR && !getEnemyAt(x, y) && (x !== player.x || y !== player.y)) {
                entity.x = x;
                entity.y = y;
                placed = true;
            }
            attempts++;
        }
        return placed;
    }

    function spawnStairs() {
        let placed = false;
        let attempts = 0;
        while (!placed && attempts < 100) {
            let x = Math.floor(Math.random() * COLS);
            let y = Math.floor(Math.random() * ROWS);
            if (map[y][x] === TILE.FLOOR && (x !== player.x || y !== player.y)) {
                map[y][x] = TILE.STAIRS;
                placed = true;
            }
            attempts++;
        }
    }

    // --- 入力処理 ---
    function handleInput(e) {
        // ブラウザのスクロールなどを防ぐ
        if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].indexOf(e.code) > -1) {
            e.preventDefault();
        }

        let dx = 0; let dy = 0;
        if (e.key === 'ArrowUp' || e.key === 'w') dy = -1;
        if (e.key === 'ArrowDown' || e.key === 's') dy = 1;
        if (e.key === 'ArrowLeft' || e.key === 'a') dx = -1;
        if (e.key === 'ArrowRight' || e.key === 'd') dx = 1;
        // 待機（スペースキーなど）を追加しても良い

        if (dx !== 0 || dy !== 0) {
            playerTurn(dx, dy);
        }
    }

    // --- ターン処理 ---
    function playerTurn(dx, dy) {
        const targetX = player.x + dx;
        const targetY = player.y + dy;

        if (map[targetY][targetX] === TILE.WALL) {
            log("壁だ。");
            return; // 壁ならターン消費しない（好みによる）
        }

        let enemy = getEnemyAt(targetX, targetY);
        if (enemy) {
            attack(player, enemy);
        } else {
            player.x = targetX;
            player.y = targetY;
            log(`移動した (${player.x},${player.y})`);
            
            if (map[targetY][targetX] === TILE.STAIRS) {
                log("階段を降りた！");
                floorLevel++;
                startLevel();
                draw(); // レベル遷移時は即座に描画
                return;
            }
        }

        enemyTurn();
        updateUI();
        draw(); // ターン終了後に描画更新
    }

    function enemyTurn() {
        enemies.forEach(e => {
            if (e.hp <= 0) return;

            let dx = 0; let dy = 0;
            // 視界チェック（簡易）：距離が近い場合のみ反応
            const dist = Math.abs(player.x - e.x) + Math.abs(player.y - e.y);
            if (dist < 8) {
                if (player.x > e.x) dx = 1;
                else if (player.x < e.x) dx = -1;
                else if (player.y > e.y) dy = 1;
                else if (player.y < e.y) dy = -1;
            }

            const targetX = e.x + dx;
            const targetY = e.y + dy;

            if (targetX === player.x && targetY === player.y) {
                attack(e, player);
            } 
            else if (map[targetY][targetX] !== TILE.WALL && !getEnemyAt(targetX, targetY)) {
                e.x = targetX;
                e.y = targetY;
            }
        });
        enemies = enemies.filter(e => e.hp > 0);
    }

    // --- 戦闘処理 ---
    function attack(attacker, defender) {
        // ダメージ計算を少し調整
        let baseDamage = (attacker === player) ? Math.floor(player.level/2) + 2 : 2;
        let damage = Math.floor(Math.random() * baseDamage) + 1;
        defender.hp -= damage;

        let name = (attacker === player) ? "あなた" : attacker.name;
        let targetName = (defender === player) ? "あなた" : defender.name;
        let colorStr = (defender === player) ? 'style="color:red"' : 'style="color:yellow"';
        
        log(`<span ${colorStr}>${name} は ${targetName} に ${damage} のダメージ！</span>`);

        if (defender.hp <= 0) {
            log(`*** ${targetName} を倒した！ ***`);
            if (defender === player) {
                log('<span style="color:red; font-weight:bold;">GAME OVER... リロードして再挑戦</span>');
                // 操作を無効化するなどの処理が本来は必要
            } else {
                player.xp += defender.name === 'troll' ? 20 : 10;
                if(player.xp >= player.level * 25) {
                    player.level++;
                    player.maxHp += 8;
                    player.hp = player.maxHp;
                    player.xp = 0;
                    log(`<span style="color:cyan">レベルアップ！ Level ${player.level} になった！(HP全回復)</span>`);
                }
            }
        }
    }

    function getEnemyAt(x, y) {
        return enemies.find(e => e.x === x && e.y === y && e.hp > 0);
    }

    // --- 描画 (テキスト方式に変更) ---
    function draw() {
        // 画面を真っ黒にクリア
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // フォント設定：等幅フォント、サイズ指定
        // 若干高さを調整して中央に見えるようにする
        ctx.font = `${TILE_SIZE - 2}px 'Courier New', monospace`;
        ctx.textAlign = 'center';     // 左右中央揃え
        ctx.textBaseline = 'middle';  // 上下中央揃え

        // マップの描画
        for (let y = 0; y < ROWS; y++) {
            for (let x = 0; x < COLS; x++) {
                // タイルの中心座標を計算
                const posX = x * TILE_SIZE + TILE_SIZE / 2;
                // ベースライン調整のための微調整オフセット
                const posY = y * TILE_SIZE + TILE_SIZE / 2 + 2; 

                let char = ' ';
                let color = '#000';

                if (map[y][x] === TILE.WALL) {
                    char = '#';
                    color = '#555'; // 暗い灰色の壁
                } else if (map[y][x] === TILE.FLOOR) {
                    char = '.';
                    color = '#333'; // さらに暗い灰色の床
                } else if (map[y][x] === TILE.STAIRS) {
                    char = '>';
                    color = '#44f'; // 青い階段
                }

                ctx.fillStyle = color;
                ctx.fillText(char, posX, posY);
            }
        }

        // 敵の描画
        enemies.forEach(e => {
            const posX = e.x * TILE_SIZE + TILE_SIZE / 2;
            const posY = e.y * TILE_SIZE + TILE_SIZE / 2 + 2;
            ctx.fillStyle = '#f44'; // 赤っぽい色
            // 名前の頭文字を表示 (goblin -> g)
            ctx.fillText(e.name.charAt(0), posX, posY);
        });

        // プレイヤーの描画
        if (player.hp > 0) {
            const playerX = player.x * TILE_SIZE + TILE_SIZE / 2;
            const playerY = player.y * TILE_SIZE + TILE_SIZE / 2 + 2;
            ctx.fillStyle = 'yellow'; // 黄色
            ctx.fillText('@', playerX, playerY); // 自機は @
        }
    }

    function log(msg) {
        messages.push(msg);
        if (messages.length > 20) messages.shift(); // 表示ログ数を制限
        
        const logEl = document.getElementById('log');
        // 最新が下に来るように表示
        logEl.innerHTML = messages.join('<br>');
        logEl.scrollTop = logEl.scrollHeight; // 自動スクロール
    }

    function updateUI() {
        document.getElementById('stats').innerHTML = `HP: <span style="color:${player.hp < player.maxHp*0.3 ? 'red':'fff'}">${player.hp}</span>/${player.maxHp} | Lvl: ${player.level} | XP: ${player.xp}`;
        document.getElementById('floor').innerText = `B${floorLevel}F`;
    }
</script>
</body>
</html>
