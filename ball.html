<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Merge</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        :root {
            --bg-color: #0b0d17;
            --panel-bg: #15192b;
            --text-color: #a0aab5;
            --highlight: #00d2ff;
            --danger: #ff0055;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }

        .game-wrapper {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ゲームエリア */
        #game-container {
            position: relative;
            width: 400px;
            height: 600px;
            border-radius: 12px;
            border: 2px solid #334;
            background: #0f111a;
            overflow: hidden; /* はみ出し防止 */
        }

        canvas { display: block; }

        /* ゲームオーバーライン */
        #limit-line {
            position: absolute;
            top: 100px; /* ゲームオーバーラインの高さ */
            left: 0;
            width: 100%;
            height: 2px;
            border-top: 2px dashed rgba(255, 255, 255, 0.3);
            pointer-events: none;
            z-index: 10;
            transition: border-color 0.3s;
        }
        #limit-line.danger {
            border-color: var(--danger);
            box-shadow: 0 0 10px var(--danger);
            animation: flash 0.5s infinite alternate;
        }
        #limit-line::after {
            content: "DANGER LINE";
            position: absolute;
            right: 10px;
            top: -15px;
            font-size: 10px;
            color: rgba(255,255,255,0.3);
        }

        /* ゲームオーバー画面 */
        #game-over-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none; /* 初期は非表示 */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        #game-over-screen h2 { color: var(--danger); font-size: 32px; margin: 0 0 20px; letter-spacing: 5px; }
        button.retry-btn {
            background: var(--highlight);
            border: none;
            padding: 10px 30px;
            color: #000;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            border-radius: 30px;
            transition: transform 0.1s;
        }
        button.retry-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--highlight); }

        /* サイドパネル */
        .side-panel {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-card {
            background: var(--panel-bg);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .label { font-size: 12px; letter-spacing: 2px; color: #556; margin-bottom: 5px; width: 100%; }
        .score-val { font-size: 32px; font-weight: bold; color: var(--highlight); text-shadow: 0 0 10px rgba(0, 210, 255, 0.5); }
        
        #next-display { width: 100%; height: 80px; display: flex; align-items: center; justify-content: center; }
        .planet-preview { border-radius: 50%; transition: all 0.3s ease; }

        .evolution-container {
            position: relative;
            width: 260px; height: 260px;
            margin: 0 auto;
            border-radius: 50%;
        }
        .planet-node {
            position: absolute;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .evo-ring {
            position: absolute;
            top: 15%; left: 15%;
            width: 70%; height: 70%;
            border: 1px dashed rgba(255,255,255,0.1);
            border-radius: 50%;
            pointer-events: none;
        }
        .evo-label {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px; color: #445; letter-spacing: 1px;
        }

        @keyframes flash { from { opacity: 0.5; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="game-wrapper">
    <div id="game-container">
        <div id="limit-line"></div>
        <div id="game-over-screen">
            <h2>GAME OVER</h2>
            <div class="score-val" id="final-score" style="margin-bottom: 20px;">0</div>
            <button class="retry-btn" onclick="location.reload()">RETRY</button>
        </div>
        <canvas id="world"></canvas>
    </div>

    <div class="side-panel">
        <div class="info-card">
            <div class="label">SCORE</div>
            <div id="score" class="score-val">0</div>
        </div>
        <div class="info-card">
            <div class="label">NEXT ORBIT</div>
            <div id="next-display"></div>
        </div>
        <div class="info-card" style="flex-grow: 1;">
            <div class="label" style="margin-bottom: 20px;">EVOLUTION CIRCLE</div>
            <div class="evolution-container" id="evo-circle">
                <div class="evo-ring"></div>
                <div class="evo-label">COSMOS</div>
            </div>
        </div>
    </div>
</div>

<script>
const { Engine, Render, Runner, Bodies, Composite, Events, Body } = Matter;

// --- 定数設定 ---
const WIDTH = 400;
const HEIGHT = 600;
const WALL_THICKNESS = 100; // 壁を厚くして外に出ないように
const GAME_OVER_Y = 100;    // ゲームオーバーラインのY座標
const SPAWN_Y = 30;         // 出現位置
const TIME_TO_LOSE = 3000;  // ゲームオーバーまでの猶予（ミリ秒）

const PLANETS = [
    { r: 15, color: "#CFD8DC", glow: "#fff", score: 1 },
    { r: 22, color: "#FFCC80", glow: "#FFA726", score: 2 },
    { r: 30, color: "#81D4FA", glow: "#29B6F6", score: 4 },
    { r: 38, color: "#66BB6A", glow: "#4CAF50", score: 8 },
    { r: 48, color: "#AB47BC", glow: "#E1BEE7", score: 16 },
    { r: 60, color: "#EF5350", glow: "#FFCDD2", score: 32 },
    { r: 72, color: "#FFA726", glow: "#FFE0B2", score: 64 },
    { r: 85, color: "#26C6DA", glow: "#80DEEA", score: 128 },
    { r: 100, color: "#FFEE58", glow: "#FFF9C4", score: 256 },
    { r: 120, color: "#FFFFFF", glow: "#FFFFFF", score: 512 } // Max (Level 9)
];

// --- 状態変数 ---
let score = 0;
let isClickable = false;
let currentBallBody = null;
let currentLevel = 0;
let nextLevel = 0;
let gameOverTimer = 0;
let isGameOver = false;

// --- Matter.js セットアップ ---
const engine = Engine.create();
const world = engine.world;

const render = Render.create({
    canvas: document.getElementById('world'),
    engine: engine,
    options: {
        width: WIDTH,
        height: HEIGHT,
        wireframes: false,
        background: 'transparent' // CSSで背景色指定済み
    }
});

// 壁の生成（上部には壁を作らず、左右の壁を上に伸ばす）
const wallOpts = { isStatic: true, render: { fillStyle: '#1f2233' } };
const ground = Bodies.rectangle(WIDTH/2, HEIGHT + WALL_THICKNESS/2, WIDTH, WALL_THICKNESS, wallOpts);
// 左右の壁を画面上部外まで伸ばす（高さ2倍）
const leftWall = Bodies.rectangle(0 - WALL_THICKNESS/2, HEIGHT/2 - 200, WALL_THICKNESS, HEIGHT + 400, wallOpts);
const rightWall = Bodies.rectangle(WIDTH + WALL_THICKNESS/2, HEIGHT/2 - 200, WALL_THICKNESS, HEIGHT + 400, wallOpts);

Composite.add(world, [ground, leftWall, rightWall]);

// --- UI系関数 ---
function initEvolutionCircle() {
    const container = document.getElementById('evo-circle');
    const radius = 100; const centerX = 130; const centerY = 130;
    PLANETS.forEach((planet, index) => {
        const angle = (index / PLANETS.length) * (2 * Math.PI) - (Math.PI / 2);
        const node = document.createElement('div');
        node.className = 'planet-node';
        const displaySize = Math.max(15, planet.r * 0.4); 
        node.style.cssText = `
            width: ${displaySize*2}px; height: ${displaySize*2}px;
            background-color: ${planet.color}; box-shadow: 0 0 8px ${planet.glow};
            left: ${centerX + Math.cos(angle)*radius}px; top: ${centerY + Math.sin(angle)*radius}px;
        `;
        container.appendChild(node);
    });
}

function updateNextDisplay() {
    const container = document.getElementById('next-display');
    container.innerHTML = '';
    const planet = PLANETS[nextLevel];
    const preview = document.createElement('div');
    preview.className = 'planet-preview';
    const previewSize = planet.r * 1.5;
    preview.style.cssText = `
        width: ${previewSize}px; height: ${previewSize}px;
        background-color: ${planet.color}; box-shadow: 0 0 15px ${planet.glow};
    `;
    container.appendChild(preview);
}

// --- ゲームロジック ---

function createBody(x, y, level, isStatic = false) {
    const p = PLANETS[level];
    return Bodies.circle(x, y, p.r, {
        label: `planet_${level}`,
        level: level,
        isStatic: isStatic,
        restitution: 0.3,
        friction: 0.1,
        render: { fillStyle: p.color, strokeStyle: '#fff', lineWidth: level===9 ? 4 : 0 }
    });
}

function initGame() {
    currentLevel = Math.floor(Math.random() * 4);
    nextLevel = Math.floor(Math.random() * 4);
    updateNextDisplay();
    spawnCurrentBall();
}

function spawnCurrentBall() {
    if (isGameOver) return;
    currentBallBody = createBody(WIDTH / 2, SPAWN_Y, currentLevel, true);
    // 衝突判定無効化（操作中は他のボールとぶつからない）
    currentBallBody.collisionFilter = { group: -1, category: 2, mask: 0 }; 
    Composite.add(world, currentBallBody);
    isClickable = true;
}

function nextTurn() {
    if (isGameOver) return;
    currentLevel = nextLevel;
    nextLevel = Math.floor(Math.random() * 4);
    updateNextDisplay();
    spawnCurrentBall();
}

function setGameOver() {
    isGameOver = true;
    document.getElementById('final-score').innerText = score;
    document.getElementById('game-over-screen').style.display = 'flex';
    Runner.stop(runner); // 物理演算停止
}

// --- イベントループ ---

// ゲームオーバー判定ループ (beforeUpdate)
Events.on(engine, 'beforeUpdate', (event) => {
    if (isGameOver) return;

    const bodies = Composite.allBodies(world);
    let danger = false;

    // 現在操作中のボール(isStatic)や壁以外の物体をチェック
    for (const body of bodies) {
        if (!body.isStatic && body.label.startsWith('planet_')) {
            // Y座標がラインより上、かつ落下速度がほぼ0（積み上がっている）
            if (body.position.y < GAME_OVER_Y && Math.abs(body.velocity.y) < 0.2) {
                danger = true;
                break;
            }
        }
    }

    const line = document.getElementById('limit-line');
    if (danger) {
        gameOverTimer += engine.timing.lastDelta;
        line.classList.add('danger');
        if (gameOverTimer > TIME_TO_LOSE) {
            setGameOver();
        }
    } else {
        gameOverTimer = 0;
        line.classList.remove('danger');
    }
});

// マウス移動
const gameContainer = document.getElementById('game-container');
gameContainer.addEventListener('mousemove', (e) => {
    if (!isClickable || !currentBallBody) return;
    const rect = gameContainer.getBoundingClientRect();
    let x = e.clientX - rect.left;
    
    // 壁制限
    const r = PLANETS[currentLevel].r;
    if (x < r + 5) x = r + 5;
    if (x > WIDTH - r - 5) x = WIDTH - r - 5;
    
    Body.setPosition(currentBallBody, { x: x, y: SPAWN_Y });
});

// クリック（落下）
gameContainer.addEventListener('mousedown', (e) => {
    if (!isClickable || !currentBallBody) return;
    isClickable = false;
    
    // 物理演算有効化
    Body.setStatic(currentBallBody, false);
    // 衝突判定を戻す（壁や他のボールと当たるように）
    currentBallBody.collisionFilter = { group: 0, category: 1, mask: 4294967295 };
    
    currentBallBody = null;
    setTimeout(nextTurn, 800);
});

// 衝突・合体ロジック
Events.on(engine, 'collisionStart', (event) => {
    const pairs = event.pairs;
    const processed = new Set();

    for (let i = 0; i < pairs.length; i++) {
        const { bodyA, bodyB } = pairs[i];
        if (bodyA.isStatic || bodyB.isStatic) continue;

        if (bodyA.level !== undefined && bodyA.level === bodyB.level) {
            if (processed.has(bodyA.id) || processed.has(bodyB.id)) continue;
            processed.add(bodyA.id);
            processed.add(bodyB.id);

            const newLevel = bodyA.level + 1;
            const midX = (bodyA.position.x + bodyB.position.x) / 2;
            const midY = (bodyA.position.y + bodyB.position.y) / 2;

            // 両方削除
            Composite.remove(world, [bodyA, bodyB]);

            if (newLevel < PLANETS.length) {
                // 通常進化
                const newBall = createBody(midX, midY, newLevel, false);
                Composite.add(world, newBall);
                score += PLANETS[newLevel].score;
            } else {
                // ★最大レベル同士の衝突 -> 消滅（Annihilation）
                // 新しいボールを作らず、高得点だけ加算
                score += 1000; 
                // エフェクト代わりのパーティクルなどを出すならここ
            }
            document.getElementById('score').innerText = score;
        }
    }
});

// 実行
initEvolutionCircle();
initGame();
Render.run(render);
const runner = Runner.create();
Runner.run(runner, engine);

</script>
</body>
</html>
