<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第九曼荼羅 - The 9th Mandala (Ver.Save)</title>
    <style>
        :root {
            --theme-color: #6a0dad;
            --theme-glow: rgba(106, 13, 173, 0.5);
            --bg-black: #050505;
            --text-gold: #d4af37;
            --card-bg: rgba(20, 20, 20, 0.85);
            --panel-bg: rgba(10, 10, 10, 0.6);
        }

        body {
            background-color: var(--bg-black);
            background-image: radial-gradient(circle at 30% 50%, rgba(0,0,0,0) 0%, var(--bg-black) 90%),
                              radial-gradient(circle at 30% 50%, var(--theme-glow) 0%, transparent 60%);
            color: var(--text-gold);
            font-family: 'Yu Mincho', 'MS Mincho', serif;
            margin: 0;
            height: 100vh;
            overflow: hidden; /* 全体のスクロールを禁止（カラム別スクロール） */
            user-select: none;
            transition: color 1s ease, background-image 1s ease;
        }

        /* メインレイアウト（左右分割） */
        .main-wrapper {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* --- 左カラム：曼荼羅とステータス --- */
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            min-width: 320px;
        }

        #header {
            text-align: center;
            margin-bottom: 20px;
            z-index: 20;
            text-shadow: 0 0 10px var(--theme-glow);
        }

        h1 { font-size: 1.8rem; letter-spacing: 0.2rem; margin: 0; }
        .stats-main {
            font-size: 2.5rem;
            font-weight: bold;
            font-family: 'Times New Roman', serif;
            margin: 10px 0;
            color: #fff;
            text-shadow: 0 0 8px var(--theme-color);
        }
        .sub-stats { font-size: 0.95rem; color: #ccc; line-height: 1.5; }

        #mandala-stage {
            position: relative;
            width: 350px;
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s;
        }
        #mandala-stage:active { transform: scale(0.98); }

        .mandala-layer {
            position: absolute;
            border: 2px solid var(--theme-color);
            border-radius: 50%;
            opacity: 0.8;
            box-shadow: 0 0 15px var(--theme-glow);
            transition: all 1s ease;
        }
        #layer1 { width: 320px; height: 320px; border-style: double; border-width: 4px; animation: rotate 60s linear infinite; }
        #layer2 { width: 240px; height: 240px; border-style: dashed; animation: rotate 45s linear infinite reverse; }
        #layer3 { width: 160px; height: 160px; border-style: dotted; border-width: 3px; animation: rotate 30s linear infinite; }
        
        #core {
            width: 90px;
            height: 90px;
            background: radial-gradient(circle, var(--theme-color) 30%, transparent 80%);
            border: 1px solid var(--theme-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            text-shadow: 0 0 5px var(--theme-color);
            font-weight: bold;
            font-size: 2.5rem;
            z-index: 5;
            box-shadow: 0 0 40px var(--theme-glow);
            transition: all 0.2s ease;
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- 右カラム：ショップと設定 --- */
        .right-panel {
            flex: 0 0 450px; /* 幅固定 */
            background: var(--panel-bg);
            border-left: 1px solid #333;
            overflow-y: auto; /* 縦スクロール許可 */
            padding: 20px;
            box-shadow: -5px 0 20px rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        /* セーブ機能エリア */
        .system-section {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--theme-color);
            padding: 15px;
            margin-bottom: 25px;
            border-radius: 5px;
        }
        .system-title { font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #444; color: #fff; }
        .system-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
        
        .sys-btn {
            background: #222; color: #ccc; border: 1px solid #555;
            padding: 5px 10px; cursor: pointer; font-size: 0.8rem; flex: 1;
            transition: 0.2s;
        }
        .sys-btn:hover { background: #444; color: #fff; border-color: var(--text-gold); }

        /* ショップ共通 */
        .shop-section { margin-bottom: 25px; }
        .shop-title {
            font-size: 1.1rem;
            border-bottom: 1px solid var(--text-gold);
            margin-bottom: 10px;
            padding-bottom: 5px;
            color: #fff;
            position: sticky;
            top: 0;
            background: var(--bg-black); /* スクロール時に見出しが見やすいように */
            z-index: 10;
        }
        
        .item-card {
            background: var(--card-bg);
            border: 1px solid #444;
            padding: 8px 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.2s;
        }
        .item-card:hover { border-color: var(--text-gold); background: rgba(50, 50, 50, 0.95); }

        .item-info { display: flex; flex-direction: column; text-align: left; flex: 1; padding-right: 10px; }
        .item-name { font-weight: bold; color: var(--text-gold); font-size: 0.95rem; }
        .item-effect { font-size: 0.8rem; color: #aaa; margin: 2px 0; }
        .item-count { font-size: 0.75rem; color: #fff; opacity: 0.7; }

        .buy-btn {
            background: linear-gradient(to bottom, #333, #222);
            color: #fff;
            border: 1px solid #555;
            padding: 8px 10px;
            cursor: pointer;
            font-family: 'Times New Roman', serif;
            min-width: 90px;
            text-align: right;
            border-radius: 4px;
        }
        .buy-btn:hover:not(:disabled) { background: linear-gradient(to bottom, var(--theme-color), #222); border-color: #fff; }
        .buy-btn:disabled { color: #555; border-color: #222; background: #111; cursor: not-allowed; }
        .buy-btn small { display: block; font-size: 0.65rem; opacity: 0.8; }

        /* モバイル対応 */
        @media (max-width: 800px) {
            .main-wrapper { flex-direction: column; overflow-y: auto; }
            .left-panel { flex: 0 0 auto; min-height: 450px; }
            .right-panel { flex: 1; border-left: none; border-top: 1px solid #333; overflow-y: visible; }
            body { overflow: auto; }
        }

        /* エフェクト類 */
        .virtue-pop {
            position: absolute; color: #fff; font-weight: bold; pointer-events: none;
            animation: riseFade 0.6s ease-out forwards; z-index: 100;
            text-shadow: 0 0 3px #000; font-family: 'Times New Roman', serif;
        }
        @keyframes riseFade { 
            0% { opacity: 1; transform: translateY(0) scale(1); } 
            100% { opacity: 0; transform: translateY(-50px) scale(1.3); } 
        }

        /* 通知トースト */
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9); color: #000;
            padding: 10px 20px; border-radius: 20px; font-weight: bold;
            opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 1000;
        }

        /* 解脱画面 */
        #liberation-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; color: #000; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; animation: fadeIn 2s ease forwards;
        }
        #prestige-btn {
            padding: 15px 40px; font-size: 1.5rem; border: 2px solid #000;
            background: transparent; cursor: pointer; transition: 0.3s;
        }
        #prestige-btn:hover { background: #000; color: #fff; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body oncontextmenu="return false;">

    <div class="main-wrapper">
        <div class="left-panel">
            <div id="header">
                <h1 id="rank-name">第零曼荼羅：無明</h1>
                <div class="stats-main" id="virtue-display">0</div>
                <div class="sub-stats">
                    <span class="click-power-text">クリック力: <span id="click-display">1</span></span><br>
                    自動生産: <span id="ips-display">0</span> ips<br>
                    カルマ: <span id="karma-display" style="color: #ff4500; font-weight:bold;">0</span> 
                    (Bonus +<span id="karma-bonus">0</span>%)
                </div>
            </div>

            <div id="mandala-stage" onclick="clickMandala(event)">
                <div id="layer1" class="mandala-layer"></div>
                <div id="layer2" class="mandala-layer"></div>
                <div id="layer3" class="mandala-layer"></div>
                <div id="core">唵</div>
            </div>
        </div>

        <div class="right-panel">
            
            <div class="system-section">
                <div class="system-title">記録の帳</div>
                <div class="system-buttons">
                    <button class="sys-btn" onclick="saveGame()">ブラウザに記録</button>
                    <button class="sys-btn" onclick="exportSave()">復活の呪文を表示</button>
                    <button class="sys-btn" onclick="importSave()">呪文を唱える</button>
                    <button class="sys-btn" onclick="resetGame()" style="border-color:#500; color:#faa;">破棄して転生</button>
                </div>
                <div style="font-size:0.7rem; color:#666; margin-top:5px; text-align:right;">※1分ごとに自動記録されます</div>
            </div>

            <div class="shop-section">
                <div class="shop-title"><span>基礎作法 (クリック強化)</span></div>
                <div id="click-shop"></div>
            </div>

            <div class="shop-section">
                <div class="shop-title"><span>僧侶と諸天 (自動生産)</span></div>
                <div id="unit-shop"></div>
            </div>

            <div class="shop-section">
                <div class="shop-title"><span>経典と秘宝 (全体倍率)</span></div>
                <div id="upgrade-shop"></div>
            </div>
        </div>
    </div>

    <div id="toast">記録しました</div>

    <div id="liberation-overlay">
        <div style="font-size: 4rem; font-weight: bold; margin-bottom: 30px; letter-spacing: 1rem;">解放</div>
        <div style="font-size: 1.2rem; margin-bottom: 30px;">
            今生での徳の合計: <span id="total-virtue-end">0</span><br>
            獲得カルマ: <span id="pending-karma" style="font-weight:bold; font-size:1.5rem;">0</span>
        </div>
        <button id="prestige-btn" onclick="doPrestige()">輪廻転生</button>
    </div>

    <script>
        // --- 巨大数単位 ---
        function formatVirtue(num) {
            if (num < 10000) return Math.floor(num).toLocaleString();
            const units = ["", "万", "億", "兆", "京", "垓", "𥝱", "穣", "溝", "澗", "正", "載", "極", "恒河沙", "阿僧祇", "那由他", "不可思議", "無量大数"];
            let unitIndex = 0;
            let tempNum = num;
            while (tempNum >= 10000 && unitIndex < units.length - 1) {
                tempNum /= 10000;
                unitIndex++;
            }
            return tempNum.toFixed(2) + units[unitIndex];
        }

        // --- データ定義 ---
        const clickData = [ { name: "清貧", power: 1, cost: 10 } ];
        const unitData = [
            { name: "修行僧", rate: 1, cost: 15 },
            { name: "東の若僧", rate: 70, cost: 1500 },
            { name: "南の僧侶", rate: 300, cost: 8000 },
            { name: "南の高僧", rate: 40000, cost: 2000000 },
            { name: "西の老僧", rate: 2000000, cost: 150000000 },
            { name: "北の天才", rate: 800000000, cost: 50000000000 },
            { name: "無名天", rate: 10000000000, cost: 3000000000000 }, 
            { name: "怒れる明王", rate: 1000000000000, cost: 500000000000000 }, 
            { name: "慈愛の菩薩", rate: 100000000000000, cost: 80000000000000000 }, 
            { name: "圧巻の如来", rate: 10000000000000000, cost: 9000000000000000000 }
        ];
        const upgradeData = [
            { name: "弟子の写経", mult: 1.01, cost: 500 },
            { name: "中品質の写経", mult: 1.05, cost: 50000 },
            { name: "完璧な写経", mult: 1.08, cost: 10000000 },
            { name: "唐の経典", mult: 1.09, cost: 500000000 }, 
            { name: "天竺の経典", mult: 1.10, cost: 200000000000 },
            { name: "聖人のミイラ", mult: 1.20, cost: 100000000000000 }
        ];
        const rankNames = [
            { name: "第零曼荼羅：無明", color: "#6a0dad" },
            { name: "第一曼荼羅：胎蔵界", color: "#4b0082" },
            { name: "第二曼荼羅：金剛界", color: "#0000ff" },
            { name: "第三曼荼羅：阿弥陀", color: "#008000" },
            { name: "第四曼荼羅：蓮華", color: "#adff2f" },
            { name: "第五曼荼羅：虚空", color: "#ffff00" },
            { name: "第六曼荼羅：寂静", color: "#ffd700" },
            { name: "第七曼荼羅：遍照", color: "#ffa500" },
            { name: "第八曼荼羅：解脱", color: "#ff4500" },
            { name: "第九曼荼羅：不可説不可説転", color: "#ff0000" }
        ];

        // --- ゲーム状態 ---
        let game = {
            virtue: 0,
            totalVirtue: 0,
            karma: 0,
            rank: 0,
            clicks: new Array(clickData.length).fill(0),
            units: new Array(unitData.length).fill(0),
            upgrades: new Array(upgradeData.length).fill(0),
            lastSave: Date.now()
        };

        // --- 初期化 ---
        function init() {
            createShopUI();
            loadGame(); // ロード試行
            applyRankTheme(game.rank); // テーマ適用
            updateDisplay();
            gameLoop();
            
            // オートセーブ (60秒毎)
            setInterval(saveGame, 60000);
        }

        function createShopUI() {
            // クリック
            const cShop = document.getElementById('click-shop');
            clickData.forEach((c, i) => {
                cShop.innerHTML += createCardHTML(c.name, `クリック徳 +${c.power}`, `c-cnt-${i}`, `c-btn-${i}`, `c-cost-${i}`, `buyClickItem(${i})`);
            });
            // ユニット
            const uShop = document.getElementById('unit-shop');
            unitData.forEach((u, i) => {
                uShop.innerHTML += createCardHTML(u.name, `+${formatVirtue(u.rate)} /sec`, `u-cnt-${i}`, `u-btn-${i}`, `u-cost-${i}`, `buyUnit(${i})`);
            });
            // アップグレード
            const upShop = document.getElementById('upgrade-shop');
            upgradeData.forEach((u, i) => {
                upShop.innerHTML += createCardHTML(u.name, `生産量 ${Math.round((u.mult-1)*100)}% UP`, `up-cnt-${i}`, `up-btn-${i}`, `up-cost-${i}`, `buyUpgrade(${i})`);
            });
        }

        function createCardHTML(name, effect, countId, btnId, costId, func) {
            return `
                <div class="item-card">
                    <div class="item-info">
                        <span class="item-name">${name}</span>
                        <span class="item-effect">${effect}</span>
                        <span class="item-count" id="${countId}">所持: 0</span>
                    </div>
                    <button class="buy-btn" id="${btnId}" onclick="${func}">
                        <small>徳を捧げる</small>
                        <span id="${costId}">-</span>
                    </button>
                </div>`;
        }

        // --- セーブ/ロード機能 ---

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2000);
        }

        function saveGame() {
            game.lastSave = Date.now();
            localStorage.setItem('mandalaSave_v6', JSON.stringify(game));
            showToast("記録しました");
        }

        function loadGame() {
            const saved = localStorage.getItem('mandalaSave_v6');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // 既存データ構造とマージ（新バージョンで変数が増えた場合に対応）
                    game = { ...game, ...parsed };
                    
                    // 配列長の整合性チェック（アップデートでアイテムが増えた場合）
                    if (game.clicks.length < clickData.length) game.clicks = game.clicks.concat(new Array(clickData.length - game.clicks.length).fill(0));
                    if (game.units.length < unitData.length) game.units = game.units.concat(new Array(unitData.length - game.units.length).fill(0));
                    if (game.upgrades.length < upgradeData.length) game.upgrades = game.upgrades.concat(new Array(upgradeData.length - game.upgrades.length).fill(0));
                    
                    showToast("記録を読み込みました");
                } catch(e) {
                    console.error("Save file corrupted");
                }
            }
        }

        function exportSave() {
            saveGame();
            const str = btoa(JSON.stringify(game)); // Base64エンコード
            prompt("以下の呪文をコピーして保管してください:", str);
        }

        function importSave() {
            const str = prompt("復活の呪文を入力してください:");
            if (str) {
                try {
                    const decoded = atob(str);
                    const parsed = JSON.parse(decoded);
                    game = { ...game, ...parsed };
                    applyRankTheme(game.rank);
                    updateDisplay();
                    saveGame();
                    showToast("復活しました");
                } catch(e) {
                    alert("呪文が間違っています。");
                }
            }
        }

        function resetGame() {
            if(confirm("本当に全ての徳を捨てて最初からやり直しますか？（カルマも消えます）")) {
                localStorage.removeItem('mandalaSave_v6');
                location.reload();
            }
        }

        // --- ゲームロジック ---

        function getGlobalMultiplier() {
            let mult = 1;
            upgradeData.forEach((u, i) => mult *= Math.pow(u.mult, game.upgrades[i]));
            return mult * (1 + (game.karma * 0.1));
        }

        function calculateIPS() {
            let base = 0;
            unitData.forEach((u, i) => base += u.rate * game.units[i]);
            return base * getGlobalMultiplier();
        }

        function calculateClickPower() {
            let baseClick = 1;
            clickData.forEach((c, i) => baseClick += c.power * game.clicks[i]);
            return (baseClick * getGlobalMultiplier()) + (calculateIPS() * 0.05);
        }

        function clickMandala(e) {
            const power = calculateClickPower();
            addVirtue(power);
            
            // ポップアップ位置調整（親要素基準）
            const rect = document.getElementById('mandala-stage').getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const pop = document.createElement('div');
            pop.className = 'virtue-pop';
            pop.innerText = `+${formatVirtue(power)}`;
            pop.style.left = `${x}px`;
            pop.style.top = `${y}px`;
            document.getElementById('mandala-stage').appendChild(pop);
            setTimeout(() => pop.remove(), 600);

            const core = document.getElementById('core');
            core.style.transform = 'scale(1.1)';
            setTimeout(() => core.style.transform = 'scale(1)', 100);
        }

        function addVirtue(amount) {
            if (game.rank >= 9) return;
            game.virtue += amount;
            game.totalVirtue += amount;

            let threshold = Math.pow(100, game.rank + 1);
            if (game.rank === 8) threshold = 1000 * Math.pow(100, 9);

            if (game.virtue >= threshold && game.rank < 9) {
                game.rank++;
                applyRankTheme(game.rank);
                if (game.rank === 9) triggerLiberation();
            }
        }

        function buyClickItem(i) {
            const cost = Math.floor(clickData[i].cost * Math.pow(1.5, game.clicks[i]));
            if (game.virtue >= cost) { game.virtue -= cost; game.clicks[i]++; updateDisplay(); }
        }
        function buyUnit(i) {
            const cost = Math.floor(unitData[i].cost * Math.pow(1.15, game.units[i]));
            if (game.virtue >= cost) { game.virtue -= cost; game.units[i]++; updateDisplay(); }
        }
        function buyUpgrade(i) {
            const cost = Math.floor(upgradeData[i].cost * Math.pow(1.8, game.upgrades[i]));
            if (game.virtue >= cost) { game.virtue -= cost; game.upgrades[i]++; updateDisplay(); }
        }

        function updateDisplay() {
            if (game.rank >= 9) return;

            document.getElementById('virtue-display').innerText = formatVirtue(game.virtue);
            document.getElementById('ips-display').innerText = formatVirtue(calculateIPS());
            document.getElementById('click-display').innerText = formatVirtue(calculateClickPower());
            document.getElementById('karma-display').innerText = formatVirtue(game.karma);
            document.getElementById('karma-bonus').innerText = formatVirtue(game.karma * 10);

            const updateBtn = (id, baseCost, count, power, type) => {
                const cost = Math.floor(baseCost * Math.pow(power, count));
                const btn = document.getElementById(type + '-btn-' + id);
                document.getElementById(type + '-cost-' + id).innerText = formatVirtue(cost);
                document.getElementById(type + '-cnt-' + id).innerText = `所持: ${count}`;
                btn.disabled = game.virtue < cost;
            };

            clickData.forEach((c, i) => updateBtn(i, c.cost, game.clicks[i], 1.5, 'c'));
            unitData.forEach((u, i) => updateBtn(i, u.cost, game.units[i], 1.15, 'u'));
            upgradeData.forEach((u, i) => updateBtn(i, u.cost, game.upgrades[i], 1.8, 'up'));
        }

        function applyRankTheme(r) {
            const data = rankNames[r];
            document.getElementById('rank-name').innerText = data.name;
            const root = document.documentElement;
            root.style.setProperty('--theme-color', data.color);
            root.style.setProperty('--theme-glow', data.color + "80");
            
            const speed = 60 / (r + 1);
            document.getElementById('layer1').style.animationDuration = speed + "s";
            document.getElementById('layer2').style.animationDuration = (speed * 0.7) + "s";
        }

        function triggerLiberation() {
            const overlay = document.getElementById('liberation-overlay');
            const pending = Math.floor(Math.sqrt(game.totalVirtue / 1000000000000));
            document.getElementById('total-virtue-end').innerText = formatVirtue(game.totalVirtue);
            document.getElementById('pending-karma').innerText = formatVirtue(pending);
            overlay.style.display = 'flex';
        }

        function doPrestige() {
            const earned = Math.floor(Math.sqrt(game.totalVirtue / 1000000000000));
            game.karma += earned;
            game.virtue = 0; game.totalVirtue = 0; game.rank = 0;
            game.clicks.fill(0); game.units.fill(0); game.upgrades.fill(0);
            
            document.getElementById('liberation-overlay').style.display = 'none';
            applyRankTheme(0);
            saveGame(); // 転生直後にセーブ
            updateDisplay();
        }

        let lastTime = Date.now();
        function gameLoop() {
            const now = Date.now();
            const dt = (now - lastTime) / 1000;
            lastTime = now;
            if (game.rank < 9) {
                const ips = calculateIPS();
                if (ips > 0) addVirtue(ips * dt);
                updateDisplay();
            }
            requestAnimationFrame(gameLoop);
        }

        init();
    </script>
</body>
</html>
