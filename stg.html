<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>弾幕・夢幻 - Wafu Hardcore</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@700&display=swap');
        
        body { 
            background: #1a0b1a; 
            margin: 0; 
            overflow: hidden; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            color: #fff;
            font-family: 'Shippori Mincho', 'Yu Mincho', serif;
        }
        #gameContainer {
            position: relative;
            box-shadow: 0 0 50px rgba(255, 50, 100, 0.3);
            border: 4px double #844;
        }
        canvas { background: #000; }
        
        /* UIレイヤー */
        .hud { 
            position: absolute; 
            top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none;
        }
        .score-box {
            position: absolute; top: 10px; right: 10px;
            text-align: right; font-size: 20px; color: #ffd;
            text-shadow: 2px 2px 0 #500;
        }
        .life-box {
            position: absolute; bottom: 10px; left: 10px;
            font-size: 20px; color: #faa;
            text-shadow: 1px 1px 0 #500;
        }
        .stage-title {
            position: absolute; top: 30%; width: 100%;
            text-align: center; font-size: 60px; color: #fff;
            text-shadow: 0 0 20px #f00;
            opacity: 0; transition: opacity 1s;
            writing-mode: vertical-rl;
            text-orientation: upright;
            left: 50%; transform: translateX(-50%);
            height: 300px;
        }
        .boss-hp-bar {
            position: absolute; top: 10px; left: 10px;
            width: 300px; height: 8px;
            background: #300; border: 1px solid #844;
            display: none;
        }
        .hp-fill {
            width: 100%; height: 100%;
            background: linear-gradient(90deg, #f00, #ff0);
        }
    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="canvas" width="480" height="640"></canvas>
    <div class="hud">
        <div class="boss-hp-bar" id="bossContainer"><div class="hp-fill" id="bossBar"></div></div>
        <div class="score-box" id="scoreText">点数: 0</div>
        <div class="life-box" id="lifeText">残機: 霊霊霊</div>
        <div class="stage-title" id="stageMsg">第一幕</div>
    </div>
</div>

<script>
/**
 * 和風弾幕エンジン設定
 */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const uiScore = document.getElementById('scoreText');
const uiLife = document.getElementById('lifeText');
const stageMsg = document.getElementById('stageMsg');
const bossContainer = document.getElementById('bossContainer');
const bossBar = document.getElementById('bossBar');

// ゲーム定数
const W = canvas.width;
const H = canvas.height;
const COLORS = {
    bg: "#120512",
    player: "#fff",
    p_core: "#f00",
    bullet_a: "#f55", // 赤札
    bullet_b: "#aaf", // 青札
    bullet_c: "#fff", // 白針
    gold: "#fd0"
};

// ゲーム状態
let state = "TITLE"; 
let frame = 0;
let score = 0;
let stage = 1;
let stageTimer = 0;

// エンティティ
let player = { x: W/2, y: H-100, r: 3, speed: 5, lives: 3, bombs: 2, power: 1, invincible: 0, slow: false };
let keys = {};
let bullets = [];
let enemies = [];
let enemyBullets = [];
let particles = [];
let boss = { active: false, x: W/2, y: -100, hp: 1000, maxHp: 1000, type: 0, timer: 0 };

// 桜吹雪用
let sakuras = Array(100).fill().map(() => ({
    x: Math.random()*W, y: Math.random()*H, 
    s: Math.random()*2+1, 
    vx: Math.random()*1-0.5, vy: Math.random()*2+1,
    angle: Math.random()*Math.PI
}));

/* --- 入力制御 --- */
window.addEventListener('keydown', e => {
    keys[e.code] = true;
    if(e.code === "ShiftLeft") player.slow = true;
    if(e.code === "KeyZ") useBomb();
    if(e.code === "Space") {
        if(state !== "PLAYING") initGame();
    }
});
window.addEventListener('keyup', e => {
    keys[e.code] = false;
    if(e.code === "ShiftLeft") player.slow = false;
});

/* --- メインループ --- */
function loop() {
    ctx.fillStyle = COLORS.bg;
    ctx.fillRect(0, 0, W, H);
    
    // 背景（桜）
    updateSakura();

    if(state === "PLAYING") {
        updateGame();
        drawGame();
    } else {
        drawGame(); // 背景として残す
        drawOverlay();
    }
    frame++;
    requestAnimationFrame(loop);
}

function initGame() {
    player = { x: W/2, y: H-100, r: 3, speed: 5, lives: 3, bombs: 3, power: 1, invincible: 0, slow: false };
    score = 0; stage = 1; stageTimer = 0;
    bullets = []; enemies = []; enemyBullets = []; particles = [];
    boss.active = false; bossContainer.style.display = 'none';
    state = "PLAYING";
    showStageTitle("第一幕 桜花乱舞");
}

/* --- ロジック更新 --- */
function updateGame() {
    stageTimer++;

    // 自機移動
    let spd = player.slow ? 2 : 5;
    if(keys['ArrowLeft'] && player.x > 10) player.x -= spd;
    if(keys['ArrowRight'] && player.x < W-10) player.x += spd;
    if(keys['ArrowUp'] && player.y > 10) player.y -= spd;
    if(keys['ArrowDown'] && player.y < H-10) player.y += spd;
    if(player.invincible > 0) player.invincible--;

    // ショット
    if(keys['KeyX'] && frame % 4 === 0) {
        // お札ショット
        bullets.push({x: player.x-8, y: player.y, vx: 0, vy: -15});
        bullets.push({x: player.x+8, y: player.y, vx: 0, vy: -15});
        if(player.power > 1 || player.slow) {
            // 誘導札（簡易）
            bullets.push({x: player.x, y: player.y, vx: (Math.random()-0.5)*2, vy: -12, homing: true});
        }
    }

    // ステージ進行
    manageStages();

    // 更新処理
    updateEntities();
    checkCollision();
}

/* --- 5段階のステージ構成 --- */
function manageStages() {
    if(boss.active) {
        updateBoss();
        return;
    }

    // 難易度係数
    let rank = 1 + (stage * 0.2); 

    // ステージごとの出現パターン
    if(stage === 1) { // 雑魚ラッシュ
        if(stageTimer > 60 && stageTimer % 40 === 0 && stageTimer < 1500) {
            spawnEnemy(Math.random()*W, -20, 'fairy', rank);
        }
        if(stageTimer > 1600) nextStage("第二幕 疾風怒濤");
    }
    else if(stage === 2) { // 高速突撃
        if(stageTimer % 30 === 0 && stageTimer < 1500) {
            spawnEnemy(Math.random()*W, -20, 'rusher', rank);
        }
        if(stageTimer > 1600) nextStage("第三幕 幾何学ノ舞");
    }
    else if(stage === 3) { // 幾何学弾幕
        if(stageTimer % 60 === 0 && stageTimer < 1500) {
            spawnEnemy(W/2, -20, 'spinner', rank);
        }
        if(stageTimer > 1600) nextStage("第四幕 百鬼夜行");
    }
    else if(stage === 4) { // 混合（地獄）
        if(stageTimer % 20 === 0 && stageTimer < 2000) {
            let type = Math.random() < 0.5 ? 'fairy' : 'rusher';
            spawnEnemy(Math.random()*W, -20, type, rank + 0.5);
        }
        if(stageTimer > 2200) nextStage("最終幕 夢幻泡影");
    }
    else if(stage === 5) { // ボス戦
        if(stageTimer === 100) {
            boss.active = true;
            boss.hp = 3000; boss.maxHp = 3000;
            boss.y = -50;
            bossContainer.style.display = "block";
            // 雑魚消去
            enemies.forEach(e => explode(e.x, e.y));
            enemies = [];
        }
    }
}

function nextStage(title) {
    stage++;
    stageTimer = 0;
    showStageTitle(title);
    // 弾消しボーナス
    enemyBullets = [];
}

/* --- エンティティ生成 --- */
function spawnEnemy(x, y, type, rank) {
    enemies.push({ x, y, type, hp: type==='rusher'?2:5, rank, time: 0 });
}

function updateEntities() {
    // 自機弾
    bullets.forEach((b, i) => {
        b.x += b.vx; b.y += b.vy;
        if(b.homing && enemies.length > 0) {
            let target = enemies[0];
            let angle = Math.atan2(target.y - b.y, target.x - b.x);
            b.vx += Math.cos(angle)*0.5;
            b.vy += Math.sin(angle)*0.5;
        }
        if(b.y < -20) bullets.splice(i, 1);
    });

    // 敵
    enemies.forEach((e, i) => {
        e.time++;
        e.y += 2; // 基本移動
        
        // 動きと攻撃
        if(e.type === 'fairy') { // 左右に揺れながら狙い弾
            e.x += Math.sin(e.time * 0.05) * 2;
            if(e.time % 60 === 0) fireAimed(e, 4 * e.rank, COLORS.bullet_a);
        }
        else if(e.type === 'rusher') { // 突っ込んでくる
            if(e.time === 40) {
                let a = Math.atan2(player.y - e.y, player.x - e.x);
                e.vx = Math.cos(a) * (5 * e.rank);
                e.vy = Math.sin(a) * (5 * e.rank);
            }
            if(e.time > 40) { e.x += e.vx; e.y += e.vy; }
        }
        else if(e.type === 'spinner') { // 回転しながらばら撒き
            e.y = 100 + Math.sin(e.time*0.02)*50; // 上部に留まる
            if(e.time % 20 === 0) fireNWay(e, 5 + Math.floor(e.rank), 3, COLORS.bullet_b, e.time*0.1);
        }

        if(e.y > H+20 || e.x < -20 || e.x > W+20) enemies.splice(i, 1);
    });

    // 敵弾
    enemyBullets.forEach((b, i) => {
        b.x += b.vx; b.y += b.vy;
        // 札っぽい回転演出
        b.angle = Math.atan2(b.vy, b.vx);
        if(b.x < -20 || b.x > W+20 || b.y < -20 || b.y > H+20) enemyBullets.splice(i, 1);
    });

    // パーティクル
    particles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy; p.life--;
        if(p.life <= 0) particles.splice(i, 1);
    });
}

/* --- ボス (最終幕) --- */
function updateBoss() {
    if(boss.y < 120) boss.y++;
    boss.timer++;
    boss.x = W/2 + Math.sin(boss.timer * 0.02) * 150;

    // HP更新
    bossBar.style.width = (boss.hp / boss.maxHp * 100) + "%";

    // 弾幕パターン (HPによって激化)
    let fury = boss.hp < boss.maxHp/2;
    
    // 1. 螺旋の舞
    if(boss.timer % (fury ? 4 : 8) === 0) {
        let a = boss.timer * 0.1;
        enemyBullets.push({ x: boss.x, y: boss.y, vx: Math.cos(a)*4, vy: Math.sin(a)*4, color: COLORS.bullet_a, type: 'fuda' });
        enemyBullets.push({ x: boss.x, y: boss.y, vx: Math.cos(a+Math.PI)*4, vy: Math.sin(a+Math.PI)*4, color: COLORS.bullet_a, type: 'fuda' });
    }

    // 2. 追尾針 (Fury時)
    if(fury && boss.timer % 30 === 0) {
        fireAimed(boss, 6, COLORS.bullet_c, 'needle');
    }

    // 3. 全方位破裂
    if(boss.timer % 120 === 0) {
        fireNWay(boss, 24, 3, COLORS.gold, 0, 'orb');
    }
}

/* --- 弾発射関数 --- */
function fireAimed(origin, speed, color, shape='orb') {
    let a = Math.atan2(player.y - origin.y, player.x - origin.x);
    enemyBullets.push({ x: origin.x, y: origin.y, vx: Math.cos(a)*speed, vy: Math.sin(a)*speed, color, type: shape });
}
function fireNWay(origin, count, speed, color, offset=0, shape='orb') {
    for(let i=0; i<count; i++) {
        let a = offset + (Math.PI*2/count)*i;
        enemyBullets.push({ x: origin.x, y: origin.y, vx: Math.cos(a)*speed, vy: Math.sin(a)*speed, color, type: shape });
    }
}

/* --- 衝突 & ボム --- */
function useBomb() {
    if(player.bombs > 0 && state === "PLAYING") {
        player.bombs--;
        enemyBullets = [];
        enemies.forEach(e => { explode(e.x, e.y); e.hp = 0; score+=500; });
        enemies = [];
        if(boss.active) { boss.hp -= 300; explode(boss.x, boss.y, "#fff", 50); }
        
        // 霊撃演出
        ctx.fillStyle = "white"; ctx.fillRect(0,0,W,H);
        ctx.fillStyle = "black"; ctx.font = "bold 80px 'Shippori Mincho'"; ctx.fillText("霊 撃", W/2-80, H/2);
    }
}

function checkCollision() {
    // 自機弾 vs 敵
    bullets.forEach((b, bi) => {
        enemies.forEach((e, ei) => {
            if(dist(b, e) < 20) {
                e.hp--; bullets.splice(bi, 1);
                explode(b.x, b.y, "#fff", 1);
                if(e.hp <= 0) {
                    enemies.splice(ei, 1); score += 100 * stage;
                    explode(e.x, e.y, COLORS.gold);
                }
            }
        });
        if(boss.active && dist(b, boss) < 50) {
            boss.hp--; bullets.splice(bi, 1);
            if(boss.hp <= 0) {
                state = "CLEAR";
                explode(boss.x, boss.y, COLORS.gold, 100);
            }
        }
    });

    // 敵 vs 自機
    if(player.invincible <= 0) {
        let hit = false;
        enemies.forEach(e => { if(dist(e, player) < 10) hit = true; });
        enemyBullets.forEach(b => { 
            let d = dist(b, player);
            // グレイズ（かすり）判定エリアも作れるが今回は省略
            if(d < (player.slow ? 2 : 4) + 4) hit = true; 
        });
        if(boss.active && dist(boss, player) < 40) hit = true;

        if(hit) {
            player.lives--;
            player.bombs = 3; // 復活時ボム補充
            player.invincible = 120;
            enemyBullets = []; // 弾消
