<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>STG ver 0.3</title>
    <style>
        body { background: #050505; color: white; display: flex; flex-direction: column; align-items: center; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        canvas { background: #000; border: 2px solid #666; box-shadow: 0 0 30px rgba(0, 150, 255, 0.3); }
        .ui-panel { margin-top: 10px; text-align: center; color: #ccc; font-size: 0.9rem; }
        .key { display: inline-block; padding: 2px 6px; border: 1px solid #777; border-radius: 4px; background: #222; margin: 0 2px; }
        .bar-container { width: 480px; height: 10px; background: #333; margin-top: 5px; display: none; }
        .hp-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #f00, #ff0); transition: width 0.1s; }
    </style>
</head>
<body>
    <h2>Gemini Wing: Final Mission</h2>
    <div id="bossContainer" class="bar-container"><div id="bossBar" class="hp-bar"></div></div>
    <canvas id="gameCanvas" width="480" height="640"></canvas>
    
    <div class="ui-panel">
        <span class="key">←↑↓→</span>移動 | <span class="key">X</span>ショット | <span class="key">Z</span>ボム (緊急回避)<br>
        <span class="key">Space</span> スタート / リトライ
    </div>

<script>
/**
 * ゲーム設定とグローバル変数
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const bossContainer = document.getElementById('bossContainer');
const bossBar = document.getElementById('bossBar');

// ゲーム状態
let gameState = "TITLE"; // TITLE, PLAYING, BOSSFIGHT, GAMEOVER, CLEAR
let frame = 0;
let score = 0;

// 自機データ
let player = {
    x: 240, y: 550, size: 4, speed: 5,
    lives: 3,
    bombs: 2,
    invincible: 0, // 無敵フレーム
    power: 1 // パワーレベル (1~3)
};

// オブジェクト管理
let keys = {};
let bullets = [];
let enemyBullets = [];
let enemies = [];
let particles = [];
let flashScreen = 0; // ボム時のフラッシュ演出用

// ボスデータ
let boss = {
    active: false,
    x: 240, y: -100,
    hp: 500, maxHp: 500,
    phase: 0,
    angle: 0
};

// 入力イベント
window.addEventListener('keydown', e => {
    keys[e.code] = true;
    if (keys['Space']) handleGlobalInput();
    if (keys['KeyZ']) useBomb();
});
window.addEventListener('keyup', e => keys[e.code] = false);

/**
 * メインループ
 */
function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    frame++;

    // 背景の演出（星）
    drawStars();

    if (gameState === "TITLE") {
        drawTitle();
    } else if (gameState === "PLAYING" || gameState === "BOSSFIGHT") {
        updateGame();
        drawGame();
    } else if (gameState === "GAMEOVER") {
        drawGame(); // 背景としてゲーム画面を残す
        drawGameOver();
    } else if (gameState === "CLEAR") {
        drawGame();
        drawClear();
    }

    requestAnimationFrame(gameLoop);
}

function handleGlobalInput() {
    if (gameState === "TITLE" || gameState === "GAMEOVER" || gameState === "CLEAR") {
        resetGame();
        gameState = "PLAYING";
    }
}

function resetGame() {
    player.x = 240; player.y = 550;
    player.lives = 3;
    player.bombs = 3;
    player.power = 1;
    player.invincible = 0;
    
    score = 0;
    frame = 0;
    bullets = [];
    enemyBullets = [];
    enemies = [];
    particles = [];
    
    boss.active = false;
    boss.hp = boss.maxHp;
    boss.y = -100;
    
    bossContainer.style.display = "none";
}

/**
 * ゲームロジック更新
 */
function updateGame() {
    // 1. 自機処理
    if (player.invincible > 0) player.invincible--;
    
    // 移動
    if (keys['ArrowLeft'] && player.x > 10) player.x -= player.speed;
    if (keys['ArrowRight'] && player.x < canvas.width - 10) player.x += player.speed;
    if (keys['ArrowUp'] && player.y > 10) player.y -= player.speed;
    if (keys['ArrowDown'] && player.y < canvas.height - 10) player.y += player.speed;

    // パワーアップ判定 (スコア依存)
    if (score < 2000) player.power = 1;
    else if (score < 5000) player.power = 2;
    else player.power = 3;

    // ショット (Xキー)
    if (keys['KeyX'] && frame % 5 === 0) {
        spawnPlayerBullets();
    }

    // 2. 敵の出現管理
    if (!boss.active) {
        // ボス出現条件: スコア10000点
        if (score >= 10000) {
            gameState = "BOSSFIGHT";
            boss.active = true;
            enemies.forEach(e => createExplosion(e.x, e.y)); // 雑魚一掃
            enemies = [];
            bossContainer.style.display = "block";
        } else {
            // 通常敵スポーン
            if (frame % 40 === 0) spawnEnemy();
        }
    } else {
        updateBoss();
    }

    // 3. オブジェクト更新
    updateEntities();
    
    // 4. 当たり判定
    checkCollisions();
}

/**
 * 自機の弾幕パターン (パワーアップ対応)
 */
function spawnPlayerBullets() {
    if (player.power === 1) {
        bullets.push({ x: player.x - 5, y: player.y, vx: 0, vy: -12 });
        bullets.push({ x: player.x + 5, y: player.y, vx: 0, vy: -12 });
    } else if (player.power === 2) {
        bullets.push({ x: player.x - 8, y: player.y, vx: 0, vy: -12 });
        bullets.push({ x: player.x + 8, y: player.y, vx: 0, vy: -12 });
        bullets.push({ x: player.x - 12, y: player.y, vx: -1, vy: -10 });
        bullets.push({ x: player.x + 12, y: player.y, vx: 1, vy: -10 });
    } else if (player.power === 3) {
        // ワイドショット
        bullets.push({ x: player.x, y: player.y, vx: 0, vy: -12 });
        bullets.push({ x: player.x, y: player.y, vx: -2, vy: -11 });
        bullets.push({ x: player.x, y: player.y, vx: 2, vy: -11 });
        bullets.push({ x: player.x, y: player.y, vx: -4, vy: -10 });
        bullets.push({ x: player.x, y: player.y, vx: 4, vy: -10 });
    }
}

/**
 * ボム処理 (Zキー)
 */
function useBomb() {
    if ((gameState !== "PLAYING" && gameState !== "BOSSFIGHT") || player.bombs <= 0) return;
    
    player.bombs--;
    flashScreen = 20; // 画面フラッシュ時間
    
    // 敵弾全消去
    enemyBullets = [];
    
    // 雑魚敵全滅
    enemies.forEach(e => {
        score += 100;
        createExplosion(e.x, e.y);
    });
    enemies = [];
    
    // ボスにダメージ
    if (boss.active) {
        boss.hp -= 50;
        createExplosion(boss.x, boss.y, "cyan");
    }
}

/**
 * 敵と弾の更新
 */
function updateEntities() {
    // 自機弾
    bullets.forEach((b, i) => {
        b.x += b.vx; b.y += b.vy;
        if (b.y < -20) bullets.splice(i, 1);
    });

    // 雑魚敵
    enemies.forEach((e, i) => {
        e.y += e.speed;
        e.x += Math.sin(frame * 0.05 + e.offset) * 2; // 蛇行
        
        // 弾幕
        if (frame % 60 === 0 && e.y > 0 && e.y < canvas.height) {
            let angle = Math.atan2(player.y - e.y, player.x - e.x);
            enemyBullets.push({ x: e.x, y: e.y, vx: Math.cos(angle)*3, vy: Math.sin(angle)*3 });
        }
        
        if (e.y > canvas.height + 20) enemies.splice(i, 1);
    });

    // 敵弾
    enemyBullets.forEach((eb, i) => {
        eb.x += eb.vx; eb.y += eb.vy;
        if (eb.x < -20 || eb.x > canvas.width+20 || eb.y > canvas.height+20) enemyBullets.splice(i, 1);
    });
    
    // パーティクル（爆発）
    particles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy;
        p.life--;
        if (p.life <= 0) particles.splice(i, 1);
    });
}

/**
 * ボスロジック
 */
function updateBoss() {
    // 登場演出
    if (boss.y < 100) {
        boss.y += 2;
        return;
    }

    // 移動: 8の字ループ
    boss.angle += 0.02;
    boss.x = 240 + Math.sin(boss.angle) * 150;
    
    // ボス弾幕
    if (frame % 15 === 0) {
        // 渦巻き弾
        let theta = (frame * 0.1);
        for(let i=0; i<3; i++) {
            let a = theta + (Math.PI * 2 / 3) * i;
            enemyBullets.push({
                x: boss.x, y: boss.y,
                vx: Math.cos(a) * 3, vy: Math.sin(a) * 3,
                color: '#f0f'
            });
        }
    }
    if (frame % 60 === 0) {
        // 自機狙い高速弾
        let angle = Math.atan2(player.y - boss.y, player.x - boss.x);
        enemyBullets.push({ x: boss.x, y: boss.y, vx: Math.cos(angle)*6, vy: Math.sin(angle)*6, color: 'red' });
    }
}

/**
 * 衝突判定
 */
function checkCollisions() {
    // 自機弾 vs 敵
    bullets.forEach((b, bi) => {
        // 対雑魚
        enemies.forEach((e, ei) => {
            if (dist(b.x, b.y, e.x, e.y) < 20) {
                e.hp--;
                bullets.splice(bi, 1);
                if (e.hp <= 0) {
                    enemies.splice(ei, 1);
                    score += 200;
                    createExplosion(e.x, e.y);
                }
            }
        });
        
        // 対ボス
        if (boss.active && dist(b.x, b.y, boss.x, boss.y) < 40) {
            boss.hp--;
            bullets.splice(bi, 1);
            if (boss.hp <= 0) {
                gameState = "CLEAR";
                createExplosion(boss.x, boss.y, "gold", 50);
            }
        }
    });

    // 敵弾 vs プレイヤー
    if (player.invincible <= 0) {
        enemyBullets.forEach(eb => {
            if (dist(eb.x, eb.y, player.x, player.y) < 6) {
                hitPlayer();
            }
        });
        
        enemies.forEach(e => {
            if (dist(e.x, e.y, player.x, player.y) < 15) hitPlayer();
        });

        if (boss.active && dist(boss.x, boss.y, player.x, player.y) < 40) hitPlayer();
    }
}

function hitPlayer() {
    player.lives--;
    createExplosion(player.x, player.y, "lime");
    player.invincible = 120; // 2秒無敵
    
    // ボム補充（救済措置）
    if (player.bombs < 2) player.bombs = 2;

    if (player.lives < 0) {
        gameState = "GAMEOVER";
    } else {
        // 画面中央下に戻す
        player.x = 240;
        player.y = 550;
        // 敵弾を消してあげる
        enemyBullets = [];
    }
}

function spawnEnemy() {
    enemies.push({
        x: Math.random() * (canvas.width - 40) + 20,
        y: -20,
        hp: 3,
        speed: 2 + Math.random(),
        offset: Math.random() * 100
    });
}

// ユーティリティ
function dist(x1, y1, x2, y2) { return Math.hypot(x1-x2, y1-y2); }

function createExplosion(x, y, color="orange", count=10) {
    for(let i=0; i<count; i++) {
        particles.push({
            x: x, y: y,
            vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
            life: 20 + Math.random()*20,
            color: color
        });
    }
}

// 星空背景
let stars = Array(50).fill().map(() => ({
    x: Math.random()*canvas.width, y: Math.random()*canvas.height, speed: 0.5 + Math.random()*2
}));
function drawStars() {
    ctx.fillStyle = "#000";
    if (flashScreen > 0) {
        ctx.fillStyle = `rgba(255, 255, 255, ${flashScreen/20})`;
        flashScreen--;
    }
    
    stars.forEach(s => {
        s.y += s.speed;
        if(s.y > canvas.height) s.y = 0;
        ctx.fillStyle = `rgba(255,255,255,${Math.random()})`;
        ctx.fillRect(s.x, s.y, 2, 2);
    });
}

/**
 * 描画処理
 */
function drawGame() {
    // プレイヤー（無敵時は点滅）
    if (frame % 10 < 5 || player.invincible <= 0) {
        ctx.fillStyle = '#0cf';
        ctx.beginPath();
        ctx.moveTo(player.x, player.y - 12);
        ctx.lineTo(player.x - 10, player.y + 10);
        ctx.lineTo(player.x + 10, player.y + 10);
        ctx.fill();
        // 当たり判定
        ctx.fillStyle = 'red';
        ctx.beginPath(); ctx.arc(player.x, player.y, 3, 0, Math.PI*2); ctx.fill();
    }

    // 雑魚敵
    enemies.forEach(e => {
        ctx.fillStyle = '#f55';
        ctx.fillRect(e.x - 12, e.y - 12, 24, 24);
    });

    // ボス
    if (boss.active) {
        ctx.fillStyle = '#90f';
        ctx.save();
        ctx.translate(boss.x, boss.y);
        ctx.rotate(frame * 0.05);
        ctx.fillRect(-30, -30, 60, 60);
        ctx.restore();
        
        // HPバー更新
        bossBar.style.width = (boss.hp / boss.maxHp * 100) + "%";
    }

    // 弾
    ctx.fillStyle = '#ff0';
    bullets.forEach(b => ctx.fillRect(b.x-3, b.y-8, 6, 16));
    
    enemyBullets.forEach(eb => {
        ctx.fillStyle = eb.color || '#f0f';
        ctx.beginPath(); ctx.arc(eb.x, eb.y, 5, 0, Math.PI*2); ctx.fill();
    });
    
    // パーティクル
    particles.forEach(p => {
        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.life / 30;
        ctx.fillRect(p.x, p.y, 4, 4);
        ctx.globalAlpha = 1;
    });

    // UI
    ctx.fillStyle = "white";
    ctx.font = "20px Consolas";
    ctx.textAlign = "left";
    ctx.fillText(`SCORE: ${score}`, 10, 30);
    ctx.fillText(`LIVES: ${"❤".repeat(Math.max(0, player.lives))}`, 10, 55);
    ctx.fillText(`BOMB : ${"★".repeat(player.bombs)}`, 10, 80);
}

function drawTitle() {
    ctx.fillStyle = "white";
    ctx.textAlign = "center";
    ctx.font = "40px sans-serif";
    ctx.fillText("GEMINI WING", canvas.width/2, 200);
    ctx.font = "20px sans-serif";
    ctx.fillText("FINAL MISSION", canvas.width/2, 240);
    if ((frame / 30) % 2 < 1) ctx.fillText("PRESS SPACE", canvas.width/2, 400);
}

function drawGameOver() {
    ctx.fillStyle = "rgba(0,0,0,0.7)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "red";
    ctx.textAlign = "center";
    ctx.font = "50px sans-serif";
    ctx.fillText("GAME OVER", canvas.width/2, 250);
    ctx.fillStyle = "white";
    ctx.font = "25px sans-serif";
    ctx.fillText("SCORE: " + score, canvas.width/2, 320);
    ctx.fillText("Press SPACE to Retry", canvas.width/2, 400);
}

function drawClear() {
    ctx.fillStyle = "rgba(255,255,255,0.8)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "blue";
    ctx.textAlign = "center";
    ctx.font = "50px sans-serif";
    ctx.fillText("MISSION CLEAR!", canvas.width/2, 250);
    ctx.fillStyle = "black";
    ctx.font = "25px sans-serif";
    ctx.fillText("SCORE: " + score, canvas.width/2, 320);
    ctx.fillText("Press SPACE to Title", canvas.width/2, 400);
}

gameLoop();
</script>
</body>
</html>
