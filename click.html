<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‹ãƒ«ãƒ´ã‚¡ãƒ¼ãƒŠãƒ»ã‚¯ãƒªãƒƒã‚«ãƒ¼</title>
    <style>
        :root {
            --bg-dark: #121212;
            --text-main: #fff;
            --accent-gold: #ffcc00;
            --price-green: #66ff66;
            --price-red: #ff6666;
            --btn-grad: linear-gradient(to bottom, #555, #333);
            --btn-grad-hover: linear-gradient(to bottom, #666, #444);
            --mappo-color: #00ff00;
            --mappo-bg: rgba(0, 20, 0, 0.9);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Hiragino Mincho ProN', 'Yu Mincho', serif;
            background-color: #000;
            color: var(--text-main);
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            display: grid; 
            grid-template-columns: 30% 1fr 318px;
            user-select: none;
        }

        /* =========================================
           Background Canvas (Visual Effects)
           ========================================= */
        #bg-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none;
        }

        /* =========================================
           Left Column (Faith)
           ========================================= */
        #left-col {
            background: rgba(17, 17, 17, 0.85); /* é€éã•ã›ã‚‹ */
            display: flex; flex-direction: column; align-items: center;
            border-right: 1px solid #333;
            box-shadow: inset -10px 0 20px rgba(0,0,0,0.5);
            position: relative; z-index: 10;
            backdrop-filter: blur(2px);
        }

        #bakery-name-container {
            margin-top: 20px; background: rgba(0,0,0,0.4); padding: 5px 15px; border-radius: 15px; cursor: pointer; border: 1px solid #444;
        }
        #bakery-name-container:hover { background: rgba(255,255,255,0.1); border-color: var(--accent-gold); }
        #bakery-name { font-size: 16px; font-weight: bold; color: #ddd; }

        #toku-container { margin-top: 40px; text-align: center; width: 100%; background: rgba(0,0,0,0.2); padding: 10px 0; }
        #toku-amount { font-size: 32px; font-weight: bold; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        #tps-display { font-size: 14px; color: #888; margin-top: 5px; }
        
        /* ãƒãƒ•è¡¨ç¤º */
        #buff-display { 
            margin-top: 5px; font-size: 12px; color: var(--accent-gold); height: 20px; 
            text-shadow: 0 0 5px var(--accent-gold);
        }

        #mokugyo-wrapper {
            margin-top: 40px; width: 250px; height: 250px; cursor: pointer; position: relative; transition: transform 0.1s;
        }
        #mokugyo-wrapper:active { transform: scale(0.95); }
        #mokugyo-img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 0 15px rgba(0,0,0,0.8)); transition: filter 0.5s; }
        
        /* æœ«æ³•ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        body.mappo-mode #mokugyo-img { 
            filter: sepia(100%) saturate(500%) hue-rotate(-50deg) drop-shadow(0 0 20px red); 
        }
        body.mappo-mode #left-col { background: rgba(0, 10, 0, 0.8); border-right: 1px solid #0f0; }
        body.mappo-mode #toku-amount { color: #0f0; text-shadow: 0 0 10px #0f0; }

        /* =========================================
           Middle Column (Main)
           ========================================= */
        #mid-col {
            background: rgba(34, 34, 34, 0.7); /* é€é */
            position: relative; z-index: 5;
            display: flex; flex-direction: column;
            border-left: 2px solid #000; border-right: 2px solid #000;
            transition: background 0.5s;
        }
        body.mappo-mode #mid-col { background: rgba(0, 0, 0, 0.6); border-color: #0f0; }

        #mid-menu {
            height: 40px; background: rgba(0,0,0,0.9);
            display: flex; justify-content: center; align-items: center; gap: 10px;
            border-bottom: 2px solid #444; z-index: 100; flex-shrink: 0;
        }
        .menu-link {
            color: #888; font-weight: bold; cursor: pointer; font-size: 14px; padding: 5px 10px;
        }
        .menu-link:hover { color: #fff; text-shadow: 0 0 5px var(--accent-gold); }
        .menu-link.active { color: var(--accent-gold); border-bottom: 2px solid var(--accent-gold); }

        #mid-content {
            flex-grow: 1; position: relative; overflow-y: auto; overflow-x: hidden;
            scrollbar-width: thin; scrollbar-color: #555 #222;
        }

        /* Visuals */
        #news-ticker {
            background: rgba(0,0,0,0.8); color: #ccc; padding: 4px 8px; font-size: 12px;
            border-bottom: 1px solid #444; white-space: nowrap; overflow: hidden;
            position: sticky; top: 0; z-index: 20;
        }
        .visual-row {
            height: 64px; border-bottom: 1px solid rgba(255,255,255,0.1);
            display: none; position: relative;
        }
        /* å„èƒŒæ™¯ã¯JSã§ã‚¯ãƒ©ã‚¹ä»˜ä¸ã›ãšã€CSSå¤‰æ•°ç­‰ã§åˆ¶å¾¡ã‚‚å¯èƒ½ã ãŒä»Šå›ã¯æ—¢å­˜è¸è¥² */
        .row-bg-0 { background: linear-gradient(to right, rgba(74, 59, 42, 0.8), rgba(42, 31, 21, 0.8)); }
        .row-bg-1 { background: linear-gradient(to right, rgba(44, 62, 80, 0.8), rgba(26, 37, 47, 0.8)); }
        .row-bg-2 { background: linear-gradient(to right, rgba(142, 68, 173, 0.8), rgba(91, 44, 111, 0.8)); }
        /* ä»¥ä¸‹ç•¥ã€é€æ˜åº¦ã‚’è¿½åŠ  */
        
        .visual-icon {
            font-size: 32px; width: 40px; text-align: center; display: inline-block;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));
            animation: bounceIn 0.5s; cursor: pointer; transition: transform 0.1s;
        }
        .visual-icon:hover { transform: scale(1.2); }
        .row-icons { height: 100%; display: flex; align-items: center; padding: 0 10px; }

        /* Stats & Settings Panels */
        .text-panel { padding: 20px 40px; color: #ccc; background: rgba(0,0,0,0.8); min-height: 100%; }
        .panel-header { color: var(--accent-gold); font-size: 24px; text-align: center; border-bottom: 1px solid #555; padding-bottom: 10px; margin-bottom: 20px; }
        .sub-header { color: #d4af37; font-size: 16px; border-bottom: 1px solid #444; margin-bottom: 10px; }
        .btn-style {
            background: var(--btn-grad); border: 1px solid #111; color: #ddd; padding: 6px 12px;
            cursor: pointer; margin: 4px; font-size: 12px; border-radius: 2px; transition: 0.2s;
        }
        .btn-style:hover { background: var(--btn-grad-hover); color: #fff; }
        .btn-danger { background: linear-gradient(to bottom, #a00, #600); }
        .stat-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dotted #333; font-size: 13px; }
        .stat-val { font-weight: bold; color: #fff; }
        .hidden { display: none !important; }

        /* =========================================
           Right Column (Store)
           ========================================= */
        #right-col {
            background: #1a1a1a; display: flex; flex-direction: column; border-left: 4px solid #000; z-index: 10;
        }
        #store-header { background: #000; color: var(--accent-gold); text-align: center; padding: 5px; font-weight: bold; border-bottom: 2px solid #444; font-size: 14px; }
        
        /* å¥¥ç¾©ã‚¨ãƒªã‚¢ (Mappo Toggle) */
        #store-special {
            background: #110000; border-bottom: 1px solid #444; display: none; /* åˆæœŸéè¡¨ç¤º */
            padding: 10px; text-align: center;
        }
        #mappo-toggle-btn {
            width: 100%; padding: 8px; background: #000; border: 1px solid #555; color: #888;
            font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: inset 0 0 5px #f00;
        }
        #mappo-toggle-btn.active {
            background: #002200; color: #0f0; border-color: #0f0; box-shadow: 0 0 10px #0f0;
        }

        #upgrades-container { padding: 10px; background: rgba(0,0,0,0.3); border-bottom: 1px solid #444; min-height: 60px; display: flex; flex-wrap: wrap; gap: 4px; }
        .upgrade-btn {
            width: 50px; height: 50px; background: #222; border: 1px solid #555; cursor: pointer;
            display: flex; justify-content: center; align-items: center; font-size: 24px;
        }
        .upgrade-btn:hover { border-color: #fff; box-shadow: 0 0 10px var(--accent-gold); }
        #products-list { flex-grow: 1; overflow-y: auto; }
        .product-btn {
            height: 64px; width: 100%; background: linear-gradient(to bottom, #444, #222);
            border-bottom: 1px solid #111; cursor: pointer; display: grid; grid-template-columns: 64px 1fr 60px;
        }
        .product-btn:hover { background: linear-gradient(to bottom, #555, #333); }
        .product-btn.locked { display: none; }
        .product-btn.disabled { opacity: 0.6; }
        .product-icon { font-size: 36px; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.2); }
        .product-info { display: flex; flex-direction: column; justify-content: center; padding-left: 10px; }
        .product-name { font-weight: bold; font-size: 15px; color: #fff; }
        .product-price { font-size: 12px; color: var(--price-green); font-weight: bold; }
        .product-btn.cannot-afford .product-price { color: var(--price-red); }
        .product-count { display: flex; justify-content: center; align-items: center; font-size: 32px; color: rgba(0,0,0,0.4); font-weight: bold; }

        /* Floating Text & Tooltip */
        .float-text { position: absolute; pointer-events: none; font-weight: bold; color: #fff; text-shadow: 0 0 3px #000; animation: floatUp 1.5s forwards; z-index: 2000; }
        @keyframes floatUp { 0%{transform:translateY(0);opacity:1;} 100%{transform:translateY(-50px);opacity:0;} }
        #tooltip { position: fixed; display: none; z-index: 10000; background: #111; border: 2px solid #888; padding: 8px; min-width: 250px; pointer-events: none; }
        
        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; display: none; justify-content: center; align-items: center; }
        .modal.show { display: flex; }
        .modal-box { background: #222; border: 2px solid var(--accent-gold); padding: 20px; width: 400px; color: #fff; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        textarea { width: 100%; background: #111; color: #aaa; border: 1px solid #444; height: 60px; }

    </style>
</head>
<body>

<canvas id="bg-canvas"></canvas>

<div id="left-col">
    <div id="bakery-name-container" onclick="renameBakery()">
        <div id="bakery-name">åã‚‚ãªãå¯ºé™¢</div>
    </div>
    <div id="toku-container">
        <div id="toku-amount">0 å¾³</div>
        <div id="tps-display">per second: 0</div>
        <div id="buff-display"></div>
    </div>
    <div id="mokugyo-wrapper" onmousedown="clickMokugyo(event)">
        <img id="mokugyo-img" src="mokugyo.png" alt="Mokugyo" draggable="false">
    </div>
</div>

<div id="mid-col">
    <div id="mid-menu">
        <div class="menu-link active" onclick="switchTab('visuals')" id="tab-visuals">æµ„åœŸ</div>
        <div class="menu-link" onclick="switchTab('stats')" id="tab-stats">çµ±è¨ˆ</div>
        <div class="menu-link" onclick="switchTab('settings')" id="tab-settings">è¨­å®š</div>
    </div>

    <div id="mid-content">
        <div id="section-visuals">
            <div id="news-ticker">News: ...</div>
            <div id="visual-rows-container"></div>
        </div>

        <div id="section-stats" class="text-panel hidden">
            <div class="panel-header">çµ±è¨ˆæƒ…å ±</div>
            <div class="sub-header">ä¸€èˆ¬</div>
            <div class="stat-row"><span>ç¾åœ¨ã®å¾³:</span> <span class="stat-val" id="stat-current">0</span></div>
            <div class="stat-row"><span>ç´¯è¨ˆå¾³:</span> <span class="stat-val" id="stat-alltime">0</span></div>
            <div class="stat-row"><span>é–‹å§‹æ—¥æ™‚:</span> <span class="stat-val" id="stat-start">--</span></div>
            <div class="stat-row"><span>ã‚¯ãƒªãƒƒã‚¯å›æ•°:</span> <span class="stat-val" id="stat-clicks">0</span></div>
            <div class="sub-header">ç”Ÿç”£</div>
            <div class="stat-row"><span>æ¯ç§’ç”Ÿç”£ (TpS):</span> <span class="stat-val" id="stat-tps">0</span></div>
            <div class="stat-row"><span>æ¥­ (Karma):</span> <span class="stat-val" id="stat-karma">0</span></div>
            <div class="stat-row"><span>ãƒ¢ãƒ¼ãƒ‰å€ç‡:</span> <span class="stat-val" id="stat-mode-mult">1x</span></div>
            <div class="sub-header">æ–½è¨­</div>
            <div id="stat-buildings-list"></div>
        </div>

        <div id="section-settings" class="text-panel hidden">
            <div class="panel-header">è¨­å®š</div>
            <div class="sub-header">ã‚·ã‚¹ãƒ†ãƒ </div>
            <button class="btn-style" onclick="toggleSound()" id="btn-sound">éŸ³é‡: ON</button>
            <button class="btn-style" onclick="renameBakery()">å¯ºé™¢åå¤‰æ›´</button>
            <button class="btn-style" onclick="openModal('debug-modal')" style="border-color:#66ffff; color:#66ffff;">é˜¿é ¼è€¶è­˜ (Debug)</button>
            
            <div class="sub-header" style="margin-top:20px;">ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿</div>
            <button class="btn-style" onclick="saveGame(true)">æ‰‹å‹•ã‚»ãƒ¼ãƒ–</button>
            <button class="btn-style" onclick="exportSave()">å‘ªæ–‡ã‚’å”±ãˆã‚‹ (Export)</button>
            <button class="btn-style" onclick="importSave()">å‘ªæ–‡ã‚’èã (Import)</button>
            <textarea id="export-area" readonly onclick="this.select()"></textarea>
            <br>
            <button class="btn-style btn-danger" onclick="openModal('prestige-modal')">è¼ªå»»è»¢ç”Ÿ (Prestige)</button>
            <button class="btn-style btn-danger" onclick="wipeSave()">ãƒ‡ãƒ¼ã‚¿æ¶ˆå» (Wipe)</button>
        </div>
    </div>
</div>

<div id="right-col">
    <div id="store-header">ä¼½è— (STORE)</div>
    <div id="store-special">
        <button id="mappo-toggle-btn" onclick="toggleMappo()">
            <span id="mappo-status-icon">âšª</span> 
            <span id="mappo-status-text">æœ«æ³•ãƒ¢ãƒ¼ãƒ‰: OFF</span>
        </button>
    </div>

    <div id="upgrades-container"></div>
    <div id="products-list"></div>
</div>

<div id="tooltip"></div>

<div id="prestige-modal" class="modal">
    <div class="modal-box">
        <h3 style="color:#b22222">è¼ªå»»è»¢ç”Ÿ</h3>
        <p>å¾³ã‚’æ¨ã¦ã€æ¥­(Karma)ã‚’å¾—ã¦ç”Ÿã¾ã‚Œå¤‰ã‚ã‚Šã¾ã™ã€‚<br>Karma 1 = +10% CpS</p>
        <p>ç²å¾—äºˆå®š: <span id="prestige-gain" style="font-weight:bold; font-size:1.2em;">0</span></p>
        <button class="btn-style btn-danger" onclick="doPrestige()">è»¢ç”Ÿã™ã‚‹</button>
        <button class="btn-style" onclick="closeModal('prestige-modal')">ã‚„ã‚ã‚‹</button>
    </div>
</div>

<div id="debug-modal" class="modal">
    <div class="modal-box" style="border-color:#66ffff;">
        <h3 style="color:#66ffff; text-shadow:0 0 5px #66ffff;">é˜¿é ¼è€¶è­˜ã‚·ã‚¹ãƒ†ãƒ </h3>
        <p>é–‹ç™ºè€…ç”¨ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</p>
        <div style="display:flex; flex-wrap:wrap; justify-content:center;">
            <button class="btn-style" onclick="game.toku+=1e15; updateUI()">å¾³ +1000å…†</button>
            <button class="btn-style" onclick="game.mappoUnlocked=true; toggleMappo(true); updateUI()">æœ«æ³•å¼·åˆ¶è§£æ”¾</button>
            <button class="btn-style" onclick="buildings.forEach((b,i)=>game.blds[i]+=10); updateUI()">å…¨æ–½è¨­ +10</button>
        </div>
        <button class="btn-style" onclick="closeModal('debug-modal')" style="margin-top:15px;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<script>
    // ================= DATA =================
    const units = ["", "ä¸‡", "å„„", "å…†", "äº¬", "å“", "ğ¥±", "ç©£", "æº", "æ¾—", "æ­£", "è¼‰", "æ¥µ", "æ’æ²³æ²™", "é˜¿åƒ§ç¥‡", "é‚£ç”±ä»–", "ä¸å¯æ€è­°", "ç„¡é‡å¤§æ•°"];
    const buildings = [
        { name: "å°åŠä¸»",   cost: 15,          base: 0.1,    icon: "ğŸ‘¶", desc: "ãŠå¯ºã®é›‘ç”¨ä¿‚ã€‚" },
        { name: "å†™çµŒãƒ­ãƒœ", cost: 100,         base: 1,      icon: "ğŸ¤–", desc: "è‡ªå‹•å†™çµŒãƒã‚·ãƒ¼ãƒ³ã€‚" },
        { name: "é«˜åƒ§",     cost: 1100,        base: 8,      icon: "ğŸ™", desc: "å¾³ã®é”äººã€‚" },
        { name: "åƒæ‰‹è¦³éŸ³", cost: 12000,       base: 47,     icon: "ğŸ–ï¸", desc: "åœ§å€’çš„ãªæ‰‹æ•°ã€‚" },
        { name: "äº”é‡å¡”",   cost: 130000,      base: 260,    icon: "ğŸ—¼", desc: "å¾³ã‚’æ”¾å°„ã™ã‚‹å¡”ã€‚" },
        { name: "é˜¿ä¿®ç¾…",   cost: 1400000,     base: 1400,   icon: "ğŸ‘¹", desc: "æˆ¦ã„ã®ç¥ã€‚" },
        { name: "æ›¼è¼ç¾…",   cost: 20000000,    base: 7800,   icon: "ğŸŒ", desc: "å®‡å®™ã®çœŸç†ã€‚" },
        { name: "å¤§ä»",     cost: 330000000,   base: 44000,  icon: "ğŸ§˜", desc: "è¶…å·¨å¤§å»ºé€ ç‰©ã€‚" },
        { name: "é›»å­å¦‚æ¥", cost: 5100000000,  base: 260000, icon: "ğŸ’¾", desc: "ãƒ‡ã‚¸ã‚¿ãƒ«ã®æ•‘æ¸ˆã€‚" },
        { name: "æ¶…æ§ƒæ©Ÿé–¢", cost: 75000000000, base: 1600000, icon: "âš›ï¸", desc: "æ‚Ÿã‚Šé‡ç”£è£…ç½®ã€‚" }
    ];
    const upgrades = [
        { id: "c1", name: "ç¡¬ã„ãƒãƒ", desc: "ã‚¯ãƒªãƒƒã‚¯åŠ¹ç‡ 2å€", cost: 500, type: "click", val: 2, icon:"ğŸ¥¢", req: g => g.clickCount >= 100 },
        { id: "c2", name: "é›»å‹•æœ¨é­š", desc: "ã‚¯ãƒªãƒƒã‚¯åŠ¹ç‡ 2å€", cost: 5000, type: "click", val: 2, icon:"âš¡", req: g => g.clickCount >= 500 },
        { id: "g1", name: "é»„é‡‘èŒ¶å®¤", desc: "å…¨ä½“ç”Ÿç”£ 1.2å€", cost: 50000, type: "global", val: 1.2, icon:"ğŸµ", req: g => g.totalToku >= 10000 },
        // æœ«æ³•ã¯è³¼å…¥ã™ã‚‹ã¨ toggle æ©Ÿèƒ½ãŒè§£æ”¾ã•ã‚Œã‚‹ç‰¹åˆ¥ãªã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
        { id: "mappo_unlock", name: "æœ«æ³•æ€æƒ³", desc: "å¥¥ç¾©è§£æ”¾: ç”Ÿç”£3å€ / ã‚¯ãƒªãƒƒã‚¯0.1å€", cost: 666666, type: "unlock", icon:"ğŸ“•", req: g => g.totalToku >= 600000 },
        { id: "g2", name: "ã‚¯ãƒ©ã‚¦ãƒ‰", desc: "å…¨ä½“ç”Ÿç”£ 1.5å€", cost: 1000000, type: "global", val: 1.5, icon:"â˜ï¸", req: g => g.totalToku >= 500000 }
    ];
    const newsData = ["å°åŠä¸»ã€è³½éŠ­ç®±ã§æ˜¼å¯ã€‚", "å†™çµŒãƒ­ãƒœã€OSã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã€‚", "é›»å­å¦‚æ¥ã€ã‚µãƒ¼ãƒãƒ¼ãƒ€ã‚¦ãƒ³ã€‚", "åœ°ç„ã®é‡œã€æœ¬æ—¥ç‰¹å£²æ—¥ã€‚", "èœ˜è››ã®ç³¸ã€å¼·åº¦ä¸è¶³ã§ãƒªã‚³ãƒ¼ãƒ«ã€‚"];

    // ================= STATE =================
    let game = {
        toku: 0, totalToku: 0, allTimeToku: 0, karma: 0, name: "åã‚‚ãªãå¯ºé™¢",
        blds: Array(buildings.length).fill(0),
        upgs: [], clickCount: 0, 
        mappo: false, mappoUnlocked: false, // æœ«æ³•çŠ¶æ…‹ãƒ•ãƒ©ã‚°ã€è§£æ”¾æ¸ˆã¿ãƒ•ãƒ©ã‚°
        start: Date.now()
    };
    let mults = { click: 1, global: 1, blds: Array(buildings.length).fill(1) };
    let currentTab = 'visuals';
    let soundEnabled = true;
    let audioCtx = null;

    // ================= VISUALS (CANVAS) =================
    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    
    // Matrix Rain Props
    const matrixChars = "è¦³è‡ªåœ¨è©è–©è¡Œæ·±èˆ¬è‹¥æ³¢ç¾…èœœå¤šæ™‚ç…§è¦‹äº”è˜Šçš†ç©ºåº¦ä¸€åˆ‡è‹¦å„èˆåˆ©å­è‰²ä¸ç•°ç©ºç©ºä¸ç•°è‰²è‰²å³æ˜¯ç©ºç©ºå³æ˜¯è‰²å—æƒ³è¡Œè­˜äº¦å¾©å¦‚æ˜¯";
    const charArray = matrixChars.split('');
    let fontSize = 14;
    let columns = 0;
    let drops = [];

    // Peaceful Particles Props
    let particles = [];
    const maxParticles = 50;

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        columns = canvas.width / fontSize;
        drops = [];
        for (let i = 0; i < columns; i++) drops[i] = 1;
        // Init particles
        particles = [];
        for(let i=0; i<maxParticles; i++) particles.push(createParticle());
    }

    function createParticle() {
        return {
            x: Math.random() * canvas.width,
            y: canvas.height + Math.random() * 100,
            r: Math.random() * 3 + 1,
            speed: Math.random() * 1 + 0.5,
            wobble: Math.random() * Math.PI * 2
        };
    }

    function drawLoop() {
        if(game.mappo) {
            // --- Matrix Mode ---
            ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#0F0";
            ctx.font = fontSize + "px monospace";
            for (let i = 0; i < drops.length; i++) {
                const text = charArray[Math.floor(Math.random() * charArray.length)];
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            }
        } else {
            // --- Peaceful Mode (Golden Particles) ---
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear completely for clean transparency
            
            // Draw particles
            ctx.fillStyle = "rgba(255, 204, 0, 0.6)"; // Gold
            ctx.shadowBlur = 10;
            ctx.shadowColor = "#ffcc00";
            
            for(let p of particles) {
                ctx.beginPath();
                ctx.arc(p.x + Math.sin(p.wobble)*20, p.y, p.r, 0, Math.PI*2);
                ctx.fill();
                
                p.y -= p.speed;
                p.wobble += 0.02;
                if(p.y < -10) { // Reset if goes off screen
                    Object.assign(p, createParticle());
                }
            }
            ctx.shadowBlur = 0; // Reset
        }
    }

    // ================= INIT =================
    window.onload = () => {
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        loadGame();
        initUI();
        
        // Loops
        setInterval(loop, 100);
        setInterval(autoSave, 30000);
        setInterval(updateNews, 10000);
        setInterval(drawLoop, 50);

        updateNews();
        updateUI();
    };

    function initUI() {
        // Visual Rows
        const rowsContainer = document.getElementById('visual-rows-container');
        buildings.forEach((b, i) => {
            let row = document.createElement('div');
            row.className = `visual-row row-bg-${i % 9}`;
            row.id = `row-${i}`;
            row.innerHTML = `<div class="row-icons" id="row-icons-${i}"></div>`;
            rowsContainer.appendChild(row);
        });
        // Store
        const list = document.getElementById('products-list');
        buildings.forEach((b, i) => {
            let btn = document.createElement('div');
            btn.className = 'product-btn locked';
            btn.id = `product-${i}`;
            btn.onclick = () => buyBuilding(i);
            btn.onmouseenter = (e) => showTooltip('bld', i, e);
            btn.onmousemove = moveTooltip;
            btn.onmouseleave = hideTooltip;
            btn.innerHTML = `<div class="product-icon">${b.icon}</div><div class="product-info"><div class="product-name">${b.name}</div><div class="product-price" id="price-${i}"></div></div><div class="product-count" id="count-${i}"></div>`;
            list.appendChild(btn);
        });
    }

    // ================= MAIN LOOP =================
    function loop() {
        let tps = getTpS();
        if (tps > 0) addToku(tps / 10);
        if(currentTab === 'stats') updateStats();
        updateUI();
    }

    function addToku(n) { game.toku += n; game.totalToku += n; game.allTimeToku += n; }
    
    function getTpS() {
        let sum = 0; game.blds.forEach((c, i) => sum += buildings[i].base * c * mults.blds[i]);
        sum = sum * mults.global * (1 + game.karma * 0.1);
        
        // ã€è¿½åŠ ã€‘æœ«æ³•ãƒ¢ãƒ¼ãƒ‰æ™‚ã®åŠ¹æœ: è‡ªå‹•ç”Ÿç”£3å€
        if(game.mappo) sum *= 3;
        
        return sum;
    }

    function getClickPower() {
        let base = (1 + getTpS() * 0.05) * mults.click; // Base click is 5% of TpS
        // ã€è¿½åŠ ã€‘æœ«æ³•ãƒ¢ãƒ¼ãƒ‰æ™‚ã®åŠ¹æœ: ã‚¯ãƒªãƒƒã‚¯åŠ¹ç‡0.1å€
        if(game.mappo) base *= 0.1;
        return base;
    }

    // ================= UI UPDATE =================
    function updateUI() {
        document.getElementById('bakery-name').innerText = game.name;
        document.getElementById('toku-amount').innerText = formatNum(game.toku) + " å¾³";
        document.getElementById('tps-display').innerText = "per second: " + formatNum(getTpS());
        
        // ãƒãƒ•è¡¨ç¤º
        let buffText = "";
        if(game.mappo) buffText = "ã€æœ«æ³•ã€‘è‡ªå‹•ç”Ÿç”£x3 / ã‚¯ãƒªãƒƒã‚¯æ¿€æ¸›";
        else buffText = "ã€æ­£æ³•ã€‘é€šå¸¸çŠ¶æ…‹";
        document.getElementById('buff-display').innerText = buffText;

        document.title = formatNum(game.toku) + " å¾³";

        // Store: Special Area (Toggle)
        let spec = document.getElementById('store-special');
        if(game.mappoUnlocked) {
            spec.style.display = 'block';
            let btn = document.getElementById('mappo-toggle-btn');
            if(game.mappo) {
                btn.className = 'active';
                document.getElementById('mappo-status-icon').innerText = 'ğŸ”´';
                document.getElementById('mappo-status-text').innerText = 'æœ«æ³•ãƒ¢ãƒ¼ãƒ‰: ON';
            } else {
                btn.className = '';
                document.getElementById('mappo-status-icon').innerText = 'âšª';
                document.getElementById('mappo-status-text').innerText = 'æœ«æ³•ãƒ¢ãƒ¼ãƒ‰: OFF';
            }
        } else {
            spec.style.display = 'none';
        }

        // Upgrades
        let upgCont = document.getElementById('upgrades-container');
        upgrades.forEach(u => {
            let el = document.getElementById(`upg-${u.id}`);
            // è³¼å…¥æ¸ˆã¿ or è§£æ”¾æ¸ˆã¿ãªã‚‰ãƒªã‚¹ãƒˆã‹ã‚‰æ¶ˆã™
            if (game.upgs.includes(u.id) || (u.id === 'mappo_unlock' && game.mappoUnlocked)) { 
                if(el) el.remove(); return; 
            }
            
            if (u.req(game)) {
                if (!el) {
                    let btn = document.createElement('div'); btn.className = 'upgrade-btn'; btn.id = `upg-${u.id}`; btn.innerText = u.icon;
                    btn.onclick = () => buyUpgrade(u);
                    btn.onmouseenter = (e) => showTooltip('upg', u.id, e); btn.onmousemove = moveTooltip; btn.onmouseleave = hideTooltip;
                    upgCont.appendChild(btn);
                }
            }
        });

        // Products
        buildings.forEach((b, i) => {
            let cost = getCost(i);
            let btn = document.getElementById(`product-${i}`);
            if (btn.classList.contains('locked') && game.totalToku >= b.cost * 0.5) btn.classList.remove('locked');
            if (!btn.classList.contains('locked')) {
                document.getElementById(`price-${i}`).innerText = formatNum(cost);
                document.getElementById(`count-${i}`).innerText = game.blds[i] > 0 ? game.blds[i] : "";
                btn.className = 'product-btn ' + (game.toku >= cost ? 'enabled' : 'disabled cannot-afford');
            }
        });

        if(currentTab === 'visuals') updateVisuals();
    }

    function updateVisuals() {
        // Rows
        buildings.forEach((b, i) => {
            let row = document.getElementById(`row-${i}`);
            if (game.blds[i] > 0) {
                row.style.display = 'block';
                // row.style.background... CSSã§ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡å®šæ¸ˆã¿ã ãŒã€æœ«æ³•æ™‚ã¯æš—ãã™ã‚‹ãªã©ã—ã¦ã‚‚ã‚ˆã„
                let iconCont = document.getElementById(`row-icons-${i}`);
                let diff = Math.min(game.blds[i], 20) - iconCont.childElementCount;
                for(let k=0; k<diff; k++){
                    let ic = document.createElement('div'); ic.className = 'visual-icon'; ic.innerText = b.icon;
                    ic.onclick = () => { playSound('pop'); ic.style.transform="scale(1.5)"; setTimeout(()=>ic.style.transform="scale(1)",100); };
                    iconCont.appendChild(ic);
                }
            } else row.style.display = 'none';
        });

        // Mode Switching
        if(game.mappo) {
            document.body.classList.add('mappo-mode');
        } else {
            document.body.classList.remove('mappo-mode');
        }
    }

    function updateStats() {
        document.getElementById('stat-current').innerText = formatNum(game.toku);
        document.getElementById('stat-alltime').innerText = formatNum(game.allTimeToku);
        document.getElementById('stat-start').innerText = new Date(game.start).toLocaleString();
        document.getElementById('stat-clicks').innerText = game.clickCount.toLocaleString();
        document.getElementById('stat-tps').innerText = formatNum(getTpS());
        document.getElementById('stat-karma').innerText = formatNum(game.karma);
        document.getElementById('stat-mode-mult').innerText = game.mappo ? "x3.0 (æœ«æ³•)" : "x1.0 (æ­£æ³•)";
        
        let list = document.getElementById('stat-buildings-list');
        list.innerHTML = "";
        buildings.forEach((b, i) => {
            if(game.blds[i] > 0) {
                let row = document.createElement('div'); row.className = 'stat-row';
                let prod = b.base * game.blds[i] * mults.blds[i] * mults.global * (1+game.karma*0.1);
                if(game.mappo) prod *= 3;
                row.innerHTML = `<span>${b.name}:</span> <span class="stat-val">${game.blds[i]} (ç”Ÿç”£: ${formatNum(prod)}/s)</span>`;
                list.appendChild(row);
            }
        });
    }

    // ================= INTERACTION =================
    function clickMokugyo(e) {
        initAudio();
        let amount = getClickPower();
        addToku(amount); game.clickCount++;
        playSound(game.mappo?'punch':'mokugyo');
        let el = document.createElement('div'); el.className='float-text'; el.innerText="+"+formatNum(amount);
        el.style.left=(e.clientX-20)+"px"; el.style.top=(e.clientY-40)+"px";
        if(game.mappo) el.style.color = "#f00"; // æœ«æ³•æ™‚ã¯èµ¤æ–‡å­—
        document.body.appendChild(el); setTimeout(()=>el.remove(),1500);
        let img=document.getElementById('mokugyo-img'); img.style.transform="scale(0.95)"; setTimeout(()=>img.style.transform="scale(1)",50);
    }
    
    function buyBuilding(i) {
        let c = getCost(i);
        if(game.toku>=c){ game.toku-=c; game.blds[i]++; calcMults(); playSound('buy'); updateUI(); }
    }
    
    function buyUpgrade(u) {
        if(game.toku>=u.cost){ 
            game.toku-=u.cost; 
            if(u.type === 'unlock' && u.id === 'mappo_unlock') {
                game.mappoUnlocked = true;
                game.mappo = true; // è²·ã£ãŸç¬é–“ONã«ã™ã‚‹
                playSound('upgrade'); 
                alert("ã€æœ«æ³•æ€æƒ³ã€‘ã‚’ç²å¾—ã—ã¾ã—ãŸã€‚\nä¼½è—ä¸Šéƒ¨ã®ã‚¹ã‚¤ãƒƒãƒã§ä¸–ç•Œã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚");
            } else {
                game.upgs.push(u.id);
            }
            calcMults(); playSound('upgrade'); updateUI(); hideTooltip(); 
        }
    }

    function toggleMappo(forceVal) {
        if(!game.mappoUnlocked && !forceVal) return;
        game.mappo = (forceVal !== undefined) ? forceVal : !game.mappo;
        playSound('upgrade');
        updateUI();
    }

    function getCost(i) { return Math.floor(buildings[i].cost * Math.pow(1.15, game.blds[i])); }
    function calcMults() {
        mults.click=1; mults.global=1; mults.blds.fill(1);
        upgrades.forEach(u=>{ if(game.upgs.includes(u.id)){ if(u.type==='click')mults.click*=u.val; if(u.type==='global')mults.global*=u.val; } });
    }

    // ================= SYSTEM =================
    function switchTab(t) {
        currentTab=t;
        document.querySelectorAll('.menu-link').forEach(l=>l.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        ['visuals','stats','settings'].forEach(x=>document.getElementById('section-'+x).classList.add('hidden'));
        document.getElementById('section-'+t).classList.remove('hidden');
        if(t==='visuals') updateVisuals();
        if(t==='stats') updateStats();
    }

    function saveGame(m){ localStorage.setItem('nirvanaV215', JSON.stringify(game)); if(m) alert("ä¿å­˜ã—ã¾ã—ãŸ"); }
    function autoSave(){ saveGame(); }
    function loadGame(){ 
        let s=localStorage.getItem('nirvanaV215') || localStorage.getItem('nirvanaV214');
        if(s){ try{ let d=JSON.parse(s); game={...game,...d}; if(game.blds.length<buildings.length){ for(let i=game.blds.length;i<buildings.length;i++)game.blds.push(0); } }catch(e){} }
        calcMults();
    }
    function exportSave(){ document.getElementById('export-area').value = btoa(unescape(encodeURIComponent(JSON.stringify(game)))); }
    function importSave(){ let s=prompt("å‘ªæ–‡ã‚’å…¥åŠ›:"); if(s){ try{ game=JSON.parse(decodeURIComponent(escape(atob(s)))); saveGame(); location.reload(); }catch(e){alert("ç„¡åŠ¹ãªå‘ªæ–‡ã§ã™");} } }
    function wipeSave(){ if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem('nirvanaV215'); location.reload(); } }
    
    function doPrestige(){ 
        let g=Math.max(0,Math.floor(Math.cbrt(game.allTimeToku/1000000))-game.karma);
        if(g>0){ game.karma+=g; game.toku=0; game.blds.fill(0); game.upgs=[]; game.mappo=false; game.mappoUnlocked=false; game.start=Date.now(); saveGame(); location.reload(); }
    }

    function openModal(id){ document.getElementById(id).classList.add('show'); if(id==='prestige-modal') document.getElementById('prestige-gain').innerText=formatNum(Math.max(0,Math.floor(Math.cbrt(game.allTimeToku/1000000))-game.karma)); }
    function closeModal(id){ document.getElementById(id).classList.remove('show'); }
    function renameBakery(){ let n=prompt("åå‰:",game.name); if(n)game.name=n; updateUI(); }
    function toggleSound(){ soundEnabled=!soundEnabled; document.getElementById('btn-sound').innerText="éŸ³é‡: "+(soundEnabled?"ON":"OFF"); }

    function showTooltip(t,id,e){ 
        let title,desc,stats; 
        if(t==='bld'){ 
            let b=buildings[id];
            let p=b.base*mults.blds[id]*mults.global*(1+game.karma*0.1); 
            if(game.mappo) p*=3;
            title=b.name; desc=b.desc; stats=`ç”Ÿç”£: <b>${formatNum(p)}</b> å¾³/s`; 
        }
        else{ let u=upgrades.find(x=>x.id===id); title=u.name; desc=u.desc; stats="ä¾¡æ ¼: "+formatNum(u.cost); }
        let tt=document.getElementById('tooltip'); tt.innerHTML=`<h3>${title}</h3><div class="stats">${stats}</div><div class="desc">${desc}</div>`;
        tt.style.display='block'; moveTooltip(e);
    }
    function moveTooltip(e){ let t=document.getElementById('tooltip'), l=e.clientX-260; if(l<10)l=e.clientX+20; t.style.left=l+"px"; t.style.top=Math.min(e.clientY,window.innerHeight-100)+"px"; }
    function hideTooltip(){ document.getElementById('tooltip').style.display='none'; }
    function formatNum(n){ if(n<10000) return Math.floor(n).toLocaleString(); let u=0; while(n>=10000&&u<units.length-1){n/=10000;u++;} return n.toFixed(3)+units[u]; }
    function updateNews(){ document.getElementById('news-ticker').innerText="News: "+newsData[Math.floor(Math.random()*newsData.length)]; }

    // Audio
    function initAudio(){ if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended')audioCtx.resume(); }
    function playSound(t){ if(!audioCtx||!soundEnabled)return; let o=audioCtx.createOscillator(),g=audioCtx.createGain(),n=audioCtx.currentTime; o.connect(g);g.connect(audioCtx.destination);
        if(t==='mokugyo'){o.frequency.value=300+Math.random()*50;g.gain.setValueAtTime(0,n);g.gain.linearRampToValueAtTime(0.5,n+0.01);g.gain.exponentialRampToValueAtTime(0.01,n+0.1);o.start(n);o.stop(n+0.1);}
        if(t==='buy'){o.frequency.value=600;g.gain.setValueAtTime(0.1,n);g.gain.exponentialRampToValueAtTime(0.01,n+0.1);o.start(n);o.stop(n+0.1);}
        if(t==='pop'){o.frequency.value=800;g.gain.setValueAtTime(0.05,n);g.gain.exponentialRampToValueAtTime(0.001,n+0.05);o.start(n);o.stop(n+0.05);}
        if(t==='upgrade'){o.type='triangle';o.frequency.setValueAtTime(440,n);o.frequency.exponentialRampToValueAtTime(880,n+0.1);g.gain.setValueAtTime(0.1,n);g.gain.linearRampToValueAtTime(0,n+0.3);o.start(n);o.stop(n+0.3);}
    }
</script>
</body>
</html>
