<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‹ãƒ«ãƒ´ã‚¡ãƒ¼ãƒŠãƒ»ã‚¯ãƒªãƒƒã‚«ãƒ¼ Ver2.2</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-color-rgb: 42, 42, 42;
            --text-color: #e0e0e0;
            --accent-color: #d4af37; /* Gold */
            --red-accent: #b22222;   /* Mappo Red */
            --karma-color: #9370db;  /* Purple */
            --mappo-bg: #2b0000;
        }

        body {
            font-family: 'Hiragino Mincho ProN', 'Yu Mincho', serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            display: grid; grid-template-columns: 340px 1fr 400px;
            user-select: none; transition: background 1s ease;
        }

        /* --- èƒŒæ™¯é€²åŒ– --- */
        body.bg-lv1 { background: #1a1a1a; }
        body.bg-lv2 { background: linear-gradient(to bottom, #2c3e50, #000000); }
        body.bg-lv3 { background: linear-gradient(to bottom, #d4af37 0%, #b8860b 100%); }
        body.bg-lv4 { background: radial-gradient(circle, #1a0b2e 0%, #000000 100%); }
        body.bg-lv5 { background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIiBmaWxsLW9wYWNpdHk9IjAuMSIgZmlsbD0iI2ZmZiI+PGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMSIvPjwvc3ZnPg=='), linear-gradient(to bottom, #000022, #000000); }
        body.mappo-mode { background: var(--mappo-bg) !important; animation: tremor 0.5s infinite; }
        body.mappo-mode #center-panel { filter: sepia(100%) hue-rotate(-50deg) saturate(300%); }
        @keyframes tremor { 0% { transform: translate(0,0); } 50% { transform: translate(-1px,1px); } 100% { transform: translate(0,0); } }

        /* --- ãƒ‘ãƒãƒ«å…±é€š --- */
        .panel { padding: 15px; display: flex; flex-direction: column; z-index: 10; backdrop-filter: blur(2px); border-color: var(--accent-color); position: relative; }
        .btn { background: rgba(0,0,0,0.5); color: var(--accent-color); border: 1px solid var(--accent-color); padding: 5px 10px; margin: 2px; cursor: pointer; transition: 0.2s; font-family: inherit; font-size: 0.9em;}
        .btn:hover { background: var(--accent-color); color: black; }
        .btn-danger { border-color: var(--red-accent); color: var(--red-accent); }
        .btn-danger:hover { background: var(--red-accent); color: white; }

        /* --- å·¦ãƒ‘ãƒãƒ« (ãƒãƒˆãƒªãƒƒã‚¯ã‚¹èƒŒæ™¯) --- */
        #left-panel {
            background-color: rgba(10, 10, 10, 0.85); /* å°‘ã—é€æ˜ã« */
            border-right: 2px solid var(--accent-color);
            text-align: center; overflow: hidden;
        }
        #matrix-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; opacity: 0.2; pointer-events: none;
        }

        #toku-display { font-size: 2em; font-weight: bold; color: var(--accent-color); text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); margin-bottom: 5px; }
        #karma-display { color: var(--karma-color); font-weight: bold; display:none; }
        
        #mokugyo-wrapper { position: relative; margin: 30px auto; width: 220px; height: 220px; cursor: pointer; z-index: 20;}
        #mokugyo-img {
            width: 100%; height: 100%; border-radius: 50%;
            background: radial-gradient(circle, #8b4513 0%, #3e1e05 100%); border: 6px solid #d4af37;
            display: flex; justify-content: center; align-items: center;
            font-size: 80px; box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            transition: transform 0.05s;
        }
        #mokugyo-wrapper:active #mokugyo-img { transform: scale(0.95); }
        .mokugyo-mappo { border-color: #ff0000 !important; box-shadow: 0 0 50px red !important; background: #300 !important; color: red; }

        /* --- ä¸­å¤®ãƒ‘ãƒãƒ« (ç™¾é¬¼å¤œè¡Œ) --- */
        #center-panel { position: relative; display: flex; flex-direction: column; overflow: hidden; }
        #news-ticker { background: rgba(0,0,0,0.8); color: var(--accent-color); padding: 8px; white-space: nowrap; overflow: hidden; font-family: monospace; border-bottom: 1px solid var(--accent-color); cursor: pointer; z-index: 20;}
        
        /* ç™¾é¬¼å¤œè¡Œã‚³ãƒ³ãƒ†ãƒŠ */
        #hyakki-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0; overflow: hidden;
            opacity: 0.6;
        }
        /* æµ®éŠã‚¢ã‚¤ã‚³ãƒ³ */
        .hyakki-icon {
            position: absolute; font-size: 30px;
            animation: floatDrift linear infinite;
            will-change: transform; /* ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– */
        }
        /* CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šãµã‚ãµã‚æ¨ªç§»å‹• */
        @keyframes floatDrift {
            0% { transform: translate(-50px, 0) rotate(-5deg); opacity: 0; }
            10% { opacity: 1; }
            50% { transform: translate(50vw, -20px) rotate(5deg); }
            90% { opacity: 1; }
            100% { transform: translate(100vw, 0) rotate(-5deg); opacity: 0; }
        }

        #message-log { position: absolute; bottom: 20px; width: 100%; font-size: 12px; color: #aaa; text-align: center; height: 100px; overflow: hidden; display: flex; flex-direction: column-reverse; text-shadow: 1px 1px 2px black; z-index: 20; pointer-events: none;}
        
        .falling-item { position: absolute; top: -100px; left: 50%; cursor: pointer; z-index: 100; transition: top 0.5s; filter: drop-shadow(0 0 5px gold); font-size: 40px; }
        .falling-item.oni { filter: drop-shadow(0 0 10px red); font-size: 60px; }

        /* --- å³ãƒ‘ãƒãƒ« --- */
        #right-panel { background-color: rgba(var(--panel-color-rgb), 0.95); border-left: 2px solid var(--accent-color); padding: 0; }
        #tabs { display: flex; background: #222; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; color: #666; font-size: 12px; border-bottom: 1px solid #444; }
        .tab.active { background: #333; color: var(--accent-color); font-weight: bold; border-bottom: 3px solid var(--accent-color); }
        #store-container { padding: 10px; overflow-y: auto; height: 100%; }
        .item { background: rgba(51,51,51,0.8); border: 1px solid #555; margin-bottom: 5px; padding: 8px; cursor: pointer; display: grid; grid-template-columns: 40px 1fr auto; gap: 10px; align-items: center; }
        .item:hover { background: #444; border-color: var(--accent-color); }
        .item.locked { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
        .item-cost { color: var(--accent-color); font-size: 11px; font-weight: bold; }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal.show { opacity: 1; pointer-events: auto; }
        .modal-content { background: #1a1a1a; border: 2px solid var(--accent-color); padding: 20px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; text-align: center; border-radius: 8px; box-shadow: 0 0 50px rgba(212, 175, 55, 0.2); }
        textarea { width: 100%; height: 80px; background: #333; color: #fff; border: 1px solid #555; margin-bottom: 10px; font-family: monospace;}

        /* ãã®ä»– */
        .float-text { position: absolute; font-weight: bold; pointer-events: none; animation: floatUp 1s forwards; text-shadow: 0 0 3px black; z-index: 200; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-50px); opacity: 0; } }
    </style>
</head>
<body>

<div id="left-panel" class="panel">
    <canvas id="matrix-canvas"></canvas> <div style="margin-bottom: 20px; z-index: 20;">
        <div id="toku-display">0 å¾³</div>
        <div id="tps-display" style="font-size: 0.9em; color: #888;">æ¯ç§’: 0 å¾³</div>
        <div id="karma-display">æ¥­: 0</div>
    </div>

    <div id="mokugyo-wrapper" onmousedown="clickMokugyo(event)">
        <div id="mokugyo-img">æœ¨é­š</div>
    </div>

    <div style="flex-grow:1"></div>
    <div style="font-size: 0.8em; z-index: 20;">
        <button class="btn" onclick="saveGame(true)">è¨˜éŒ²</button>
        <button class="btn" onclick="openModal('spell-modal')">å‘ªæ–‡</button>
        <button class="btn btn-danger" onclick="openModal('prestige-modal')">è¼ªå»»</button>
    </div>
</div>

<div id="center-panel">
    <div id="news-ticker" onclick="clickNews()">News: ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­...</div>
    
    <div id="hyakki-container"></div>

    <div id="message-log"></div>
    <div id="falling-item" class="falling-item" onclick="clickFallingItem()"></div>
</div>

<div id="right-panel" class="panel">
    <div id="tabs">
        <div class="tab active" onclick="switchTab('facilities')">ä¼½è—</div>
        <div class="tab" onclick="switchTab('upgrades')">çµŒå…¸</div>
    </div>
    <div id="store-container"></div>
</div>

<div id="spell-modal" class="modal">
    <div class="modal-content">
        <h2>å¾©æ´»ã®å‘ªæ–‡</h2>
        <p>ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãå‡ºã—ãƒ»èª­ã¿è¾¼ã¿ã‚’è¡Œã„ã¾ã™ã€‚</p>
        <textarea id="save-string" placeholder="ã“ã“ã«å‘ªæ–‡ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ / ã“ã“ã«å‘ªæ–‡ã‚’è²¼ã‚Šä»˜ã‘ã¾ã™"></textarea>
        <div>
            <button class="btn" onclick="exportSave()">å‘ªæ–‡ã‚’å”±ãˆã‚‹ (Copy)</button>
            <button class="btn btn-danger" onclick="importSave()">å‘ªæ–‡ã‚’èã (Load)</button>
        </div>
        <hr style="border-color:#444">
        <button class="btn" onclick="closeModal('spell-modal')">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="prestige-modal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--karma-color)">è¼ªå»»è»¢ç”Ÿ</h2>
        <p>å¾³ã‚’æ¨ã¦ã€Œæ¥­ã€ã‚’å¾—ã¦ç”Ÿã¾ã‚Œå¤‰ã‚ã‚Šã¾ã™ã€‚(æ¥­1ã¤ = ç”Ÿç”£+10%)<br>ç²å¾—äºˆå®š: <span id="prestige-gain" style="font-weight:bold">0</span></p>
        <button class="btn btn-danger" onclick="doPrestige()">è»¢ç”Ÿã™ã‚‹</button>
        <br><br><button class="btn" onclick="closeModal('prestige-modal')">ã‚„ã‚ã‚‹</button>
    </div>
</div>

<script>
    // ==========================================
    //  ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å®šç¾© (Ver2.2 ç°¡æ˜“ç‰ˆ)
    // ==========================================
    const units = ["", "ä¸‡", "å„„", "å…†", "äº¬", "å“", "ğ¥±", "ç©£", "æº", "æ¾—", "æ­£", "è¼‰", "æ¥µ", "æ’æ²³æ²™", "é˜¿åƒ§ç¥‡", "é‚£ç”±ä»–", "ä¸å¯æ€è­°", "ç„¡é‡å¤§æ•°", "æ¶…æ§ƒ"];
    const facilityData = [
        { name: "å°åŠä¸»", baseCost: 15, baseProd: 1, icon: "ğŸ‘¶" },
        { name: "å†™çµŒãƒ­ãƒœ", baseCost: 100, baseProd: 5, icon: "ğŸ¤–" },
        { name: "é«˜åƒ§", baseCost: 1100, baseProd: 20, icon: "ğŸ™" },
        { name: "åƒæ‰‹è¦³éŸ³", baseCost: 12000, baseProd: 100, icon: "ğŸ–ï¸" },
        { name: "äº”é‡å¡”", baseCost: 130000, baseProd: 500, icon: "ğŸš€" },
        { name: "é˜¿ä¿®ç¾…", baseCost: 1400000, baseProd: 2500, icon: "ğŸ‘¹" },
        { name: "æ›¼è¼ç¾…", baseCost: 20000000, baseProd: 12000, icon: "ğŸŒ" },
        { name: "å¤§ä»", baseCost: 330000000, baseProd: 60000, icon: "ğŸŒŒ" }
    ];
    const upgradeData = [
        { id: "c1", name: "ç¡¬ã„ãƒãƒ", desc: "ã‚¯ãƒªãƒƒã‚¯2å€", cost: 500, type: "click", val: 2, req: g => g.clickCount >= 100 },
        { id: "g1", name: "é»„é‡‘èŒ¶å®¤", desc: "å…¨ä½“1.5å€", cost: 50000, type: "global", val: 1.5, req: g => g.totalToku >= 10000 },
        { id: "mappo", name: "ç¦æ–­ã®çµŒå…¸", desc: "æœ«æ³•ãƒ¢ãƒ¼ãƒ‰çªå…¥", cost: 666666, type: "event", req: g => g.totalToku >= 500000 }
    ];

    let game = {
        toku: 0, totalToku: 0, allTimeToku: 0, karma: 0,
        facilities: Array(facilityData.length).fill(0),
        upgrades: [], clickCount: 0, mappo: false
    };
    let audioCtx = null;
    let multipliers = { click: 1, global: 1, facilities: [] };
    let currentTab = 'facilities';
    let fallingItemActive = false;

    // ==========================================
    //  åˆæœŸåŒ– & ãƒ«ãƒ¼ãƒ—
    // ==========================================
    window.onload = () => {
        loadGame(); calcMultipliers(); initMatrix();
        setInterval(gameLoop, 100);
        setInterval(saveGame, 30000);
        setInterval(updateHyakkiYagyo, 3000); // 3ç§’ã”ã¨ã«ç™¾é¬¼å¤œè¡Œã‚’æ›´æ–°
        setTimeout(scheduleFallingItem, 60000);
    };

    function gameLoop() {
        let tps = getTpS(); if(tps > 0) addToku(tps / 10);
        updateUI(tps);
    }

    function updateUI(tps) {
        document.getElementById('toku-display').innerText = formatNumber(game.toku) + " å¾³";
        document.getElementById('tps-display').innerText = "æ¯ç§’: " + formatNumber(tps) + " å¾³";
        document.title = formatNumber(game.toku) + " å¾³ - ãƒ‹ãƒ«ãƒ´ã‚¡ãƒ¼ãƒŠ";
        if(currentTab === 'facilities') renderFacilities(false);
        updateVisuals();
    }

    // ==========================================
    //  ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ & è¨ˆç®—
    // ==========================================
    function clickMokugyo(e) {
        initAudio();
        let power = (1 + getTpS() * 0.02) * multipliers.click;
        addToku(power); game.clickCount++;
        spawnFloatText(e.clientX, e.clientY, "+" + formatNumber(power));
        playSound(game.mappo ? 'punch' : 'mokugyo');
    }
    function buyFacility(idx) {
        let cost = getCost(idx);
        if(game.toku >= cost) { game.toku -= cost; game.facilities[idx]++; playSound('buy'); renderFacilities(); calcMultipliers(); }
    }
    function buyUpgrade(uid) {
        let u = upgradeData.find(d => d.id === uid);
        if(game.toku >= u.cost && !game.upgrades.includes(uid)) {
            game.toku -= u.cost; game.upgrades.push(uid);
            if(u.id === 'mappo') { game.mappo = true; playSound('mappo'); logMessage("æœ«æ³•ãƒ¢ãƒ¼ãƒ‰çªå…¥ï¼"); }
            playSound('powerup'); calcMultipliers(); renderUpgrades();
        }
    }
    function addToku(n) { game.toku += n; game.totalToku += n; game.allTimeToku += n; }
    function getTpS() {
        let tps = game.facilities.reduce((sum, count, i) => sum + facilityData[i].baseProd * count * multipliers.facilities[i], 0);
        return tps * multipliers.global * (1 + game.karma * 0.1);
    }
    function getCost(idx) { return Math.floor(facilityData[idx].baseCost * Math.pow(1.15, game.facilities[idx])); }
    function calcMultipliers() {
        multipliers = { click: 1, global: 1, facilities: Array(facilityData.length).fill(1) };
        game.upgrades.forEach(uid => {
            let u = upgradeData.find(d => d.id === uid);
            if(u.type === 'click') multipliers.click *= u.val;
            if(u.type === 'global') multipliers.global *= u.val;
        });
    }

    // ==========================================
    //  ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æ¼”å‡º (ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ & ç™¾é¬¼å¤œè¡Œ)
    // ==========================================
    // --- èˆ¬è‹¥å¿ƒçµŒãƒãƒˆãƒªãƒƒã‚¯ã‚¹ ---
    let matrixCtx, matrixW, matrixH, matrixCols, matrixDrops;
    const matrixChars = "è‰²å³æ˜¯ç©ºç©ºå³æ˜¯è‰²èˆ¬è‹¥å¿ƒçµŒå¾³å–ç¾¯è«¦åƒ§ä¼½è€¶è©æè–©å©†è¨¶".split("");
    function initMatrix() {
        const canvas = document.getElementById('matrix-canvas');
        matrixCtx = canvas.getContext('2d');
        matrixW = canvas.width = canvas.offsetWidth;
        matrixH = canvas.height = canvas.offsetHeight;
        matrixCols = Math.floor(matrixW / 20);
        matrixDrops = Array(matrixCols).fill(1);
        setInterval(drawMatrix, 50);
        window.addEventListener('resize', () => { matrixW=canvas.width=canvas.offsetWidth; matrixH=canvas.height=canvas.offsetHeight; });
    }
    function drawMatrix() {
        matrixCtx.fillStyle = game.mappo ? 'rgba(40, 0, 0, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        matrixCtx.fillRect(0, 0, matrixW, matrixH);
        matrixCtx.fillStyle = game.mappo ? '#ff3333' : '#00ff00'; // æœ«æ³•ã¯èµ¤
        matrixCtx.font = '15px monospace';
        for(let i=0; i<matrixDrops.length; i++) {
            const text = matrixChars[Math.floor(Math.random()*matrixChars.length)];
            matrixCtx.fillText(text, i*20, matrixDrops[i]*20);
            if(matrixDrops[i]*20 > matrixH && Math.random() > 0.975) matrixDrops[i] = 0;
            matrixDrops[i]++;
        }
    }

    // --- ç™¾é¬¼å¤œè¡Œ ---
    function updateHyakkiYagyo() {
        const container = document.getElementById('hyakki-container');
        const totalFacilities = game.facilities.reduce((a,b)=>a+b, 0);
        const maxIcons = 150; // è¡¨ç¤ºã‚­ãƒ£ãƒƒãƒ—
        
        // ç¾åœ¨ã®ã‚¢ã‚¤ã‚³ãƒ³æ•°ãŒã‚­ãƒ£ãƒƒãƒ—ã‚ˆã‚Šå°‘ãªã„å ´åˆã®ã¿è¿½åŠ 
        if(container.children.length < maxIcons && totalFacilities > 0) {
            // ã©ã®æ–½è¨­ã‚’å‡ºã™ã‹ãƒ©ãƒ³ãƒ€ãƒ æ±ºå®šï¼ˆæ‰€æŒæ•°ã§é‡ã¿ä»˜ã‘ï¼‰
            let rand = Math.random() * totalFacilities;
            let current = 0;
            let selectedFacility = facilityData[0];
            for(let i=0; i<game.facilities.length; i++) {
                current += game.facilities[i];
                if(rand < current) { selectedFacility = facilityData[i]; break; }
            }

            let el = document.createElement('div');
            el.className = 'hyakki-icon';
            el.innerText = selectedFacility.icon;
            // ãƒ©ãƒ³ãƒ€ãƒ ãªé–‹å§‹ä½ç½®ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦
            el.style.top = Math.random() * 90 + '%';
            el.style.left = '-50px';
            el.style.animationDuration = (Math.random() * 20 + 15) + 's'; // 15~35ç§’
            el.style.fontSize = (Math.random() * 20 + 20) + 'px'; // ã‚µã‚¤ã‚ºã°ã‚‰ã¤ã
            
            container.appendChild(el);
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«å‰Šé™¤
            setTimeout(() => el.remove(), 35000);
        }
    }

    function updateVisuals() {
        document.body.className = game.mappo ? "mappo-mode" : (game.totalToku > 1e12 ? "bg-lv5" : game.totalToku > 1e8 ? "bg-lv3" : "bg-lv1");
        document.getElementById('mokugyo-img').classList.toggle('mokugyo-mappo', game.mappo);
    }

    // ==========================================
    //  ã‚¤ãƒ™ãƒ³ãƒˆ & UIæ“ä½œ
    // ==========================================
    function switchTab(n) { currentTab=n; document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active')); document.querySelector(`.tab[onclick="switchTab('${n}')"]`).classList.add('active'); if(n==='facilities')renderFacilities(); else renderUpgrades(); }
    function renderFacilities(full=true) {
        let c = document.getElementById('store-container'); if(full) c.innerHTML="";
        if(!full && c.children.length===facilityData.length) { Array.from(c.children).forEach((d,i)=>{ let cost=getCost(i); d.classList.toggle('locked',game.toku<cost); d.querySelector('.item-cost').innerText="å¾³:"+formatNumber(cost); }); return; }
        facilityData.forEach((f,i)=>{ let cost=getCost(i); let d=document.createElement('div'); d.className=`item ${game.toku>=cost?'':'locked'}`; d.onclick=()=>buyFacility(i); d.innerHTML=`<div style="font-size:24px">${f.icon}</div><div><h4>${f.name}</h4><span class="item-cost">å¾³:${formatNumber(cost)}</span></div><div style="font-size:18px;font-weight:bold;color:#666">${game.facilities[i]}</div>`; c.appendChild(d); });
    }
    function renderUpgrades() {
        let c = document.getElementById('store-container'); c.innerHTML="";
        upgradeData.forEach(u=>{ if(!game.upgrades.includes(u.id) && u.req(game)){ let d=document.createElement('div'); d.className=`item ${game.toku>=u.cost?'':'locked'}`; d.onclick=()=>buyUpgrade(u.id); d.innerHTML=`<div style="font-size:24px">ğŸ“œ</div><div><h4>${u.name}</h4><p>${u.desc}</p><span class="item-cost">å¾³:${formatNumber(u.cost)}</span></div>`; c.appendChild(d); }});
    }
    function scheduleFallingItem() { if(fallingItemActive)return; setTimeout(()=>{ spawnFallingItem(); scheduleFallingItem(); }, Math.random()*120000+60000); }
    function spawnFallingItem() { fallingItemActive=true; let el=document.getElementById('falling-item'); el.style.top='-100px'; el.style.display='block'; el.innerText=game.mappo?"ğŸ‘¹":"ğŸ•¸ï¸"; el.classList.toggle('oni',game.mappo); setTimeout(()=>{el.style.top='110vh'; setTimeout(()=>{fallingItemActive=false;},1000)}, 8000); }
    function clickFallingItem() { if(!fallingItemActive)return; fallingItemActive=false; document.getElementById('falling-item').style.display='none'; let bonus=Math.max(game.toku*0.1, getTpS()*300); addToku(bonus); playSound('chime'); logMessage("ãƒœãƒ¼ãƒŠã‚¹ç²å¾—: +"+formatNumber(bonus)+"å¾³"); }
    function logMessage(m) { let d=document.createElement('div'); d.innerText=m; document.getElementById('message-log').prepend(d); if(document.getElementById('message-log').children.length>5)document.getElementById('message-log').lastChild.remove(); }

    // ==========================================
    //  ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰ãƒ»å‘ªæ–‡ãƒ»è»¢ç”Ÿ
    // ==========================================
    function saveGame(m){ localStorage.setItem('nirvanaV22', JSON.stringify(game)); if(m)alert("è¨˜éŒ²ã—ã¾ã—ãŸ"); }
    function loadGame(){ let s=localStorage.getItem('nirvanaV22'); if(s){ try{ game={...game,...JSON.parse(s)}; if(game.facilities.length<facilityData.length)game.facilities.push(0); }catch(e){console.error(e);} } if(game.karma>0){document.getElementById('karma-display').style.display="block"; document.getElementById('karma-display').innerText="æ¥­: "+formatNumber(game.karma);} }
    function exportSave(){ document.getElementById('save-string').value = btoa(JSON.stringify(game)); document.getElementById('save-string').select(); alert("å‘ªæ–‡ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }
    function importSave(){ try{ let d=JSON.parse(atob(document.getElementById('save-string').value)); if(d.startTime){ game=d; saveGame(); location.reload(); }else throw"e"; }catch(e){alert("å‘ªæ–‡ãŒé•ã„ã¾ã™");} }
    function doPrestige(){ let g=Math.max(0, Math.floor(Math.cbrt(game.allTimeToku/1e6))-game.karma); if(g>0 && confirm("è»¢ç”Ÿã—ã¾ã™ã‹ï¼Ÿ")){ game.karma+=g; game.toku=0; game.facilities.fill(0); game.upgrades=[]; game.mappo=false; saveGame(); location.reload(); } }

    // ==========================================
    //  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ==========================================
    function openModal(id){ document.getElementById(id).classList.add('show'); if(id==='prestige-modal')document.getElementById('prestige-gain').innerText=formatNumber(Math.max(0, Math.floor(Math.cbrt(game.allTimeToku/1e6))-game.karma)); }
    function closeModal(id){ document.getElementById(id).classList.remove('show'); }
    function formatNumber(n){ if(n<1e4)return Math.floor(n).toLocaleString(); let i=0; while(n>=1e4&&i<units.length-1){n/=1e4;i++;} return n.toFixed(2)+units[i]; }
    function spawnFloatText(x,y,t){ let e=document.createElement('div'); e.className='float-text'; e.innerText=t; e.style.left=x+'px'; e.style.top=(y-50)+'px'; e.style.color='#fff'; document.body.appendChild(e); setTimeout(()=>e.remove(),1000); }
    function initAudio(){ if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended')audioCtx.resume(); }
    function playSound(t){ if(!audioCtx)return; let o=audioCtx.createOscillator(),g=audioCtx.createGain(),now=audioCtx.currentTime; o.connect(g); g.connect(audioCtx.destination);
        if(t==='mokugyo'){o.frequency.value=300+Math.random()*50; g.gain.setValueAtTime(0,now); g.gain.linearRampToValueAtTime(0.5,now+0.02); g.gain.exponentialRampToValueAtTime(0.01,now+0.15); o.start(now); o.stop(now+0.15);}
        if(t==='buy'){o.type='sine'; o.frequency.value=600; g.gain.setValueAtTime(0.1,now); g.gain.exponentialRampToValueAtTime(0.01,now+0.1); o.start(now); o.stop(now+0.1);}
        if(t==='chime'){o.type='sine';o.frequency.setValueAtTime(1000,now);o.frequency.linearRampToValueAtTime(1500,now+0.5);g.gain.setValueAtTime(0,now);g.gain.linearRampToValueAtTime(0.2,now+0.1);g.gain.linearRampToValueAtTime(0,now+1);o.start(now);o.stop(now+1);}
        if(t==='mappo'){o.type='sawtooth';o.frequency.setValueAtTime(100,now);g.gain.setValueAtTime(0.3,now);g.gain.linearRampToValueAtTime(0,now+2);o.start(now);o.stop(now+2);}
    }
</script>
</body>
</html>
