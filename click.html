<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‹ãƒ«ãƒ´ã‚¡ãƒ¼ãƒŠãƒ»ã‚¯ãƒªãƒƒã‚«ãƒ¼ Ver2.0</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-color: rgba(42, 42, 42, 0.95);
            --text-color: #e0e0e0;
            --accent-color: #d4af37; /* Gold */
            --red-accent: #b22222;   /* Mappo Red */
            --karma-color: #9370db;  /* Purple */
            --mappo-bg: #2b0000;
        }

        body {
            font-family: 'Hiragino Mincho ProN', 'Yu Mincho', serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: grid;
            grid-template-columns: 340px 1fr 400px;
            user-select: none;
            transition: background 1s ease, filter 0.5s;
        }

        /* --- èƒŒæ™¯é€²åŒ– & æœ«æ³•ãƒ¢ãƒ¼ãƒ‰ --- */
        body.bg-lv1 { background: #1a1a1a; }
        body.bg-lv2 { background: linear-gradient(to bottom, #2c3e50, #000000); }
        body.bg-lv3 { background: linear-gradient(to bottom, #d4af37 0%, #b8860b 100%); }
        body.bg-lv4 { background: radial-gradient(circle, #1a0b2e 0%, #000000 100%); }
        body.bg-lv5 { background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIiBmaWxsLW9wYWNpdHk9IjAuMSIgZmlsbD0iI2ZmZiI+PGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMSIvPjwvc3ZnPg=='), linear-gradient(to bottom, #000022, #000000); }
        
        body.mappo-mode {
            background: var(--mappo-bg) !important;
            animation: tremor 0.5s infinite;
        }
        body.mappo-mode #center-panel { filter: sepia(100%) hue-rotate(-50deg) saturate(300%); }
        @keyframes tremor { 0% { transform: translate(0,0); } 25% { transform: translate(1px,1px); } 50% { transform: translate(-1px,-1px); } 75% { transform: translate(-1px,1px); } 100% { transform: translate(0,0); } }

        /* --- ãƒ‘ãƒãƒ«å…±é€š --- */
        .panel { padding: 15px; display: flex; flex-direction: column; z-index: 10; backdrop-filter: blur(5px); border-color: var(--accent-color); }
        .btn { background: transparent; color: var(--accent-color); border: 1px solid var(--accent-color); padding: 5px 10px; margin: 2px; cursor: pointer; transition: 0.2s; font-family: inherit; }
        .btn:hover { background: var(--accent-color); color: black; }
        .btn-danger { border-color: var(--red-accent); color: var(--red-accent); }
        .btn-danger:hover { background: var(--red-accent); color: white; }

        /* --- å·¦ãƒ‘ãƒãƒ« --- */
        #left-panel { background-color: rgba(10, 10, 10, 0.9); border-right: 2px solid var(--accent-color); text-align: center; }
        #toku-display { font-size: 2em; font-weight: bold; color: var(--accent-color); text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); margin-bottom: 5px; }
        #karma-display { color: var(--karma-color); font-weight: bold; display:none; }
        
        #mokugyo-wrapper { position: relative; margin: 30px auto; width: 220px; height: 220px; cursor: pointer; }
        #mokugyo-img {
            width: 100%; height: 100%; border-radius: 50%;
            background: radial-gradient(circle, #8b4513 0%, #3e1e05 100%);
            border: 6px solid #d4af37;
            display: flex; justify-content: center; align-items: center;
            font-size: 80px; box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            transition: transform 0.05s, border-color 0.5s, box-shadow 0.5s;
        }
        #mokugyo-wrapper:active #mokugyo-img { transform: scale(0.95); }
        
        /* æœ¨é­šã®é€²åŒ–ã‚¹ã‚¿ã‚¤ãƒ« */
        .mokugyo-lv2 { border-color: #fff !important; box-shadow: 0 0 20px #fff !important; background: radial-gradient(circle, #ffd700 0%, #b8860b 100%) !important; }
        .mokugyo-lv3 { border-color: #00ffff !important; box-shadow: 0 0 30px #00ffff !important; background: radial-gradient(circle, #e0ffff 0%, #00ced1 100%) !important; }
        .mokugyo-lv4 { border-color: #ff00ff !important; box-shadow: 0 0 50px #ff00ff !important; background: black !important; color: white; }
        .mokugyo-mappo { border-color: #ff0000 !important; box-shadow: 0 0 50px red !important; background: #300 !important; color: red; }

        /* --- ä¸­å¤®ãƒ‘ãƒãƒ« --- */
        #center-panel { position: relative; display: flex; flex-direction: column; overflow: hidden; }
        #news-ticker { background: rgba(0,0,0,0.8); color: var(--accent-color); padding: 8px; white-space: nowrap; overflow: hidden; font-family: monospace; border-bottom: 1px solid var(--accent-color); cursor: pointer; }
        #visual-area { flex-grow: 1; display: flex; justify-content: center; align-items: center; flex-direction: column; pointer-events: none; }
        #message-log { font-size: 12px; color: #aaa; text-align: center; height: 150px; overflow: hidden; display: flex; flex-direction: column-reverse; text-shadow: 1px 1px 2px black; }
        
        /* èœ˜è››ã®ç³¸ / é‚ªé¬¼ */
        .falling-item { position: absolute; top: -100px; left: 50%; cursor: pointer; z-index: 100; transition: top 0.5s; filter: drop-shadow(0 0 5px gold); font-size: 40px; }
        .falling-item.oni { filter: drop-shadow(0 0 10px red); font-size: 60px; }

        /* --- å³ãƒ‘ãƒãƒ« (ã‚¿ãƒ–) --- */
        #right-panel { background-color: var(--panel-color); border-left: 2px solid var(--accent-color); padding: 0; }
        #tabs { display: flex; background: #222; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; color: #666; font-size: 12px; border-bottom: 1px solid #444; }
        .tab.active { background: #333; color: var(--accent-color); font-weight: bold; border-bottom: 3px solid var(--accent-color); }
        .tab.mappo-tab { color: var(--red-accent); }

        #store-container { padding: 10px; overflow-y: auto; height: 100%; }
        
        /* ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆ */
        .item { background: #333; border: 1px solid #555; margin-bottom: 5px; padding: 8px; cursor: pointer; display: grid; grid-template-columns: 40px 1fr auto; gap: 10px; align-items: center; }
        .item:hover { background: #444; border-color: var(--accent-color); }
        .item.locked { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
        .item h4 { margin: 0; font-size: 14px; }
        .item p { margin: 0; font-size: 10px; color: #aaa; }
        .item-cost { color: var(--accent-color); font-size: 11px; font-weight: bold; }

        /* æ¯å±±æ°´ã‚°ãƒªãƒƒãƒ‰ */
        #garden-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 10px; background: #222; border: 4px double #666; width: 200px; margin: 0 auto; }
        .garden-cell { width: 60px; height: 60px; background: #ddd; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; border: 1px solid #999; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2); }
        .garden-cell:hover { opacity: 0.8; }

        /* ç§˜å®ã‚°ãƒªãƒƒãƒ‰ */
        #artifact-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 10px; }
        .artifact-slot { width: 100%; aspect-ratio: 1; background: #222; border: 1px solid #444; display: flex; justify-content: center; align-items: center; font-size: 24px; opacity: 0.3; }
        .artifact-slot.found { opacity: 1; border-color: var(--accent-color); background: radial-gradient(circle, #444, #222); box-shadow: 0 0 5px var(--accent-color); }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal.show { opacity: 1; pointer-events: auto; }
        .modal-content { background: #1a1a1a; border: 2px solid var(--accent-color); padding: 20px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; text-align: center; border-radius: 8px; box-shadow: 0 0 50px rgba(212, 175, 55, 0.2); }

        /* æ›¼è¼ç¾…ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼ */
        #mandala-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding: 20px; background: radial-gradient(circle, #330033, #000); border: 2px solid var(--karma-color); margin: 10px 0; }
        .mandala-node { width: 60px; height: 60px; border-radius: 50%; background: #444; border: 2px solid #666; display: flex; justify-content: center; align-items: center; font-size: 24px; cursor: pointer; position: relative; }
        .mandala-node.unlocked { background: var(--karma-color); border-color: #fff; box-shadow: 0 0 15px var(--karma-color); color: #fff; }
        .mandala-node.can-buy { border-color: var(--accent-color); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
        /* æµ®éŠãƒ†ã‚­ã‚¹ãƒˆ */
        .float-text { position: absolute; font-weight: bold; pointer-events: none; animation: floatUp 1s forwards; text-shadow: 0 0 3px black; z-index: 200; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-50px); opacity: 0; } }

        textarea { width: 100%; height: 60px; background: #333; color: #fff; border: 1px solid #555; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="left-panel" class="panel">
    <div style="margin-bottom: 20px;">
        <div id="toku-display">0 å¾³</div>
        <div id="tps-display" style="font-size: 0.9em; color: #888;">æ¯ç§’: 0 å¾³</div>
        <div id="karma-display">æ¥­: 0</div>
    </div>

    <div id="mokugyo-wrapper" onmousedown="clickMokugyo(event)">
        <div id="mokugyo-img">æœ¨é­š</div>
    </div>

    <div style="flex-grow:1"></div>
    
    <div style="font-size: 0.8em; color: #666;">
        <button class="btn" onclick="saveGame(true)">è¨˜éŒ² (Save)</button>
        <button class="btn" onclick="openModal('settings-modal')">è¨­å®š (Menu)</button>
        <button class="btn btn-danger" onclick="openModal('prestige-modal')">è¼ªå»» (Prestige)</button>
    </div>
</div>

<div id="center-panel">
    <div id="news-ticker" onclick="clickNews()">
        <span id="news-text">ãƒ‹ãƒ¥ãƒ¼ã‚¹: èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>
    
    <div id="visual-area">
        <h1 style="opacity: 0.3; margin-top: 50px;">ãƒ‹ãƒ«ãƒ´ã‚¡ãƒ¼ãƒŠãƒ»ã‚¯ãƒªãƒƒã‚«ãƒ¼ <span style="font-size:0.5em">Ver2.0</span></h1>
        <div id="message-log"></div>
    </div>

    <div id="falling-item" class="falling-item" onclick="clickFallingItem()"></div>
</div>

<div id="right-panel" class="panel">
    <div id="tabs">
        <div class="tab active" onclick="switchTab('facilities')">ä¼½è—</div>
        <div class="tab" onclick="switchTab('upgrades')">çµŒå…¸</div>
        <div class="tab" onclick="switchTab('garden')">æ¯å±±æ°´</div>
        <div class="tab" onclick="switchTab('artifacts')">ç§˜å®</div>
    </div>
    
    <div id="store-container">
        </div>
</div>

<div id="settings-modal" class="modal">
    <div class="modal-content">
        <h2>è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
        <button class="btn" onclick="toggleMute()">éŸ³é‡ ON/OFF</button>
        <hr style="border-color: #444;">
        <h3>ãƒ‡ãƒ¼ã‚¿ã®å‘ªæ–‡ (Import/Export)</h3>
        <textarea id="save-string" placeholder="ã“ã“ã«å‘ªæ–‡ï¼ˆã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ï¼‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
        <div>
            <button class="btn" onclick="exportSave()">å‘ªæ–‡ã‚’å”±ãˆã‚‹ (Export)</button>
            <button class="btn btn-danger" onclick="importSave()">å‘ªæ–‡ã‚’èã (Import)</button>
        </div>
        <hr style="border-color: #444;">
        <button class="btn btn-danger" onclick="hardReset()">å®Œå…¨åˆæœŸåŒ–</button>
        <br><br>
        <button class="btn" onclick="closeModal('settings-modal')">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="prestige-modal" class="modal">
    <div class="modal-content">
        <h2 style="color: var(--karma-color)">è¼ªå»»è»¢ç”Ÿ (Prestige)</h2>
        <p>ç¾ä¸–ã®å¾³ã‚’æ¨ã¦ã€ã€Œæ¥­(Karma)ã€ã‚’å¾—ã¦ç”Ÿã¾ã‚Œå¤‰ã‚ã‚Šã¾ã™ã€‚<br>
           ç²å¾—äºˆå®šã®æ¥­: <span id="prestige-gain" style="font-size:1.5em; font-weight:bold;">0</span></p>
        
        <h3>æ›¼è¼ç¾…ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼</h3>
        <div id="mandala-container">
            </div>
        <div id="skill-desc" style="height: 40px; color: #ccc; font-size: 12px; margin-bottom: 10px;">ã‚¹ã‚­ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>

        <button class="btn btn-danger" style="width: 80%; padding: 15px;" onclick="doPrestige()">è»¢ç”Ÿã‚’å®Ÿè¡Œã™ã‚‹</button>
        <br><br>
        <button class="btn" onclick="closeModal('prestige-modal')">ä»Šã¯ã‚„ã‚ã‚‹</button>
    </div>
</div>

<div id="offline-modal" class="modal">
    <div class="modal-content">
        <h2>ç‘æƒ³ã®æˆæœ</h2>
        <p>ã‚ãªãŸãŒã„ãªã„é–“ã€å¼Ÿå­ãŸã¡ãŒå¾³ã‚’ç©ã¿ã¾ã—ãŸã€‚</p>
        <h3 id="offline-gain-text" style="color: var(--accent-color)">0 å¾³</h3>
        <button class="btn" onclick="closeModal('offline-modal')">å—ã‘å–ã‚‹</button>
    </div>
</div>

<script>
    // ==========================================
    //  ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å®šç¾©
    // ==========================================
    const units = ["", "ä¸‡", "å„„", "å…†", "äº¬", "å“", "ğ¥±", "ç©£", "æº", "æ¾—", "æ­£", "è¼‰", "æ¥µ", "æ’æ²³æ²™", "é˜¿åƒ§ç¥‡", "é‚£ç”±ä»–", "ä¸å¯æ€è­°", "ç„¡é‡å¤§æ•°", "æ¶…æ§ƒ"];

    const facilityData = [
        { id: 0, name: "å°åŠä¸»", desc: "ãƒã‚¯ãƒã‚¯å©ãã€‚", baseCost: 15, baseProd: 1, icon: "ğŸ‘¶" },
        { id: 1, name: "å†™çµŒãƒ­ãƒœ", desc: "è‡ªå‹•åŒ–ã•ã‚ŒãŸä¿¡ä»°ã€‚", baseCost: 100, baseProd: 5, icon: "ğŸ¤–" },
        { id: 2, name: "é«˜åƒ§", desc: "æ³•åŠ›ãŒé«˜ã„ã€‚", baseCost: 1100, baseProd: 20, icon: "ğŸ™" },
        { id: 3, name: "åƒæ‰‹è¦³éŸ³", desc: "åœ§å€’çš„æ‰‹æ•°ã€‚", baseCost: 12000, baseProd: 100, icon: "ğŸ–ï¸" },
        { id: 4, name: "äº”é‡å¡”ãƒ­ã‚±ãƒƒãƒˆ", desc: "å®‡å®™ã¸ã€‚", baseCost: 130000, baseProd: 500, icon: "ğŸš€" },
        { id: 5, name: "é˜¿ä¿®ç¾…è»å›£", desc: "é—˜äº‰çš„å¸ƒæ•™ã€‚", baseCost: 1400000, baseProd: 2500, icon: "ğŸ‘¹" },
        { id: 6, name: "ã‚µã‚¤ãƒãƒ¼æ›¼è¼ç¾…", desc: "é›»è„³æµ„åœŸã€‚", baseCost: 20000000, baseProd: 12000, icon: "ğŸŒ" },
        { id: 7, name: "éŠ€æ²³å¤§ä»", desc: "æ˜Ÿã‚’ç¶™ãã‚‚ã®ã€‚", baseCost: 330000000, baseProd: 60000, icon: "ğŸŒŒ" }
    ];

    const upgradeData = [
        { id: "c1", name: "ç¡¬ã„ãƒãƒ", desc: "ã‚¯ãƒªãƒƒã‚¯2å€", cost: 500, type: "click", val: 2, req: g => g.clickCount >= 100 },
        { id: "f1", name: "ã‚¨ãƒŠãƒ‰ãƒª", desc: "å°åŠä¸»2å€", cost: 1000, type: "facility", target: 0, val: 2, req: g => g.facilities[0] >= 10 },
        { id: "g1", name: "é»„é‡‘ã®èŒ¶å®¤", desc: "å…¨ä½“1.2å€", cost: 50000, type: "global", val: 1.2, req: g => g.totalToku >= 10000 },
        { id: "mappo", name: "ç¦æ–­ã®çµŒå…¸", desc: "ã€è­¦å‘Šã€‘ä¸–ç•ŒãŒå¤‰ã‚ã‚Šã¾ã™ã€‚é‚ªé¬¼ãŒå‡ºç¾ã€‚", cost: 666666, type: "event", req: g => g.totalToku >= 500000 },
        { id: "c2", name: "æŒ‡ã®ç­‹ãƒˆãƒ¬", desc: "ã‚¯ãƒªãƒƒã‚¯5å€", cost: 1000000, type: "click", val: 5, req: g => g.clickCount >= 1000 },
        { id: "zen", name: "åº­å¸«ã®å¿ƒå¾—", desc: "ã€Œæ¯å±±æ°´ã€ã‚’è§£ç¦ã€‚", cost: 2000000, type: "unlock_garden", req: g => g.totalToku >= 1000000 },
    ];

    const mandalaSkills = [
        { id: "k1", name: "æ¥ä¸–ã®è¨˜æ†¶", desc: "è»¢ç”Ÿæ™‚ã€å°åŠä¸»ã®æ•°ã‚’ç¶­æŒã™ã‚‹", cost: 1, icon: "ğŸ§ " },
        { id: "k2", name: "ç¬¬ä¸‰ã®ç›®", desc: "ç§˜å®ã®ãƒ‰ãƒ­ãƒƒãƒ—ç‡ 2å€", cost: 3, icon: "ğŸ‘ï¸" },
        { id: "k3", name: "ä¸å‹•å¿ƒ", desc: "æœ«æ³•ãƒ¢ãƒ¼ãƒ‰ã§ã®ã€Œå¾³æ²¡åã€ã‚’é˜²ã", cost: 5, icon: "ğŸ›¡ï¸" },
        { id: "k4", name: "é˜¿é ¼è€¶è­˜", desc: "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³é€²è¡ŒåŠ¹ç‡ 100%", cost: 10, icon: "ğŸ’¾" },
        { id: "k5", name: "è§£è„±", desc: "å…¨ä½“ç”Ÿç”£é‡ 5å€", cost: 50, icon: "â˜¸ï¸" }
    ];

    const artifacts = [
        { id: 0, name: "ä»ã®ç™½æ¯«", desc: "ã‚¯ãƒªãƒƒã‚¯+50%", chance: 0.001, icon: "âšª" },
        { id: 1, name: "ä¸‰è”µã®é´", desc: "å…¨ä½“+20%", chance: 0.0005, icon: "ğŸ‘" },
        { id: 2, name: "è“®ã®ç¨®", desc: "æ¯å±±æ°´ã‚³ã‚¹ãƒˆåŠæ¸›", chance: 0.0008, icon: "ğŸŒ°" },
        { id: 3, name: "å£Šã‚ŒãŸé˜", desc: "æœ«æ³•ãƒœãƒ¼ãƒŠã‚¹+50%", chance: 0.002, icon: "ğŸ””" } // æœ«æ³•é™å®š
    ];

    const gardenStones = ["ğŸª¨", "ğŸŒ²", "ğŸ®", "ğŸ¸"]; // å˜ç´”åŒ–: ãƒ©ãƒ³ãƒ€ãƒ é…ç½®

    // ==========================================
    //  ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†
    // ==========================================
    let game = {
        toku: 0,
        totalToku: 0,
        allTimeToku: 0,
        karma: 0,
        startTime: Date.now(),
        lastSaveTime: Date.now(),
        clickCount: 0,
        facilities: Array(facilityData.length).fill(0),
        upgrades: [],     // è³¼å…¥æ¸ˆã¿ID
        skills: [],       // ç¿’å¾—æ¸ˆã¿ã‚¹ã‚­ãƒ«ID
        artifacts: [],    // å…¥æ‰‹æ¸ˆã¿ç§˜å®ID
        garden: Array(9).fill(null), // æ¯å±±æ°´ã‚°ãƒªãƒƒãƒ‰
        mappoLevel: 0,    // 0:å¹³å’Œ, 1:æœ«æ³•
        settings: { muted: false }
    };

    let audioCtx = null;
    let fallingItemActive = false;
    let multipliers = { click: 1, global: 1, facilities: [] };
    let currentTab = 'facilities';

    // ==========================================
    //  åˆæœŸåŒ–ãƒ»ãƒ«ãƒ¼ãƒ—
    // ==========================================
    window.onload = () => {
        loadGame();
        setInterval(gameLoop, 100);
        setInterval(saveGame, 30000);
        setInterval(updateNews, 15000);
        setTimeout(scheduleFallingItem, 60000);
        updateVisuals();
    };

    function gameLoop() {
        // ç”Ÿç”£
        calcMultipliers();
        let tps = getTpS();
        if (tps > 0) addToku(tps / 10);

        // UIæ›´æ–°
        document.getElementById('toku-display').innerText = formatNumber(game.toku) + " å¾³";
        document.getElementById('tps-display').innerText = "æ¯ç§’: " + formatNumber(tps) + " å¾³";
        document.title = formatNumber(game.toku) + " å¾³ - ãƒ‹ãƒ«ãƒ´ã‚¡ãƒ¼ãƒŠ";
        
        // è³¼å…¥ãƒœã‚¿ãƒ³çŠ¶æ…‹ãªã©
        if(currentTab === 'facilities') renderFacilities(false); 
        // é‡ããªã‚‹ã®ã§DOMå…¨æ›¸ãæ›ãˆã¯ã—ãªã„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ¨å¥¨ã ãŒã€ä»Šå›ã¯ç°¡æ˜“å®Ÿè£…

        updateVisuals();
    }

    function calcMultipliers() {
        let m = { click: 1, global: 1, facilities: Array(facilityData.length).fill(1) };
        
        // 1. ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
        game.upgrades.forEach(uid => {
            let u = upgradeData.find(d => d.id === uid);
            if(u) {
                if(u.type === 'click') m.click *= u.val;
                if(u.type === 'global') m.global *= u.val;
                if(u.type === 'facility') m.facilities[u.target] *= u.val;
            }
        });

        // 2. ç§˜å®
        if(game.artifacts.includes(0)) m.click *= 1.5;
        if(game.artifacts.includes(1)) m.global *= 1.2;

        // 3. æ¯å±±æ°´ (ç°¡æ˜“: é…ç½®æ•° * 5%)
        let stones = game.garden.filter(x => x !== null).length;
        m.global *= (1 + stones * 0.05);

        // 4. ã‚«ãƒ«ãƒ
        m.global *= (1 + game.karma * 0.1); // 1Karma = +10%

        // 5. ã‚¹ã‚­ãƒ«
        if(game.skills.includes("k5")) m.global *= 5;

        multipliers = m;
    }

    function getTpS() {
        let tps = 0;
        game.facilities.forEach((count, i) => {
            tps += facilityData[i].baseProd * count * multipliers.facilities[i];
        });
        return tps * multipliers.global;
    }

    function addToku(n) {
        game.toku += n;
        game.totalToku += n;
        game.allTimeToku += n;
    }

    // ==========================================
    //  ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    // ==========================================
    function clickMokugyo(e) {
        initAudio();
        
        let power = (1 + getTpS() * 0.02) * multipliers.click;
        addToku(power);
        game.clickCount++;

        spawnFloatText(e.clientX, e.clientY, "+" + formatNumber(power));
        playSound('mokugyo');

        // ç§˜å®ãƒ‰ãƒ­ãƒƒãƒ—åˆ¤å®š
        checkArtifactDrop(false);
    }

    function buyFacility(idx) {
        let cost = getCost(idx);
        if(game.toku >= cost) {
            game.toku -= cost;
            game.facilities[idx]++;
            playSound('buy');
            renderFacilities();
        }
    }

    function getCost(idx) {
        return Math.floor(facilityData[idx].baseCost * Math.pow(1.15, game.facilities[idx]));
    }

    function buyUpgrade(uid) {
        let u = upgradeData.find(d => d.id === uid);
        if(game.toku >= u.cost && !game.upgrades.includes(uid)) {
            game.toku -= u.cost;
            game.upgrades.push(uid);
            
            // ç‰¹æ®ŠåŠ¹æœ
            if(u.type === 'event' && uid === 'mappo') {
                game.mappoLevel = 1;
                logMessage("ç¦æ–­ã®çµŒå…¸ãŒé–‹ã‹ã‚ŒãŸâ€¦â€¦ä¸–ç•ŒãŒæ­ªã¿å§‹ã‚ã‚‹ï¼");
                playSound('mappo_start');
            }
            if(u.type === 'unlock_garden') {
                logMessage("æ¯å±±æ°´ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸã€‚");
            }

            playSound('powerup');
            renderUpgrades();
        }
    }

    // ==========================================
    //  ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (æ¯å±±æ°´ãƒ»ç§˜å®)
    // ==========================================
    function buyGardenStone(idx) {
        if(game.garden[idx] !== null) return;
        let cost = 10000 * Math.pow(2, game.garden.filter(x=>x).length);
        if(game.skills.includes("k2")) cost /= 2; // ç§˜å®ã˜ã‚ƒãªãã¦ã‚¹ã‚­ãƒ«åŠ¹æœã«ã™ã‚‹ç­‰ã®èª¿æ•´å¯

        if(game.toku >= cost) {
            game.toku -= cost;
            game.garden[idx] = gardenStones[Math.floor(Math.random() * gardenStones.length)];
            playSound('stone');
            renderGarden();
        } else {
            alert("å¾³ãŒè¶³ã‚Šã¾ã›ã‚“: " + formatNumber(cost));
        }
    }

    function checkArtifactDrop(isMappoEvent) {
        // ãƒ‰ãƒ­ãƒƒãƒ—ç‡ã¯ã‚¹ã‚­ãƒ«ã§å¤‰å‹•
        let rateMod = game.skills.includes("k2") ? 2 : 1;
        
        artifacts.forEach(art => {
            if(!game.artifacts.includes(art.id)) {
                // æœ«æ³•é™å®šã‚¢ã‚¤ãƒ†ãƒ ã®åˆ¤å®š
                if(art.id === 3 && game.mappoLevel === 0) return;

                if(Math.random() < art.chance * rateMod) {
                    game.artifacts.push(art.id);
                    logMessage(`ã€ç§˜å®ç™ºè¦‹ã€‘${art.name} ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼`);
                    playSound('chime');
                    if(currentTab === 'artifacts') renderArtifacts();
                }
            }
        });
    }

    // ==========================================
    //  ã‚¤ãƒ™ãƒ³ãƒˆ (èœ˜è››ã®ç³¸ / é‚ªé¬¼)
    // ==========================================
    function scheduleFallingItem() {
        if(fallingItemActive) return;
        let time = Math.random() * 120000 + 60000; // 1~3åˆ†
        if(game.mappoLevel > 0) time /= 2; // æœ«æ³•æ™‚ã¯å‡ºç¾é »åº¦2å€

        setTimeout(() => {
            spawnFallingItem();
            scheduleFallingItem();
        }, time);
    }

    function spawnFallingItem() {
        fallingItemActive = true;
        let el = document.getElementById('falling-item');
        el.style.top = '-100px';
        el.style.display = 'block';

        // ç¨®é¡æ±ºå®š
        let isOni = game.mappoLevel > 0 && Math.random() > 0.3;
        el.innerText = isOni ? "ğŸ‘¹" : "ğŸ•¸ï¸";
        el.className = isOni ? "falling-item oni" : "falling-item";
        el.onclick = () => clickFallingItem(isOni);

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        setTimeout(() => { el.style.top = '200px'; }, 100);
        setTimeout(() => { 
            el.style.top = '120vh'; 
            setTimeout(() => { fallingItemActive = false; }, 1000);
        }, 8000);
    }

    function clickFallingItem(isOni) {
        if(!fallingItemActive) return;
        fallingItemActive = false;
        document.getElementById('falling-item').style.display = 'none';

        if(isOni) {
            // é‚ªé¬¼: 50%ã§æã€50%ã§å¾—
            if(Math.random() > 0.5 || game.skills.includes("k3")) {
                let bonus = getTpS() * 600; // 10åˆ†åˆ†
                addToku(bonus);
                logMessage(`é‚ªé¬¼ã‚’èª¿ä¼ã—ãŸï¼ +${formatNumber(bonus)} å¾³`);
                playSound('punch');
            } else {
                let lost = game.toku * 0.1;
                game.toku -= lost;
                logMessage(`é‚ªé¬¼ã«å¾³ã‚’å¥ªã‚ã‚ŒãŸ... -${formatNumber(lost)} å¾³`);
                playSound('damage');
            }
            checkArtifactDrop(true); // é‚ªé¬¼ã‹ã‚‰ã¯ãƒ‰ãƒ­ãƒƒãƒ—åˆ¤å®šã‚ã‚Š
        } else {
            // èœ˜è››ã®ç³¸
            let bonus = getTpS() * 300;
            if(bonus < game.toku * 0.1) bonus = game.toku * 0.1;
            addToku(bonus);
            logMessage(`èœ˜è››ã®ç³¸ã‚’ã¤ã‹ã‚“ã ï¼ +${formatNumber(bonus)} å¾³`);
            playSound('chime');
        }
    }

    // ==========================================
    //  UI ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    // ==========================================
    function switchTab(name) {
        currentTab = name;
        document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
        document.querySelector(`.tab[onclick="switchTab('${name}')"]`).classList.add('active');
        
        let container = document.getElementById('store-container');
        container.innerHTML = "";
        
        if(name === 'facilities') renderFacilities();
        if(name === 'upgrades') renderUpgrades();
        if(name === 'garden') renderGarden();
        if(name === 'artifacts') renderArtifacts();
    }

    function renderFacilities(full = true) {
        let container = document.getElementById('store-container');
        if(full) container.innerHTML = "";
        
        // ç°¡æ˜“æ›´æ–°ç”¨: æ—¢å­˜è¦ç´ ãŒã‚ã‚Œã°æ•°å€¤ã ã‘æ›´æ–°
        if(!full && container.children.length === facilityData.length) {
            facilityData.forEach((f, i) => {
                let div = container.children[i];
                let cost = getCost(i);
                if(game.toku >= cost) div.classList.remove('locked');
                else div.classList.add('locked');
                div.querySelector('.item-count').innerText = game.facilities[i];
                div.querySelector('.item-cost').innerText = "å¾³: " + formatNumber(cost);
            });
            return;
        }

        facilityData.forEach((f, i) => {
            let cost = getCost(i);
            let div = document.createElement('div');
            div.className = `item ${game.toku >= cost ? '' : 'locked'}`;
            div.onclick = () => buyFacility(i);
            div.innerHTML = `
                <div style="font-size:24px; text-align:center">${f.icon}</div>
                <div><h4>${f.name}</h4><p>${f.desc}</p><span class="item-cost">å¾³: ${formatNumber(cost)}</span></div>
                <div class="item-count" style="font-size:18px; font-weight:bold; color:#666">${game.facilities[i]}</div>
            `;
            container.appendChild(div);
        });
    }

    function renderUpgrades() {
        let container = document.getElementById('store-container');
        container.innerHTML = "";
        
        upgradeData.forEach(u => {
            if(!game.upgrades.includes(u.id) && u.req(game)) {
                let div = document.createElement('div');
                div.className = `item ${game.toku >= u.cost ? '' : 'locked'}`;
                div.onclick = () => buyUpgrade(u.id);
                div.innerHTML = `
                    <div style="font-size:24px;">ğŸ“œ</div>
                    <div><h4>${u.name}</h4><p>${u.desc}</p><span class="item-cost">å¾³: ${formatNumber(u.cost)}</span></div>
                `;
                container.appendChild(div);
            }
        });
        if(container.innerHTML === "") container.innerHTML = "<div style='padding:20px; text-align:center; color:#666'>ç¾åœ¨ç ”ç©¶ã§ãã‚‹çµŒå…¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>";
    }

    function renderGarden() {
        let container = document.getElementById('store-container');
        if(!game.upgrades.includes("zen")) {
            container.innerHTML = "<div style='padding:20px; text-align:center; color:#666'>ã€Œåº­å¸«ã®å¿ƒå¾—ã€ã‚’è³¼å…¥ã™ã‚‹ã¨è§£ç¦ã•ã‚Œã¾ã™ã€‚</div>";
            return;
        }
        
        container.innerHTML = "<div style='text-align:center; margin-bottom:10px'>çŸ³ã‚’é…ç½®ã—ã¦ç”Ÿç”£åŠ›UP (1ã¤é…ç½®ã”ã¨ã«ã‚³ã‚¹ãƒˆå¢—)</div>";
        let grid = document.createElement('div');
        grid.id = "garden-grid";
        
        game.garden.forEach((cell, i) => {
            let div = document.createElement('div');
            div.className = "garden-cell";
            div.innerText = cell || "";
            div.onclick = () => buyGardenStone(i);
            grid.appendChild(div);
        });
        container.appendChild(grid);
    }

    function renderArtifacts() {
        let container = document.getElementById('store-container');
        let grid = document.createElement('div');
        grid.id = "artifact-grid";
        
        artifacts.forEach(art => {
            let found = game.artifacts.includes(art.id);
            let div = document.createElement('div');
            div.className = `artifact-slot ${found ? 'found' : ''}`;
            div.innerText = found ? art.icon : "?";
            div.title = found ? `${art.name}: ${art.desc}` : "æœªç™ºè¦‹";
            grid.appendChild(div);
        });
        container.appendChild(grid);
    }

    function updateVisuals() {
        // èƒŒæ™¯é€²åŒ–
        let body = document.body;
        body.className = "";
        if(game.mappoLevel > 0) body.classList.add("mappo-mode");
        else {
            if(game.totalToku > 1e16) body.classList.add("bg-lv5");
            else if(game.totalToku > 1e12) body.classList.add("bg-lv4");
            else if(game.totalToku > 1e8) body.classList.add("bg-lv3");
            else if(game.totalToku > 10000) body.classList.add("bg-lv2");
            else body.classList.add("bg-lv1");
        }

        // æœ¨é­šé€²åŒ–
        let mk = document.getElementById('mokugyo-img');
        mk.className = "";
        if(game.mappoLevel > 0) mk.classList.add("mokugyo-mappo");
        else {
            if(game.totalToku > 1e14) mk.classList.add("mokugyo-lv4");
            else if(game.totalToku > 1e10) mk.classList.add("mokugyo-lv3");
            else if(game.totalToku > 1e6) mk.classList.add("mokugyo-lv2");
        }
        mk.innerText = game.mappoLevel > 0 ? "ğŸ‘¹" : (game.totalToku > 1e14 ? "â˜¸ï¸" : "æœ¨é­š");
    }

    function logMessage(msg) {
        let div = document.createElement('div');
        div.innerText = msg;
        document.getElementById('message-log').prepend(div);
    }

    function updateNews() {
        const headlines = [
            "åœ°ç„ã®é‡œã€ç‡ƒæ–™è²»é«˜é¨°ã§ã¬ã‚‹ã¾æ¹¯ã«ã€‚",
            "ä¸‰é€”ã®å·ã€é›»å­ãƒãƒãƒ¼å¯¾å¿œã‚’é–‹å§‹ã€‚",
            "ã‚«ãƒ³ãƒ€ã‚¿ã€èœ˜è››ã®ç³¸ã‚’åˆ‡ã£ãŸã®ã¯ã€Œäº‹æ•…ã€ã¨ä¸»å¼µã€‚",
            "ã€Œè‰²å³æ˜¯ç©ºã€ã®è§£é‡ˆã‚’å·¡ã‚ŠAIãŒãƒ•ãƒªãƒ¼ã‚ºã€‚",
            "ã‚ãªãŸã®ç…©æ‚©ãƒ¬ãƒ™ãƒ«ï¼šè¨ˆæ¸¬ä¸èƒ½",
            "å¤§ä»ãŒã‚¹ãƒˆãƒ¬ãƒƒãƒã‚’å§‹ã‚ã¾ã—ãŸã€‚",
        ];
        const mappoNews = [
            "ã€æ‚²å ±ã€‘é–»é­”å¤§ç‹ã€éåŠ´ã§ãƒ€ã‚¦ãƒ³ã€‚",
            "åœ°ç„ã®é¬¼ãŸã¡ãŒã‚¹ãƒˆãƒ©ã‚¤ã‚­æ±ºè¡Œã€‚",
            "ç©ºã‹ã‚‰è¡€ã®é›¨ãŒé™ã‚‹äºˆå ±ã§ã™ã€‚",
            "ä¸–ç•Œã®çµ‚ã‚ã‚ŠãŒè¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚",
        ];
        
        let list = game.mappoLevel > 0 ? mappoNews : headlines;
        document.getElementById('news-text').innerText = "NEWS: " + list[Math.floor(Math.random() * list.length)];
    }

    // ==========================================
    //  è»¢ç”Ÿ & ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼
    // ==========================================
    function openModal(id) {
        document.getElementById(id).classList.add('show');
        if(id === 'prestige-modal') updatePrestigeView();
    }
    function closeModal(id) { document.getElementById(id).classList.remove('show'); }

    function updatePrestigeView() {
        // è»¢ç”Ÿè¨ˆç®—: ç´¯ç©ã®3ä¹—æ ¹
        let pot = Math.floor(Math.cbrt(game.allTimeToku / 1000000));
        let gain = Math.max(0, pot - game.karma);
        document.getElementById('prestige-gain').innerText = formatNumber(gain);

        // ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼æç”»
        let container = document.getElementById('mandala-container');
        container.innerHTML = "";
        mandalaSkills.forEach(skill => {
            let owned = game.skills.includes(skill.id);
            let div = document.createElement('div');
            div.className = `mandala-node ${owned ? 'unlocked' : ''}`;
            if(!owned && game.karma >= skill.cost) div.classList.add('can-buy');
            
            div.innerText = skill.icon;
            div.onclick = () => buySkill(skill);
            div.onmouseenter = () => document.getElementById('skill-desc').innerText = `${skill.name}: ${skill.desc} (ã‚³ã‚¹ãƒˆ: ${skill.cost}æ¥­)`;
            container.appendChild(div);
        });
    }

    function buySkill(skill) {
        if(game.skills.includes(skill.id)) return;
        if(game.karma >= skill.cost) {
            if(confirm(`${skill.name} ã‚’ç¿’å¾—ã—ã¾ã™ã‹ï¼Ÿ (æ¥­ ${skill.cost} æ¶ˆè²»)`)) {
                game.karma -= skill.cost;
                game.skills.push(skill.id);
                playSound('powerup');
                updatePrestigeView();
            }
        } else {
            alert("æ¥­ãŒè¶³ã‚Šã¾ã›ã‚“");
        }
    }

    function doPrestige() {
        let pot = Math.floor(Math.cbrt(game.allTimeToku / 1000000));
        let gain = Math.max(0, pot - game.karma);
        if(gain <= 0 && !confirm("æ¥­ãŒå¢—ãˆã¾ã›ã‚“ãŒè»¢ç”Ÿã—ã¾ã™ã‹ï¼Ÿ")) return;

        game.karma += gain;
        
        // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
        game.toku = 0;
        game.totalToku = 0;
        game.clickCount = 0;
        game.upgrades = [];
        game.garden = Array(9).fill(null);
        game.mappoLevel = 0;
        // å°åŠä¸»ç¶­æŒã‚¹ã‚­ãƒ«
        let keepBozu = game.skills.includes("k1") ? game.facilities[0] : 0;
        game.facilities = Array(facilityData.length).fill(0);
        game.facilities[0] = keepBozu;
        
        saveGame();
        location.reload();
    }

    // ==========================================
    //  ã‚»ãƒ¼ãƒ–ãƒ»ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    // ==========================================
    function saveGame(manual) {
        game.lastSaveTime = Date.now();
        localStorage.setItem('nirvanaV2', JSON.stringify(game));
        if(manual) {
            let btn = document.querySelector('#left-panel .btn');
            let orig = btn.innerText;
            btn.innerText = "è¨˜éŒ²å®Œäº†!";
            setTimeout(()=> btn.innerText = orig, 1000);
        }
    }

    function loadGame() {
        let str = localStorage.getItem('nirvanaV2');
        if(str) {
            try {
                let d = JSON.parse(str);
                game = { ...game, ...d };
                // é…åˆ—é•·è£œæ­£
                if(game.facilities.length < facilityData.length) {
                    for(let i=0; i<facilityData.length - game.facilities.length; i++) game.facilities.push(0);
                }
                
                // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³è¨ˆç®—
                let sec = (Date.now() - game.lastSaveTime) / 1000;
                if(sec > 60) {
                    calcMultipliers();
                    let eff = game.skills.includes("k4") ? 1.0 : 0.5;
                    let gain = getTpS() * sec * eff;
                    if(gain > 0) {
                        addToku(gain);
                        document.getElementById('offline-gain-text').innerText = formatNumber(gain) + " å¾³";
                        openModal('offline-modal');
                    }
                }
            } catch(e) { console.error("Save broken", e); }
        }
        if(game.karma > 0) document.getElementById('karma-display').innerText = "æ¥­: " + formatNumber(game.karma);
        document.getElementById('karma-display').style.display = game.karma > 0 ? "block" : "none";
    }

    function exportSave() {
        let str = btoa(JSON.stringify(game));
        document.getElementById('save-string').value = str;
        alert("å‘ªæ–‡ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆæ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼‰");
        document.getElementById('save-string').select();
    }

    function importSave() {
        let str = document.getElementById('save-string').value;
        try {
            let json = atob(str);
            let d = JSON.parse(json);
            if(d.startTime) {
                game = d;
                saveGame();
                location.reload();
            } else throw "Invalid Data";
        } catch(e) {
            alert("å‘ªæ–‡ãŒé–“é•ã£ã¦ã„ã¾ã™");
        }
    }
    
    function hardReset() {
        if(confirm("æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem('nirvanaV2');
            location.reload();
        }
    }

    // ==========================================
    //  ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ==========================================
    function formatNumber(num) {
        if(num < 10000) return Math.floor(num).toLocaleString();
        let i = 0;
        while(num >= 10000 && i < units.length - 1) { num /= 10000; i++; }
        return num.toFixed(2) + units[i];
    }

    function spawnFloatText(x, y, text) {
        let el = document.createElement('div');
        el.className = 'float-text';
        el.innerText = text;
        el.style.left = x + 'px';
        el.style.top = (y - 50) + 'px';
        el.style.color = '#fff';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1000);
    }

    // éŸ³å£° (Web Audio API)
    function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }
    function toggleMute() { game.settings.muted = !game.settings.muted; alert(game.settings.muted ? "éŸ³å£°ã‚’æ¶ˆã—ã¾ã—ãŸ" : "éŸ³å£°ã‚’å‡ºã—ã¾ã™"); }
    function playSound(type) {
        if(game.settings.muted || !audioCtx) return;
        let t = audioCtx.currentTime;
        let osc = audioCtx.createOscillator();
        let gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        
        if(type === 'mokugyo') {
            osc.frequency.value = 300 + Math.random()*50;
            gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.5, t+0.02); gain.gain.exponentialRampToValueAtTime(0.01, t+0.15);
            osc.start(t); osc.stop(t+0.15);
        } else if(type === 'buy') {
            osc.frequency.value = 600; 
            gain.gain.setValueAtTime(0.1, t); gain.gain.exponentialRampToValueAtTime(0.01, t+0.1);
            osc.start(t); osc.stop(t+0.1);
        } else if(type === 'chime') {
            osc.type='sine'; osc.frequency.setValueAtTime(1000,t); osc.frequency.linearRampToValueAtTime(1500,t+0.5);
            gain.gain.setValueAtTime(0,t); gain.gain.linearRampToValueAtTime(0.2,t+0.1); gain.gain.linearRampToValueAtTime(0,t+1);
            osc.start(t); osc.stop(t+1);
        } else if(type === 'mappo_start') {
             osc.type='sawtooth'; osc.frequency.setValueAtTime(100,t); osc.frequency.linearRampToValueAtTime(50,t+2);
             gain.gain.setValueAtTime(0.3,t); gain.gain.linearRampToValueAtTime(0,t+2);
             osc.start(t); osc.stop(t+2);
        } else if(type === 'punch') {
            osc.type='square'; osc.frequency.setValueAtTime(150,t); osc.frequency.exponentialRampToValueAtTime(50,t+0.1);
            gain.gain.setValueAtTime(0.5,t); gain.gain.linearRampToValueAtTime(0,t+0.1);
            osc.start(t); osc.stop(t+0.1);
        }
    }

</script>
</body>
</html>
