<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第九曼荼羅 - The 9th Mandala (Ver.Inf)</title>
    <style>
        :root {
            --theme-color: #6a0dad;
            --theme-glow: rgba(106, 13, 173, 0.5);
            --bg-black: #020202;
            --text-gold: #d4af37;
            --card-bg: rgba(20, 20, 20, 0.9);
        }

        body {
            background-color: var(--bg-black);
            background-image: radial-gradient(circle at center, rgba(0,0,0,0) 0%, var(--bg-black) 90%),
                              radial-gradient(circle at center, var(--theme-glow) 0%, transparent 60%);
            color: var(--text-gold);
            font-family: 'Yu Mincho', 'MS Mincho', serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            user-select: none;
            transition: color 1s ease, background-image 1s ease;
        }

        /* レイアウト */
        .container {
            width: 100%;
            max-width: 800px;
            padding: 20px;
            box-sizing: border-box;
            padding-bottom: 80px;
        }

        /* ヘッダー */
        #header {
            text-align: center;
            margin-bottom: 30px;
            position: sticky;
            top: 0;
            background: rgba(2, 2, 2, 0.9);
            padding: 10px 0;
            z-index: 20;
            border-bottom: 1px solid var(--theme-color);
            backdrop-filter: blur(5px);
        }

        h1 { font-size: 1.8rem; letter-spacing: 0.2rem; margin: 0; text-shadow: 0 0 10px var(--theme-glow); }
        
        .stats-main {
            font-size: 2.2rem;
            font-weight: bold;
            font-family: 'Times New Roman', serif;
            margin: 5px 0;
            color: #fff;
            text-shadow: 0 0 5px var(--theme-color);
        }
        
        .sub-stats { font-size: 0.9rem; color: #ccc; }

        /* 曼荼羅エリア */
        #mandala-wrapper {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        #mandala-stage {
            position: relative;
            width: 300px;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .mandala-layer {
            position: absolute;
            border: 2px solid var(--theme-color);
            border-radius: 50%;
            opacity: 0.8;
            box-shadow: 0 0 15px var(--theme-glow);
            transition: all 1s ease;
        }

        #layer1 { width: 280px; height: 280px; border-style: double; border-width: 4px; animation: rotate 60s linear infinite; }
        #layer2 { width: 210px; height: 210px; border-style: dashed; animation: rotate 45s linear infinite reverse; }
        #layer3 { width: 140px; height: 140px; border-style: dotted; border-width: 3px; animation: rotate 30s linear infinite; }
        
        #core {
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, var(--theme-color) 30%, transparent 80%);
            border: 1px solid var(--theme-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            text-shadow: 0 0 5px var(--theme-color);
            font-weight: bold;
            font-size: 2.5rem;
            z-index: 5;
            box-shadow: 0 0 40px var(--theme-glow);
            transition: all 0.2s ease;
        }

        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .virtue-pop {
            position: absolute;
            color: #fff;
            font-weight: bold;
            pointer-events: none;
            animation: riseFade 0.8s ease-out forwards;
            z-index: 100;
            text-shadow: 0 0 3px #000;
            white-space: nowrap;
        }
        @keyframes riseFade { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-40px); } }

        /* ショップUI */
        .shop-section { margin-bottom: 30px; }
        .shop-title {
            font-size: 1.2rem;
            border-bottom: 1px solid var(--text-gold);
            margin-bottom: 15px;
            padding-bottom: 5px;
            color: #fff;
        }
        
        .shop-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        @media (min-width: 700px) { .shop-grid { grid-template-columns: 1fr 1fr; } }

        .item-card {
            background: var(--card-bg);
            border: 1px solid #444;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.2s;
            position: relative;
            overflow: hidden;
        }
        .item-card:hover { border-color: var(--text-gold); background: rgba(40, 40, 40, 0.95); }

        .item-info { display: flex; flex-direction: column; text-align: left; flex: 1; padding-right: 10px; }
        .item-name { font-weight: bold; color: var(--text-gold); font-size: 1.05rem; }
        .item-effect { font-size: 0.85rem; color: #aaa; margin: 2px 0; }
        .item-count { font-size: 0.8rem; color: #fff; opacity: 0.7; }

        .buy-btn {
            background: linear-gradient(to bottom, #333, #222);
            color: #fff;
            border: 1px solid #555;
            padding: 10px 15px;
            cursor: pointer;
            font-family: 'Times New Roman', serif;
            min-width: 110px;
            text-align: right;
            border-radius: 4px;
        }
        .buy-btn:hover:not(:disabled) { background: linear-gradient(to bottom, var(--theme-color), #222); border-color: #fff; }
        .buy-btn:disabled { color: #555; border-color: #222; background: #111; cursor: not-allowed; }
        .buy-btn small { display: block; font-size: 0.7rem; opacity: 0.8; }

        /* 解脱UI */
        #liberation-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            color: #000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 2s ease forwards;
        }
        #prestige-btn {
            padding: 15px 40px; font-size: 1.5rem; border: 2px solid #000;
            background: transparent; cursor: pointer; transition: 0.3s;
        }
        #prestige-btn:hover { background: #000; color: #fff; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body oncontextmenu="return false;">

    <div class="container">
        <div id="header">
            <h1 id="rank-name">第零曼荼羅：無明</h1>
            <div class="stats-main" id="virtue-display">0</div>
            <div class="sub-stats">
                <span id="ips-display">0</span> ips<br>
                カルマ: <span id="karma-display" style="color: #ff4500; font-weight:bold;">0</span> 
                (生産力 +<span id="karma-bonus">0</span>%)
            </div>
        </div>

        <div id="mandala-wrapper">
            <div id="mandala-stage" onclick="clickMandala(event)">
                <div id="layer1" class="mandala-layer"></div>
                <div id="layer2" class="mandala-layer"></div>
                <div id="layer3" class="mandala-layer"></div>
                <div id="core">唵</div>
            </div>
        </div>

        <div class="shop-section">
            <div class="shop-title">僧侶と諸天 (自動生産)</div>
            <div class="shop-grid" id="unit-shop"></div>
        </div>

        <div class="shop-section">
            <div class="shop-title">経典と秘宝 (生産倍率)</div>
            <div class="shop-grid" id="upgrade-shop"></div>
        </div>
    </div>

    <div id="liberation-overlay">
        <div style="font-size: 4rem; font-weight: bold; margin-bottom: 30px; letter-spacing: 1rem;">解放</div>
        <div style="font-size: 1.2rem; margin-bottom: 30px;">
            今生での徳の合計: <span id="total-virtue-end">0</span><br>
            獲得カルマ: <span id="pending-karma" style="font-weight:bold; font-size:1.5rem;">0</span>
        </div>
        <button id="prestige-btn" onclick="doPrestige()">輪廻転生</button>
    </div>

    <script>
        // --- 巨大数単位フォーマッター ---
        function formatVirtue(num) {
            if (num < 10000) return Math.floor(num).toLocaleString();
            
            // 仏教・日本の単位
            const units = ["", "万", "億", "兆", "京", "垓", "𥝱", "穣", "溝", "澗", "正", "載", "極", "恒河沙", "阿僧祇", "那由他", "不可思議", "無量大数"];
            
            let unitIndex = 0;
            let tempNum = num;
            while (tempNum >= 10000 && unitIndex < units.length - 1) {
                tempNum /= 10000;
                unitIndex++;
            }
            
            // 小数点第2位まで表示 (例: 1.25京)
            return tempNum.toFixed(2) + units[unitIndex];
        }

        // --- データ定義 ---
        
        // 10^10 = 100億
        // 10^12 = 1兆
        // 10^14 = 100兆
        // 10^16 = 1京

        const unitData = [
            { name: "修行僧", rate: 1, cost: 15 },
            { name: "東の若僧", rate: 70, cost: 1500 },
            { name: "南の僧侶", rate: 300, cost: 8000 },
            { name: "南の高僧", rate: 40000, cost: 2000000 },
            { name: "西の老僧", rate: 2000000, cost: 150000000 },
            { name: "北の天才", rate: 800000000, cost: 50000000000 },
            // 新規追加
            { name: "無名天", rate: 10000000000, cost: 3000000000000 }, // +100億 (Cost 3兆)
            { name: "怒れる明王", rate: 1000000000000, cost: 500000000000000 }, // +1兆 (Cost 500兆)
            { name: "慈愛の菩薩", rate: 100000000000000, cost: 80000000000000000 }, // +100兆 (Cost 8京)
            { name: "圧巻の如来", rate: 10000000000000000, cost: 9000000000000000000 } // +1京 (Cost 900京)
        ];

        const upgradeData = [
            { name: "弟子の写経", mult: 1.01, cost: 500 },
            { name: "中品質の写経", mult: 1.05, cost: 50000 },
            { name: "完璧な写経", mult: 1.08, cost: 10000000 },
            // 新規追加
            { name: "唐の経典", mult: 1.09, cost: 500000000 }, // 5億
            { name: "天竺の経典", mult: 1.10, cost: 200000000000 }, // 2000億
            { name: "聖人のミイラ", mult: 1.20, cost: 100000000000000 } // 100兆
        ];

        const rankNames = [
            { name: "第零曼荼羅：無明", color: "#6a0dad" },
            { name: "第一曼荼羅：胎蔵界", color: "#4b0082" },
            { name: "第二曼荼羅：金剛界", color: "#0000ff" },
            { name: "第三曼荼羅：阿弥陀", color: "#008000" },
            { name: "第四曼荼羅：蓮華", color: "#adff2f" },
            { name: "第五曼荼羅：虚空", color: "#ffff00" },
            { name: "第六曼荼羅：寂静", color: "#ffd700" },
            { name: "第七曼荼羅：遍照", color: "#ffa500" },
            { name: "第八曼荼羅：解脱", color: "#ff4500" },
            { name: "第九曼荼羅：不可説不可説転", color: "#ff0000" }
        ];

        let game = {
            virtue: 0,
            totalVirtue: 0,
            karma: 0,
            rank: 0,
            units: new Array(unitData.length).fill(0),
            upgrades: new Array(upgradeData.length).fill(0)
        };

        // --- 初期化 ---
        function init() {
            createShopUI();
            updateDisplay();
            gameLoop();
        }

        function createShopUI() {
            const uShop = document.getElementById('unit-shop');
            unitData.forEach((u, i) => {
                uShop.innerHTML += `
                    <div class="item-card">
                        <div class="item-info">
                            <span class="item-name">${u.name}</span>
                            <span class="item-effect">+${formatVirtue(u.rate)} /sec</span>
                            <span class="item-count" id="u-cnt-${i}">所持: 0</span>
                        </div>
                        <button class="buy-btn" id="u-btn-${i}" onclick="buyUnit(${i})">
                            <small>徳を捧げる</small>
                            <span id="u-cost-${i}">-</span>
                        </button>
                    </div>`;
            });

            const upShop = document.getElementById('upgrade-shop');
            upgradeData.forEach((u, i) => {
                upShop.innerHTML += `
                    <div class="item-card">
                        <div class="item-info">
                            <span class="item-name">${u.name}</span>
                            <span class="item-effect">生産量 ${Math.round((u.mult-1)*100)}% UP</span>
                            <span class="item-count" id="up-cnt-${i}">所持: 0</span>
                        </div>
                        <button class="buy-btn" id="up-btn-${i}" onclick="buyUpgrade(${i})">
                            <small>徳を捧げる</small>
                            <span id="up-cost-${i}">-</span>
                        </button>
                    </div>`;
            });
        }

        // --- 計算ロジック ---
        function calculateIPS() {
            let base = 0;
            unitData.forEach((u, i) => {
                base += u.rate * game.units[i];
            });
            
            let mult = 1;
            upgradeData.forEach((u, i) => {
                mult *= Math.pow(u.mult, game.upgrades[i]);
            });

            // カルマボーナス
            let karmaBonus = 1 + (game.karma * 0.1); 
            
            return base * mult * karmaBonus;
        }

        function clickMandala(e) {
            // クリック威力: 最低1、またはIPSの3%
            const ips = calculateIPS();
            const power = 1 + (ips * 0.03);
            
            addVirtue(power);

            // 演出
            const pop = document.createElement('div');
            pop.className = 'virtue-pop';
            pop.innerText = `+${formatVirtue(power)}`;
            pop.style.left = `${e.clientX}px`;
            pop.style.top = `${e.clientY}px`;
            document.body.appendChild(pop);
            setTimeout(() => pop.remove(), 800);

            const core = document.getElementById('core');
            core.style.transform = 'scale(1.1)';
            setTimeout(() => core.style.transform = 'scale(1)', 100);
        }

        function addVirtue(amount) {
            if (game.rank >= 9) return;
            game.virtue += amount;
            game.totalVirtue += amount;

            // ランクアップ: 100^(rank+1)
            let threshold = Math.pow(100, game.rank + 1);
            
            // ランク9への到達は非常に困難にする
            if (game.rank === 8) {
                // 第八から第九へは特別に閾値を上げる（10^20など）
                // 通常計算だと 100^9 = 10^18 (100京)。
                // 圧巻の如来(1京)がいれば100秒で終わってしまうため、少し難易度調整
                threshold = 1000 * Math.pow(100, 9); // 1000倍の難易度
            }

            if (game.virtue >= threshold && game.rank < 9) {
                game.rank++;
                applyRankTheme(game.rank);
                if (game.rank === 9) triggerLiberation();
            }
        }

        function buyUnit(i) {
            const u = unitData[i];
            const cost = Math.floor(u.cost * Math.pow(1.15, game.units[i]));
            if (game.virtue >= cost) {
                game.virtue -= cost;
                game.units[i]++;
                updateDisplay();
            }
        }

        function buyUpgrade(i) {
            const u = upgradeData[i];
            // 倍率アイテムはコストが激増する(1.8倍ずつ)
            const cost = Math.floor(u.cost * Math.pow(1.8, game.upgrades[i]));
            if (game.virtue >= cost) {
                game.virtue -= cost;
                game.upgrades[i]++;
                updateDisplay();
            }
        }

        function updateDisplay() {
            if (game.rank >= 9) return;

            document.getElementById('virtue-display').innerText = formatVirtue(game.virtue);
            document.getElementById('ips-display').innerText = formatVirtue(calculateIPS());
            document.getElementById('karma-display').innerText = formatVirtue(game.karma);
            document.getElementById('karma-bonus').innerText = formatVirtue(game.karma * 10);

            // ユニットボタン更新
            unitData.forEach((u, i) => {
                const cost = Math.floor(u.cost * Math.pow(1.15, game.units[i]));
                const btn = document.getElementById(`u-btn-${i}`);
                document.getElementById(`u-cost-${i}`).innerText = formatVirtue(cost);
                document.getElementById(`u-cnt-${i}`).innerText = `所持: ${game.units[i]}`;
                btn.disabled = game.virtue < cost;
            });

            // アップグレードボタン更新
            upgradeData.forEach((u, i) => {
                const cost = Math.floor(u.cost * Math.pow(1.8, game.upgrades[i]));
                const btn = document.getElementById(`up-btn-${i}`);
                document.getElementById(`up-cost-${i}`).innerText = formatVirtue(cost);
                document.getElementById(`up-cnt-${i}`).innerText = `所持: ${game.upgrades[i]}`;
                btn.disabled = game.virtue < cost;
            });
        }

        function applyRankTheme(r) {
            const data = rankNames[r];
            document.getElementById('rank-name').innerText = data.name;
            const root = document.documentElement;
            root.style.setProperty('--theme-color', data.color);
            root.style.setProperty('--theme-glow', data.color + "80");
            
            // 回転速度
            const speed = 60 / (r + 1);
            document.getElementById('layer1').style.animationDuration = speed + "s";
            document.getElementById('layer2').style.animationDuration = (speed * 0.7) + "s";
        }

        function triggerLiberation() {
            const overlay = document.getElementById('liberation-overlay');
            // カルマ計算: (総徳 / 1兆)の平方根
            const pending = Math.floor(Math.sqrt(game.totalVirtue / 1000000000000));
            
            document.getElementById('total-virtue-end').innerText = formatVirtue(game.totalVirtue);
            document.getElementById('pending-karma').innerText = formatVirtue(pending);
            overlay.style.display = 'flex';
        }

        function doPrestige() {
            const earned = Math.floor(Math.sqrt(game.totalVirtue / 1000000000000));
            game.karma += earned;
            
            // リセット
            game.virtue = 0;
            game.totalVirtue = 0;
            game.rank = 0;
            game.units.fill(0);
            game.upgrades.fill(0);

            document.getElementById('liberation-overlay').style.display = 'none';
            applyRankTheme(0);
            updateDisplay();
        }

        let lastTime = Date.now();
        function gameLoop() {
            const now = Date.now();
            const dt = (now - lastTime) / 1000;
            lastTime = now;

            if (game.rank < 9) {
                const ips = calculateIPS();
                if (ips > 0) addVirtue(ips * dt);
                updateDisplay();
            }
            requestAnimationFrame(gameLoop);
        }

        init();
    </script>
</body>
</html>
