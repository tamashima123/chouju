<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éã„É´„É¥„Ç°„Éº„Éä„Éª„ÇØ„É™„ÉÉ„Ç´„Éº Ver2.3</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-color-rgb: 42, 42, 42;
            --text-color: #e0e0e0;
            --accent-color: #d4af37; /* Gold */
            --red-accent: #b22222;   /* Mappo Red */
            --karma-color: #9370db;  /* Purple */
            --mappo-bg: #2b0000;
        }

        body {
            font-family: 'Hiragino Mincho ProN', 'Yu Mincho', serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            display: grid; grid-template-columns: 340px 1fr 400px;
            user-select: none; transition: background 1s ease;
        }

        /* --- ËÉåÊôØÈÄ≤Âåñ --- */
        body.bg-lv1 { background: #1a1a1a; }
        body.bg-lv2 { background: linear-gradient(to bottom, #2c3e50, #000000); }
        body.bg-lv3 { background: linear-gradient(to bottom, #d4af37 0%, #b8860b 100%); }
        body.bg-lv4 { background: radial-gradient(circle, #1a0b2e 0%, #000000 100%); }
        body.bg-lv5 { background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCIgdmlld0JveD0iMCAwIDQwIDQwIiBmaWxsLW9wYWNpdHk9IjAuMSIgZmlsbD0iI2ZmZiI+PGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMSIvPjwvc3ZnPg=='), linear-gradient(to bottom, #000022, #000000); }
        body.mappo-mode { background: var(--mappo-bg) !important; animation: tremor 0.5s infinite; }
        body.mappo-mode #center-panel { filter: sepia(100%) hue-rotate(-50deg) saturate(300%); }
        @keyframes tremor { 0% { transform: translate(0,0); } 50% { transform: translate(-1px,1px); } 100% { transform: translate(0,0); } }

        /* --- „Éë„Éç„É´ÂÖ±ÈÄö --- */
        .panel { padding: 15px; display: flex; flex-direction: column; z-index: 10; backdrop-filter: blur(2px); border-color: var(--accent-color); position: relative; }
        .btn { background: rgba(0,0,0,0.5); color: var(--accent-color); border: 1px solid var(--accent-color); padding: 5px 10px; margin: 2px; cursor: pointer; transition: 0.2s; font-family: inherit; font-size: 0.9em;}
        .btn:hover { background: var(--accent-color); color: black; }
        .btn-danger { border-color: var(--red-accent); color: var(--red-accent); }
        .btn-danger:hover { background: var(--red-accent); color: white; }

        /* --- Â∑¶„Éë„Éç„É´ („Éû„Éà„É™„ÉÉ„ÇØ„ÇπËÉåÊôØ) --- */
        #left-panel {
            background-color: rgba(10, 10, 10, 0.85);
            border-right: 2px solid var(--accent-color);
            text-align: center; overflow: hidden;
        }
        #matrix-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; opacity: 0.2; pointer-events: none;
        }

        #toku-display { font-size: 2em; font-weight: bold; color: var(--accent-color); text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); margin-bottom: 5px; }
        #karma-display { color: var(--karma-color); font-weight: bold; display:none; }
        
        #mokugyo-wrapper { position: relative; margin: 30px auto; width: 220px; height: 220px; cursor: pointer; z-index: 20;}
        #mokugyo-img {
            width: 100%; height: 100%; border-radius: 50%;
            background: radial-gradient(circle, #8b4513 0%, #3e1e05 100%); border: 6px solid #d4af37;
            display: flex; justify-content: center; align-items: center;
            font-size: 80px; box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            transition: transform 0.05s;
        }
        #mokugyo-wrapper:active #mokugyo-img { transform: scale(0.95); }
        .mokugyo-mappo { border-color: #ff0000 !important; box-shadow: 0 0 50px red !important; background: #300 !important; color: red; }

        /* --- ‰∏≠Â§Æ„Éë„Éç„É´ (ÁôæÈ¨ºÂ§úË°å) --- */
        #center-panel { position: relative; display: flex; flex-direction: column; overflow: hidden; }
        #news-ticker { background: rgba(0,0,0,0.8); color: var(--accent-color); padding: 8px; white-space: nowrap; overflow: hidden; font-family: monospace; border-bottom: 1px solid var(--accent-color); cursor: pointer; z-index: 20;}
        
        /* ÁôæÈ¨ºÂ§úË°å„Ç≥„É≥„ÉÜ„Éä */
        #hyakki-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0; overflow: hidden;
            opacity: 0.6;
        }
        .hyakki-icon {
            position: absolute; font-size: 30px;
            animation: floatDrift linear infinite;
            will-change: transform;
        }
        @keyframes floatDrift {
            0% { transform: translate(-50px, 0) rotate(-5deg); opacity: 0; }
            10% { opacity: 1; }
            50% { transform: translate(50vw, -20px) rotate(5deg); }
            90% { opacity: 1; }
            100% { transform: translate(100vw, 0) rotate(-5deg); opacity: 0; }
        }

        #message-log { position: absolute; bottom: 20px; width: 100%; font-size: 12px; color: #aaa; text-align: center; height: 100px; overflow: hidden; display: flex; flex-direction: column-reverse; text-shadow: 1px 1px 2px black; z-index: 20; pointer-events: none;}
        
        .falling-item { position: absolute; top: -100px; left: 50%; cursor: pointer; z-index: 100; transition: top 0.5s; filter: drop-shadow(0 0 5px gold); font-size: 40px; }
        .falling-item.oni { filter: drop-shadow(0 0 10px red); font-size: 60px; }

        /* --- Âè≥„Éë„Éç„É´ --- */
        #right-panel { background-color: rgba(var(--panel-color-rgb), 0.95); border-left: 2px solid var(--accent-color); padding: 0; }
        #tabs { display: flex; background: #222; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; color: #666; font-size: 12px; border-bottom: 1px solid #444; }
        .tab.active { background: #333; color: var(--accent-color); font-weight: bold; border-bottom: 3px solid var(--accent-color); }
        #store-container { padding: 10px; overflow-y: auto; height: 100%; }
        .item { background: rgba(51,51,51,0.8); border: 1px solid #555; margin-bottom: 5px; padding: 8px; cursor: pointer; display: grid; grid-template-columns: 40px 1fr auto; gap: 10px; align-items: center; }
        .item:hover { background: #444; border-color: var(--accent-color); }
        .item.locked { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
        .item-cost { color: var(--accent-color); font-size: 11px; font-weight: bold; }

        /* --- „É¢„Éº„ÉÄ„É´ --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal.show { opacity: 1; pointer-events: auto; }
        .modal-content { background: #1a1a1a; border: 2px solid var(--accent-color); padding: 20px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; text-align: center; border-radius: 8px; box-shadow: 0 0 50px rgba(212, 175, 55, 0.2); }
        textarea { width: 100%; height: 80px; background: #333; color: #fff; border: 1px solid #555; margin-bottom: 10px; font-family: monospace; font-size: 0.8em; word-break: break-all;}

        /* „Åù„ÅÆ‰ªñ */
        .float-text { position: absolute; font-weight: bold; pointer-events: none; animation: floatUp 1s forwards; text-shadow: 0 0 3px black; z-index: 200; }
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-50px); opacity: 0; } }
    </style>
</head>
<body>

<div id="left-panel" class="panel">
    <canvas id="matrix-canvas"></canvas>
    
    <div style="margin-bottom: 20px; z-index: 20;">
        <div id="toku-display">0 Âæ≥</div>
        <div id="tps-display" style="font-size: 0.9em; color: #888;">ÊØéÁßí: 0 Âæ≥</div>
        <div id="karma-display">Ê•≠: 0</div>
    </div>

    <div id="mokugyo-wrapper" onmousedown="clickMokugyo(event)">
        <div id="mokugyo-img">Êú®È≠ö</div>
    </div>

    <div style="flex-grow:1"></div>
    <div style="font-size: 0.8em; z-index: 20;">
        <button class="btn" onclick="saveGame(true)">Ë®òÈå≤</button>
        <button class="btn" onclick="openModal('spell-modal')">Âë™Êñá</button>
        <button class="btn btn-danger" onclick="openModal('prestige-modal')">Ëº™Âªª</button>
    </div>
</div>

<div id="center-panel">
    <div id="news-ticker" onclick="clickNews()">News: „É≠„Éº„Éá„Ç£„É≥„Ç∞‰∏≠...</div>
    <div id="hyakki-container"></div>
    <div id="message-log"></div>
    <div id="falling-item" class="falling-item" onclick="clickFallingItem()"></div>
</div>

<div id="right-panel" class="panel">
    <div id="tabs">
        <div class="tab active" onclick="switchTab('facilities')">‰ºΩËóç</div>
        <div class="tab" onclick="switchTab('upgrades')">ÁµåÂÖ∏</div>
    </div>
    <div id="store-container"></div>
</div>

<div id="spell-modal" class="modal">
    <div class="modal-content">
        <h2>Âæ©Ê¥ª„ÅÆÂë™Êñá</h2>
        <p>„Çª„Éº„Éñ„Éá„Éº„Çø„ÅÆÊõ∏„ÅçÂá∫„Åó„ÉªË™≠„ÅøËæº„Åø„ÇíË°å„ÅÑ„Åæ„Åô„ÄÇ</p>
        <textarea id="save-string" placeholder="„Åì„Åì„Å´Âë™Êñá„ÇíË≤º„Çä‰ªò„Åë„Å¶ [Âë™Êñá„ÇíËÅû„Åè] „ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ" onfocus="this.select()"></textarea>
        <div>
            <button class="btn" onclick="exportSave()">Âë™Êñá„ÇíÂî±„Åà„Çã (Copy)</button>
            <button class="btn btn-danger" onclick="importSave()">Âë™Êñá„ÇíËÅû„Åè (Load)</button>
        </div>
        <hr style="border-color:#444">
        <button class="btn" onclick="closeModal('spell-modal')">Èñâ„Åò„Çã</button>
    </div>
</div>

<div id="prestige-modal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--karma-color)">Ëº™ÂªªËª¢Áîü</h2>
        <p>Âæ≥„ÇíÊç®„Å¶„ÄåÊ•≠„Äç„ÇíÂæó„Å¶Áîü„Åæ„ÇåÂ§â„Çè„Çä„Åæ„Åô„ÄÇ(Ê•≠1„Å§ = ÁîüÁî£+10%)<br>Áç≤Âæó‰∫àÂÆö: <span id="prestige-gain" style="font-weight:bold">0</span></p>
        <button class="btn btn-danger" onclick="doPrestige()">Ëª¢Áîü„Åô„Çã</button>
        <br><br><button class="btn" onclick="closeModal('prestige-modal')">„ÇÑ„ÇÅ„Çã</button>
    </div>
</div>

<script>
    // ==========================================
    //  „Ç≤„Éº„É†„Éá„Éº„ÇøÂÆöÁæ©
    // ==========================================
    const units = ["", "‰∏á", "ÂÑÑ", "ÂÖÜ", "‰∫¨", "Âûì", "•ù±", "Á©£", "Ê∫ù", "Êæó", "Ê≠£", "Ëºâ", "Ê•µ", "ÊÅíÊ≤≥Ê≤ô", "ÈòøÂÉßÁ•á", "ÈÇ£Áî±‰ªñ", "‰∏çÂèØÊÄùË≠∞", "ÁÑ°ÈáèÂ§ßÊï∞", "Ê∂ÖÊßÉ"];
    const facilityData = [
        { name: "Â∞èÂùä‰∏ª", baseCost: 15, baseProd: 1, icon: "üë∂" },
        { name: "ÂÜôÁµå„É≠„Éú", baseCost: 100, baseProd: 5, icon: "ü§ñ" },
        { name: "È´òÂÉß", baseCost: 1100, baseProd: 20, icon: "üôè" },
        { name: "ÂçÉÊâãË¶≥Èü≥", baseCost: 12000, baseProd: 100, icon: "üñêÔ∏è" },
        { name: "‰∫îÈáçÂ°î", baseCost: 130000, baseProd: 500, icon: "üöÄ" },
        { name: "Èòø‰øÆÁæÖ", baseCost: 1400000, baseProd: 2500, icon: "üëπ" },
        { name: "ÊõºËçºÁæÖ", baseCost: 20000000, baseProd: 12000, icon: "üåê" },
        { name: "Â§ß‰ªè", baseCost: 330000000, baseProd: 60000, icon: "üåå" }
    ];
    const upgradeData = [
        { id: "c1", name: "Á°¨„ÅÑ„Éê„ÉÅ", desc: "„ÇØ„É™„ÉÉ„ÇØ2ÂÄç", cost: 500, type: "click", val: 2, req: g => g.clickCount >= 100 },
        { id: "g1", name: "ÈªÑÈáëËå∂ÂÆ§", desc: "ÂÖ®‰Ωì1.5ÂÄç", cost: 50000, type: "global", val: 1.5, req: g => g.totalToku >= 10000 },
        { id: "mappo", name: "Á¶ÅÊñ≠„ÅÆÁµåÂÖ∏", desc: "Êú´Ê≥ï„É¢„Éº„ÉâÁ™ÅÂÖ•", cost: 666666, type: "event", req: g => g.totalToku >= 500000 }
    ];

    let game = {
        toku: 0, totalToku: 0, allTimeToku: 0, karma: 0,
        facilities: Array(facilityData.length).fill(0),
        upgrades: [], clickCount: 0, mappo: false,
        startTime: Date.now() // ‚òÖ‰øÆÊ≠£: ÈñãÂßãÊôÇÈñì„ÇíËøΩÂä†
    };
    let audioCtx = null;
    let multipliers = { click: 1, global: 1, facilities: [] };
    let currentTab = 'facilities';
    let fallingItemActive = false;

    // ==========================================
    //  ÂàùÊúüÂåñ & „É´„Éº„Éó
    // ==========================================
    window.onload = () => {
        loadGame(); calcMultipliers(); initMatrix();
        setInterval(gameLoop, 100);
        setInterval(() => saveGame(false), 30000);
        setInterval(updateHyakkiYagyo, 3000);
        setTimeout(scheduleFallingItem, 60000);
    };

    function gameLoop() {
        let tps = getTpS(); if(tps > 0) addToku(tps / 10);
        updateUI(tps);
    }

    function updateUI(tps) {
        document.getElementById('toku-display').innerText = formatNumber(game.toku) + " Âæ≥";
        document.getElementById('tps-display').innerText = "ÊØéÁßí: " + formatNumber(tps) + " Âæ≥";
        document.title = formatNumber(game.toku) + " Âæ≥ - „Éã„É´„É¥„Ç°„Éº„Éä";
        if(currentTab === 'facilities') renderFacilities(false);
        updateVisuals();
    }

    // ==========================================
    //  „Ç¢„ÇØ„Ç∑„Éß„É≥
    // ==========================================
    function clickMokugyo(e) {
        initAudio();
        let power = (1 + getTpS() * 0.02) * multipliers.click;
        addToku(power); game.clickCount++;
        spawnFloatText(e.clientX, e.clientY, "+" + formatNumber(power));
        playSound(game.mappo ? 'punch' : 'mokugyo');
    }
    function buyFacility(idx) {
        let cost = getCost(idx);
        if(game.toku >= cost) { game.toku -= cost; game.facilities[idx]++; playSound('buy'); renderFacilities(); calcMultipliers(); }
    }
    function buyUpgrade(uid) {
        let u = upgradeData.find(d => d.id === uid);
        if(game.toku >= u.cost && !game.upgrades.includes(uid)) {
            game.toku -= u.cost; game.upgrades.push(uid);
            if(u.id === 'mappo') { game.mappo = true; playSound('mappo'); logMessage("Êú´Ê≥ï„É¢„Éº„ÉâÁ™ÅÂÖ•ÔºÅ"); }
            playSound('powerup'); calcMultipliers(); renderUpgrades();
        }
    }
    function addToku(n) { game.toku += n; game.totalToku += n; game.allTimeToku += n; }
    function getTpS() {
        let tps = game.facilities.reduce((sum, count, i) => sum + facilityData[i].baseProd * count * multipliers.facilities[i], 0);
        return tps * multipliers.global * (1 + game.karma * 0.1);
    }
    function getCost(idx) { return Math.floor(facilityData[idx].baseCost * Math.pow(1.15, game.facilities[idx])); }
    function calcMultipliers() {
        multipliers = { click: 1, global: 1, facilities: Array(facilityData.length).fill(1) };
        game.upgrades.forEach(uid => {
            let u = upgradeData.find(d => d.id === uid);
            if(u.type === 'click') multipliers.click *= u.val;
            if(u.type === 'global') multipliers.global *= u.val;
        });
    }

    // ==========================================
    //  „Éì„Ç∏„É•„Ç¢„É´ÊºîÂá∫
    // ==========================================
    // Matrix
    let matrixCtx, matrixW, matrixH, matrixCols, matrixDrops;
    const matrixChars = "Ëâ≤Âç≥ÊòØÁ©∫Á©∫Âç≥ÊòØËâ≤Ëà¨Ëã•ÂøÉÁµåÂæ≥ÂñùÁæØË´¶ÂÉß‰ºΩËÄ∂Ëè©ÊèêËñ©Â©ÜË®∂".split("");
    function initMatrix() {
        const canvas = document.getElementById('matrix-canvas');
        matrixCtx = canvas.getContext('2d');
        matrixW = canvas.width = canvas.offsetWidth;
        matrixH = canvas.height = canvas.offsetHeight;
        matrixCols = Math.floor(matrixW / 20);
        matrixDrops = Array(matrixCols).fill(1);
        setInterval(drawMatrix, 50);
        window.addEventListener('resize', () => { matrixW=canvas.width=canvas.offsetWidth; matrixH=canvas.height=canvas.offsetHeight; });
    }
    function drawMatrix() {
        matrixCtx.fillStyle = game.mappo ? 'rgba(40, 0, 0, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        matrixCtx.fillRect(0, 0, matrixW, matrixH);
        matrixCtx.fillStyle = game.mappo ? '#ff3333' : '#00ff00';
        matrixCtx.font = '15px monospace';
        for(let i=0; i<matrixDrops.length; i++) {
            const text = matrixChars[Math.floor(Math.random()*matrixChars.length)];
            matrixCtx.fillText(text, i*20, matrixDrops[i]*20);
            if(matrixDrops[i]*20 > matrixH && Math.random() > 0.975) matrixDrops[i] = 0;
            matrixDrops[i]++;
        }
    }
    // Hyakki Yagyo
    function updateHyakkiYagyo() {
        const container = document.getElementById('hyakki-container');
        const totalFacilities = game.facilities.reduce((a,b)=>a+b, 0);
        if(container.children.length < 150 && totalFacilities > 0) {
            let rand = Math.random() * totalFacilities;
            let current = 0;
            let selectedFacility = facilityData[0];
            for(let i=0; i<game.facilities.length; i++) {
                current += game.facilities[i];
                if(rand < current) { selectedFacility = facilityData[i]; break; }
            }
            let el = document.createElement('div');
            el.className = 'hyakki-icon';
            el.innerText = selectedFacility.icon;
            el.style.top = Math.random() * 90 + '%';
            el.style.left = '-50px';
            el.style.animationDuration = (Math.random() * 20 + 15) + 's';
            el.style.fontSize = (Math.random() * 20 + 20) + 'px';
            container.appendChild(el);
            setTimeout(() => el.remove(), 35000);
        }
    }
    function updateVisuals() {
        document.body.className = game.mappo ? "mappo-mode" : (game.totalToku > 1e12 ? "bg-lv5" : game.totalToku > 1e8 ? "bg-lv3" : "bg-lv1");
        document.getElementById('mokugyo-img').classList.toggle('mokugyo-mappo', game.mappo);
    }

    // ==========================================
    //  UIÊìç‰Ωú„Å™„Å©
    // ==========================================
    function switchTab(n) { currentTab=n; document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active')); document.querySelector(`.tab[onclick="switchTab('${n}')"]`).classList.add('active'); if(n==='facilities')renderFacilities(); else renderUpgrades(); }
    function renderFacilities(full=true) {
        let c = document.getElementById('store-container'); if(full) c.innerHTML="";
        if(!full && c.children.length===facilityData.length) { Array.from(c.children).forEach((d,i)=>{ let cost=getCost(i); d.classList.toggle('locked',game.toku<cost); d.querySelector('.item-cost').innerText="Âæ≥:"+formatNumber(cost); }); return; }
        facilityData.forEach((f,i)=>{ let cost=getCost(i); let d=document.createElement('div'); d.className=`item ${game.toku>=cost?'':'locked'}`; d.onclick=()=>buyFacility(i); d.innerHTML=`<div style="font-size:24px">${f.icon}</div><div><h4>${f.name}</h4><span class="item-cost">Âæ≥:${formatNumber(cost)}</span></div><div style="font-size:18px;font-weight:bold;color:#666">${game.facilities[i]}</div>`; c.appendChild(d); });
    }
    function renderUpgrades() {
        let c = document.getElementById('store-container'); c.innerHTML="";
        upgradeData.forEach(u=>{ if(!game.upgrades.includes(u.id) && u.req(game)){ let d=document.createElement('div'); d.className=`item ${game.toku>=u.cost?'':'locked'}`; d.onclick=()=>buyUpgrade(u.id); d.innerHTML=`<div style="font-size:24px">üìú</div><div><h4>${u.name}</h4><p>${u.desc}</p><span class="item-cost">Âæ≥:${formatNumber(u.cost)}</span></div>`; c.appendChild(d); }});
    }
    function scheduleFallingItem() { if(fallingItemActive)return; setTimeout(()=>{ spawnFallingItem(); scheduleFallingItem(); }, Math.random()*120000+60000); }
    function spawnFallingItem() { fallingItemActive=true; let el=document.getElementById('falling-item'); el.style.top='-100px'; el.style.display='block'; el.innerText=game.mappo?"üëπ":"üï∏Ô∏è"; el.classList.toggle('oni',game.mappo); setTimeout(()=>{el.style.top='110vh'; setTimeout(()=>{fallingItemActive=false;},1000)}, 8000); }
    function clickFallingItem() { if(!fallingItemActive)return; fallingItemActive=false; document.getElementById('falling-item').style.display='none'; let bonus=Math.max(game.toku*0.1, getTpS()*300); addToku(bonus); playSound('chime'); logMessage("„Éú„Éº„Éä„ÇπÁç≤Âæó: +"+formatNumber(bonus)+"Âæ≥"); }
    function clickNews() { window.open("https://github.com/google/gemini-nirvana-clicker", "_blank"); } // „ÉÄ„Éü„Éº„É™„É≥„ÇØ
    function logMessage(m) { let d=document.createElement('div'); d.innerText=m; document.getElementById('message-log').prepend(d); if(document.getElementById('message-log').children.length>5)document.getElementById('message-log').lastChild.remove(); }

    // ==========================================
    //  „Çª„Éº„Éñ„Éª„É≠„Éº„Éâ„ÉªÂë™Êñá (‰øÆÊ≠£Áâà)
    // ==========================================
    function saveGame(showMsg){ 
        localStorage.setItem('nirvanaV23', JSON.stringify(game)); 
        if(showMsg) alert("Ë®òÈå≤„Åó„Åæ„Åó„Åü"); 
    }
    function loadGame(){ 
        let s=localStorage.getItem('nirvanaV23'); 
        if(s){ 
            try{ 
                game={...game, ...JSON.parse(s)}; 
                if(game.facilities.length < facilityData.length) game.facilities.push(0);
            }catch(e){console.error(e);} 
        } 
        if(game.karma>0){
            document.getElementById('karma-display').style.display="block"; 
            document.getElementById('karma-display').innerText="Ê•≠: "+formatNumber(game.karma);
        } 
    }

    // ‚òÖ‰øÆÊ≠£: Êó•Êú¨Ë™û(Unicode)„Å´ÂØæÂøú„Åó„ÅüÂë™ÊñáÁîüÊàê
    function exportSave(){ 
        // Êó•Êú¨Ë™û„ÇíÂê´„ÇÄÊñáÂ≠óÂàó„ÇíBase64Âåñ„Åô„Çã„Åü„ÇÅ„ÅÆÂá¶ÁêÜ
        let json = JSON.stringify(game);
        let encoded = btoa(unescape(encodeURIComponent(json)));
        
        let area = document.getElementById('save-string');
        area.value = encoded;
        area.select();
        document.execCommand('copy');
        alert("Âë™Êñá„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ"); 
    }

    // ‚òÖ‰øÆÊ≠£: „Éê„É™„Éá„Éº„Ç∑„Éß„É≥‰øÆÊ≠£„Å®Unicode„Éá„Ç≥„Éº„Éâ
    function importSave(){ 
        try{ 
            let str = document.getElementById('save-string').value.trim();
            if(!str) return;

            // Base64„Éá„Ç≥„Éº„ÉâÂá¶ÁêÜ
            let decoded = decodeURIComponent(escape(atob(str)));
            let d = JSON.parse(decoded); 

            // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥: "toku"„Å®„ÅÑ„ÅÜ„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÊåÅ„Å£„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
            if(d.toku !== undefined){ 
                game = d; 
                saveGame(false); 
                location.reload(); 
            } else {
                throw "Invalid data structure"; 
            }
        } catch(e){
            alert("Âë™Êñá„ÅåÈÅï„ÅÑ„Åæ„ÅôÔºàËß£Ë™≠‰∏çËÉΩÔºâ");
            console.error(e);
        } 
    }

    function doPrestige(){ 
        let g=Math.max(0, Math.floor(Math.cbrt(game.allTimeToku/1e6))-game.karma); 
        if(g>0 && confirm("Ëª¢Áîü„Åó„Åæ„Åô„ÅãÔºü")){ 
            game.karma+=g; game.toku=0; game.facilities.fill(0); game.upgrades=[]; game.mappo=false; 
            game.startTime = Date.now(); // Ëª¢ÁîüÊôÇ„ÇÇÊôÇÈñì„Çí„É™„Çª„ÉÉ„Éà
            saveGame(); location.reload(); 
        } 
    }

    // ==========================================
    //  „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
    // ==========================================
    function openModal(id){ document.getElementById(id).classList.add('show'); if(id==='prestige-modal')document.getElementById('prestige-gain').innerText=formatNumber(Math.max(0, Math.floor(Math.cbrt(game.allTimeToku/1e6))-game.karma)); }
    function closeModal(id){ document.getElementById(id).classList.remove('show'); }
    function formatNumber(n){ if(n<1e4)return Math.floor(n).toLocaleString(); let i=0; while(n>=1e4&&i<units.length-1){n/=1e4;i++;} return n.toFixed(2)+units[i]; }
    function spawnFloatText(x,y,t){ let e=document.createElement('div'); e.className='float-text'; e.innerText=t; e.style.left=x+'px'; e.style.top=(y-50)+'px'; e.style.color='#fff'; document.body.appendChild(e); setTimeout(()=>e.remove(),1000); }
    function initAudio(){ if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended')audioCtx.resume(); }
    function playSound(t){ if(!audioCtx)return; let o=audioCtx.createOscillator(),g=audioCtx.createGain(),now=audioCtx.currentTime; o.connect(g); g.connect(audioCtx.destination);
        if(t==='mokugyo'){o.frequency.value=300+Math.random()*50; g.gain.setValueAtTime(0,now); g.gain.linearRampToValueAtTime(0.5,now+0.02); g.gain.exponentialRampToValueAtTime(0.01,now+0.15); o.start(now); o.stop(now+0.15);}
        if(t==='buy'){o.type='sine'; o.frequency.value=600; g.gain.setValueAtTime(0.1,now); g.gain.exponentialRampToValueAtTime(0.01,now+0.1); o.start(now); o.stop(now+0.1);}
        if(t==='chime'){o.type='sine';o.frequency.setValueAtTime(1000,now);o.frequency.linearRampToValueAtTime(1500,now+0.5);g.gain.setValueAtTime(0,now);g.gain.linearRampToValueAtTime(0.2,now+0.1);g.gain.linearRampToValueAtTime(0,now+1);o.start(now);o.stop(now+1);}
        if(t==='mappo'){o.type='sawtooth';o.frequency.setValueAtTime(100,now);g.gain.setValueAtTime(0.3,now);g.gain.linearRampToValueAtTime(0,now+2);o.start(now);o.stop(now+2);}
    }
</script>
</body>
</html>
