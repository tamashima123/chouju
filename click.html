<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第九曼荼羅 - The Infinite Mandala (Ver.Endless)</title>
    <style>
        :root {
            --theme-color: #6a0dad;
            --theme-glow: rgba(106, 13, 173, 0.5);
            --bg-black: #050505;
            --text-gold: #d4af37;
            --card-bg: rgba(20, 20, 20, 0.85);
            --panel-bg: rgba(10, 10, 10, 0.6);
            --karma-color: #ff4500;
        }

        body {
            background-color: var(--bg-black);
            background-image: radial-gradient(circle at 30% 50%, rgba(0,0,0,0) 0%, var(--bg-black) 90%),
                              radial-gradient(circle at 30% 50%, var(--theme-glow) 0%, transparent 60%);
            color: var(--text-gold);
            font-family: 'Yu Mincho', 'MS Mincho', serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            transition: color 1s ease, background-image 1s ease;
        }

        /* レイアウト */
        .main-wrapper { display: flex; height: 100vh; width: 100%; }

        /* 左パネル */
        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            min-width: 320px;
        }

        #header { text-align: center; margin-bottom: 20px; z-index: 20; text-shadow: 0 0 10px var(--theme-glow); }
        h1 { font-size: 1.8rem; letter-spacing: 0.2rem; margin: 0; }
        .stats-main { font-size: 2.5rem; font-weight: bold; font-family: 'Times New Roman', serif; margin: 10px 0; color: #fff; text-shadow: 0 0 8px var(--theme-color); }
        .sub-stats { font-size: 0.95rem; color: #ccc; line-height: 1.5; }
        
        #mandala-stage {
            position: relative; width: 350px; height: 350px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.1s;
        }
        #mandala-stage:active { transform: scale(0.98); }

        .mandala-layer {
            position: absolute; border: 2px solid var(--theme-color);
            border-radius: 50%; opacity: 0.8; box-shadow: 0 0 15px var(--theme-glow);
            transition: all 1s ease;
        }
        #layer1 { width: 320px; height: 320px; border-style: double; border-width: 4px; animation: rotate 60s linear infinite; }
        #layer2 { width: 240px; height: 240px; border-style: dashed; animation: rotate 45s linear infinite reverse; }
        #layer3 { width: 160px; height: 160px; border-style: dotted; border-width: 3px; animation: rotate 30s linear infinite; }
        
        #core {
            width: 90px; height: 90px;
            background: radial-gradient(circle, var(--theme-color) 30%, transparent 80%);
            border: 1px solid var(--theme-color); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #fff; text-shadow: 0 0 5px var(--theme-color);
            font-weight: bold; font-size: 2.5rem; z-index: 5;
            box-shadow: 0 0 40px var(--theme-glow); transition: all 0.2s ease;
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* 右パネル */
        .right-panel {
            flex: 0 0 450px; background: var(--panel-bg);
            border-left: 1px solid #333; overflow-y: auto; padding: 20px;
            box-shadow: -5px 0 20px rgba(0,0,0,0.5); backdrop-filter: blur(5px);
        }

        /* セクション共通 */
        .system-section, .shop-section { margin-bottom: 25px; }
        .system-title { font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #444; color: #fff; display: flex; justify-content: space-between; }
        .shop-title {
            font-size: 1.1rem; border-bottom: 1px solid var(--text-gold);
            margin-bottom: 10px; padding-bottom: 5px; color: #fff;
            position: sticky; top: 0; background: var(--bg-black); z-index: 10;
        }

        /* ボタン */
        .sys-btn {
            background: #222; color: #ccc; border: 1px solid #555;
            padding: 6px 10px; cursor: pointer; font-size: 0.8rem; margin: 2px;
            transition: 0.2s;
        }
        .sys-btn:hover { background: #444; color: #fff; border-color: var(--text-gold); }
        
        .reincarnate-btn {
            width: 100%; padding: 10px; margin-top: 10px;
            background: #200; border: 1px solid var(--karma-color); color: var(--karma-color);
            font-weight: bold; cursor: pointer; font-family: serif;
        }
        .reincarnate-btn:hover:not(:disabled) { background: var(--karma-color); color: #fff; }
        .reincarnate-btn:disabled { border-color: #444; color: #666; background: #111; cursor: not-allowed;}

        /* アイテムカード */
        .item-card {
            background: var(--card-bg); border: 1px solid #444;
            padding: 8px 12px; margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
            transition: 0.2s;
        }
        .item-card.karma-item { border-color: #522; background: rgba(40,10,10,0.8); }
        .item-card:hover { border-color: var(--text-gold); background: rgba(50, 50, 50, 0.95); }

        .item-info { display: flex; flex-direction: column; text-align: left; flex: 1; padding-right: 10px; }
        .item-name { font-weight: bold; color: var(--text-gold); font-size: 0.95rem; }
        .item-effect { font-size: 0.8rem; color: #aaa; margin: 2px 0; }
        .item-count { font-size: 0.75rem; color: #fff; opacity: 0.7; }

        .buy-btn {
            background: linear-gradient(to bottom, #333, #222); color: #fff;
            border: 1px solid #555; padding: 8px 10px; cursor: pointer;
            font-family: 'Times New Roman', serif; min-width: 90px; text-align: right; border-radius: 4px;
        }
        .buy-btn.karma-buy { background: linear-gradient(to bottom, #500, #300); border-color: #a44; }
        .buy-btn:hover:not(:disabled) { background: linear-gradient(to bottom, var(--theme-color), #222); border-color: #fff; }
        .buy-btn:disabled { color: #555; border-color: #222; background: #111; cursor: not-allowed; }

        /* モバイル */
        @media (max-width: 800px) {
            .main-wrapper { flex-direction: column; overflow-y: auto; }
            .left-panel { flex: 0 0 auto; min-height: 450px; }
            .right-panel { flex: 1; border-left: none; border-top: 1px solid #333; overflow-y: visible; }
            body { overflow: auto; }
        }

        /* エフェクト */
        .virtue-pop {
            position: absolute; color: #fff; font-weight: bold; pointer-events: none;
            animation: riseFade 0.6s ease-out forwards; z-index: 100;
            text-shadow: 0 0 3px #000; font-family: 'Times New Roman', serif;
        }
        @keyframes riseFade { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.3); } }

        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9); color: #000; padding: 10px 20px;
            border-radius: 20px; font-weight: bold; opacity: 0; transition: opacity 0.5s;
            pointer-events: none; z-index: 1000;
        }

        /* 転生演出 */
        #liberation-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; color: #000; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; animation: fadeIn 2s ease forwards;
        }
        #prestige-btn-main { padding: 15px 40px; font-size: 1.5rem; border: 2px solid #000; background: transparent; cursor: pointer; transition: 0.3s; }
        #prestige-btn-main:hover { background: #000; color: #fff; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body oncontextmenu="return false;">

    <div class="main-wrapper">
        <div class="left-panel">
            <div id="header">
                <h1 id="rank-name">第零曼荼羅：無明</h1>
                <div style="font-size: 0.8rem; opacity: 0.6; margin-bottom: 5px;">
                    輪廻回数: <span id="transmigration-count">0</span>
                </div>
                <div class="stats-main" id="virtue-display">0</div>
                <div class="sub-stats">
                    <span class="click-power-text">クリック: <span id="click-display">1</span></span><br>
                    自動生産: <span id="ips-display">0</span> ips<br>
                    所持カルマ: <span id="karma-display" style="color: var(--karma-color); font-weight:bold;">0</span> 
                </div>
            </div>

            <div id="mandala-stage" onclick="clickMandala(event)">
                <div id="layer1" class="mandala-layer"></div>
                <div id="layer2" class="mandala-layer"></div>
                <div id="layer3" class="mandala-layer"></div>
                <div id="core">唵</div>
            </div>
        </div>

        <div class="right-panel">
            
            <div class="system-section">
                <div class="system-title">記録と輪廻</div>
                <div class="system-buttons">
                    <button class="sys-btn" onclick="saveGame()">保存</button>
                    <button class="sys-btn" onclick="exportSave()">呪文表示</button>
                    <button class="sys-btn" onclick="importSave()">呪文詠唱</button>
                    <button class="sys-btn" onclick="resetGame()" style="color:#faa;">完全初期化</button>
                </div>
                
                <div id="manual-reincarnate-area" style="margin-top:15px; border-top:1px solid #444; padding-top:10px;">
                    <div style="font-size:0.8rem; color:#aaa;">次の転生で獲得: <span id="pending-karma-ui" style="color:#fff; font-weight:bold;">0</span> カルマ</div>
                    <button id="manual-prestige-btn" class="reincarnate-btn" onclick="triggerLiberation(true)" disabled>
                        輪廻転生する
                    </button>
                </div>
            </div>

            <div class="shop-section" id="karma-shop-section" style="display:none;">
                <div class="shop-title"><span style="color: var(--karma-color);">カルマの秘蹟 (永続強化)</span></div>
                <div id="karma-shop"></div>
            </div>

            <div class="shop-section">
                <div class="shop-title"><span>基礎作法 (クリック)</span></div>
                <div id="click-shop"></div>
            </div>
            <div class="shop-section">
                <div class="shop-title"><span>僧侶と諸天 (自動)</span></div>
                <div id="unit-shop"></div>
            </div>
            <div class="shop-section">
                <div class="shop-title"><span>経典と秘宝 (倍率)</span></div>
                <div id="upgrade-shop"></div>
            </div>
        </div>
    </div>

    <div id="toast">記録しました</div>

    <div id="liberation-overlay">
        <div id="liberation-title" style="font-size: 3rem; font-weight: bold; margin-bottom: 20px; letter-spacing: 0.5rem;">解脱</div>
        <div style="font-size: 1.2rem; margin-bottom: 30px; text-align: center;">
            今生での徳: <span id="total-virtue-end">0</span><br>
            獲得カルマ: <span id="pending-karma" style="font-weight:bold; font-size:1.5rem; color:var(--karma-color);">0</span>
        </div>
        <button id="prestige-btn-main" onclick="doPrestige()">輪廻の輪へ</button>
    </div>

    <script>
        // --- 数値フォーマッター ---
        function formatVirtue(num) {
            if (num < 10000) return Math.floor(num).toLocaleString();
            if (num >= 1e68) return num.toExponential(2).replace("+", ""); // 無量大数を超えたら指数表記

            const units = ["", "万", "億", "兆", "京", "垓", "𥝱", "穣", "溝", "澗", "正", "載", "極", "恒河沙", "阿僧祇", "那由他", "不可思議", "無量大数"];
            let unitIndex = 0;
            let tempNum = num;
            while (tempNum >= 10000 && unitIndex < units.length - 1) {
                tempNum /= 10000;
                unitIndex++;
            }
            return tempNum.toFixed(2) + units[unitIndex];
        }

        // --- データ定義 ---
        const clickData = [ { name: "清貧", power: 1, cost: 10 } ];
        
        const unitData = [
            { name: "修行僧", rate: 1, cost: 15 },
            { name: "東の若僧", rate: 70, cost: 1500 },
            { name: "南の僧侶", rate: 300, cost: 8000 },
            { name: "南の高僧", rate: 40000, cost: 2000000 },
            { name: "西の老僧", rate: 2000000, cost: 150000000 },
            { name: "北の天才", rate: 800000000, cost: 50000000000 },
            { name: "無名天", rate: 10000000000, cost: 3000000000000 }, 
            { name: "怒れる明王", rate: 1000000000000, cost: 500000000000000 }, 
            { name: "慈愛の菩薩", rate: 100000000000000, cost: 80000000000000000 }, 
            { name: "圧巻の如来", rate: 10000000000000000, cost: 9000000000000000000 }
        ];

        const upgradeData = [
            { name: "弟子の写経", mult: 1.01, cost: 500 },
            { name: "中品質の写経", mult: 1.05, cost: 50000 },
            { name: "完璧な写経", mult: 1.08, cost: 10000000 },
            { name: "唐の経典", mult: 1.09, cost: 500000000 }, 
            { name: "天竺の経典", mult: 1.10, cost: 200000000000 },
            { name: "聖人のミイラ", mult: 1.20, cost: 100000000000000 }
        ];

        // 永続アップグレード（カルマショップ）
        const karmaShopData = [
            { name: "徳の残滓", desc: "初期の徳 +1000", type: "start", val: 1000, cost: 1, max: 10 },
            { name: "阿頼耶識", desc: "カルマボーナス効果 +10%", type: "bonus", val: 0.1, cost: 5, max: 50 },
            { name: "時間の超越", desc: "全生産力 +50%", type: "prod", val: 0.5, cost: 10, max: 100 },
            { name: "指先の宇宙", desc: "クリック基礎力 +100%", type: "click", val: 1.0, cost: 20, max: 20 },
        ];

        const rankNames = [
            { name: "第零曼荼羅：無明", color: "#6a0dad" },
            { name: "第一曼荼羅：胎蔵界", color: "#4b0082" },
            { name: "第二曼荼羅：金剛界", color: "#0000ff" },
            { name: "第三曼荼羅：阿弥陀", color: "#008000" },
            { name: "第四曼荼羅：蓮華", color: "#adff2f" },
            { name: "第五曼荼羅：虚空", color: "#ffff00" },
            { name: "第六曼荼羅：寂静", color: "#ffd700" },
            { name: "第七曼荼羅：遍照", color: "#ffa500" },
            { name: "第八曼荼羅：解脱", color: "#ff4500" },
            { name: "第九曼荼羅：不可説不可説転", color: "#ff0000" }
        ];

        let game = {
            virtue: 0,
            totalVirtue: 0,
            karma: 0,
            rank: 0,
            transmigrations: 0, // 転生回数
            clicks: new Array(clickData.length).fill(0),
            units: new Array(unitData.length).fill(0),
            upgrades: new Array(upgradeData.length).fill(0),
            karmaUpgrades: new Array(karmaShopData.length).fill(0), // 永続強化所持数
            lastSave: Date.now()
        };

        // --- 初期化 ---
        function init() {
            createShopUI();
            loadGame(); 
            
            // 2周目以降ならカルマショップ表示
            if (game.transmigrations > 0 || game.karma > 0) {
                document.getElementById('karma-shop-section').style.display = 'block';
            }
            
            applyRankTheme(game.rank);
            updateDisplay();
            gameLoop();
            setInterval(saveGame, 60000);
        }

        // --- UI生成 ---
        function createShopUI() {
            // 通常アイテム
            const cShop = document.getElementById('click-shop');
            clickData.forEach((c, i) => cShop.innerHTML += createCardHTML(c.name, `クリック徳 +${c.power}`, `c-cnt-${i}`, `c-btn-${i}`, `c-cost-${i}`, `buyClickItem(${i})`));
            
            const uShop = document.getElementById('unit-shop');
            unitData.forEach((u, i) => uShop.innerHTML += createCardHTML(u.name, `+${formatVirtue(u.rate)} /sec`, `u-cnt-${i}`, `u-btn-${i}`, `u-cost-${i}`, `buyUnit(${i})`));
            
            const upShop = document.getElementById('upgrade-shop');
            upgradeData.forEach((u, i) => upShop.innerHTML += createCardHTML(u.name, `生産量 ${Math.round((u.mult-1)*100)}% UP`, `up-cnt-${i}`, `up-btn-${i}`, `up-cost-${i}`, `buyUpgrade(${i})`));

            // カルマショップ
            const kShop = document.getElementById('karma-shop');
            karmaShopData.forEach((k, i) => {
                kShop.innerHTML += `
                <div class="item-card karma-item">
                    <div class="item-info">
                        <span class="item-name" style="color:#ff8888;">${k.name}</span>
                        <span class="item-effect">${k.desc}</span>
                        <span class="item-count" id="k-cnt-${i}">Lv: 0 / ${k.max}</span>
                    </div>
                    <button class="buy-btn karma-buy" id="k-btn-${i}" onclick="buyKarmaItem(${i})">
                        <small>カルマ消費</small>
                        <span id="k-cost-${i}">${k.cost}</span>
                    </button>
                </div>`;
            });
        }

        function createCardHTML(name, effect, countId, btnId, costId, func) {
            return `<div class="item-card"><div class="item-info"><span class="item-name">${name}</span><span class="item-effect">${effect}</span><span class="item-count" id="${countId}">所持: 0</span></div><button class="buy-btn" id="${btnId}" onclick="${func}"><small>徳を捧げる</small><span id="${costId}">-</span></button></div>`;
        }

        // --- ロジック: 計算 ---
        function getKarmaBonusMultiplier() {
            // 基本10% + カルマアップグレード効果
            let baseRate = 0.1;
            const upgradeLevel = game.karmaUpgrades[1] || 0; // 阿頼耶識
            baseRate += baseRate * (upgradeLevel * karmaShopData[1].val);
            return 1 + (game.karma * baseRate);
        }

        function getGlobalMultiplier() {
            let mult = 1;
            // 経典
            upgradeData.forEach((u, i) => mult *= Math.pow(u.mult, game.upgrades[i]));
            // カルマ永続強化: 時間の超越
            const timeLevel = game.karmaUpgrades[2] || 0;
            const timeMult = 1 + (timeLevel * karmaShopData[2].val);
            
            return mult * getKarmaBonusMultiplier() * timeMult;
        }

        function calculateIPS() {
            let base = 0;
            unitData.forEach((u, i) => base += u.rate * game.units[i]);
            return base * getGlobalMultiplier();
        }

        function calculateClickPower() {
            let baseClick = 1;
            // カルマ永続強化: 指先の宇宙
            const clickLevel = game.karmaUpgrades[3] || 0;
            baseClick *= 1 + (clickLevel * karmaShopData[3].val);

            clickData.forEach((c, i) => baseClick += c.power * game.clicks[i]);
            return (baseClick * getGlobalMultiplier()) + (calculateIPS() * 0.05);
        }

        function getPendingKarma() {
            // 獲得カルマ = sqrt(総徳 / 1兆)
            return Math.floor(Math.sqrt(game.totalVirtue / 1000000000000));
        }

        // --- ロジック: アクション ---

        function clickMandala(e) {
            const power = calculateClickPower();
            addVirtue(power);
            
            const rect = document.getElementById('mandala-stage').getBoundingClientRect();
            const pop = document.createElement('div');
            pop.className = 'virtue-pop';
            pop.innerText = `+${formatVirtue(power)}`;
            pop.style.left = `${e.clientX - rect.left}px`;
            pop.style.top = `${e.clientY - rect.top}px`;
            document.getElementById('mandala-stage').appendChild(pop);
            setTimeout(() => pop.remove(), 600);

            const core = document.getElementById('core');
            core.style.transform = 'scale(1.1)';
            setTimeout(() => core.style.transform = 'scale(1)', 100);
        }

        function addVirtue(amount) {
            // 無限モードじゃない場合、ランク9でカンスト
            if (game.transmigrations === 0 && game.rank >= 9) return;
            
            game.virtue += amount;
            game.totalVirtue += amount;

            // ランクアップ閾値
            let threshold = Math.pow(100, game.rank + 1);
            if (game.rank === 8) threshold = 1000 * Math.pow(100, 9); // 8->9の壁
            if (game.rank >= 9) {
                 // 9以降は指数関数的にきつくするが、JSの限界まで遊べるように調整
                 threshold = 1e20 * Math.pow(10, (game.rank - 9) * 2); 
            }

            if (game.virtue >= threshold) {
                // 初回プレイでランク9到達時 -> エンディングへ
                if (game.transmigrations === 0 && game.rank === 8) {
                    game.rank++;
                    triggerLiberation(false);
                    return;
                }
                
                // それ以外は普通にランクアップ
                game.rank++;
                applyRankTheme(game.rank);
            }
        }

        // --- 購入処理 ---
        function buyClickItem(i) {
            const cost = Math.floor(clickData[i].cost * Math.pow(1.5, game.clicks[i]));
            if (game.virtue >= cost) { game.virtue -= cost; game.clicks[i]++; updateDisplay(); }
        }
        function buyUnit(i) {
            const cost = Math.floor(unitData[i].cost * Math.pow(1.15, game.units[i]));
            if (game.virtue >= cost) { game.virtue -= cost; game.units[i]++; updateDisplay(); }
        }
        function buyUpgrade(i) {
            const cost = Math.floor(upgradeData[i].cost * Math.pow(1.8, game.upgrades[i]));
            if (game.virtue >= cost) { game.virtue -= cost; game.upgrades[i]++; updateDisplay(); }
        }
        function buyKarmaItem(i) {
            const k = karmaShopData[i];
            const currentLv = game.karmaUpgrades[i];
            if (currentLv >= k.max) return;
            
            // コスト計算 (線形増加か指数増加か。ここでは単純に固定+Lv増分とする)
            let cost = k.cost + (currentLv * Math.ceil(k.cost * 0.5));
            
            if (game.karma >= cost) {
                game.karma -= cost;
                game.karmaUpgrades[i]++;
                updateDisplay();
                saveGame();
            }
        }

        // --- 表示更新 ---
        function updateDisplay() {
            document.getElementById('virtue-display').innerText = formatVirtue(game.virtue);
            document.getElementById('ips-display').innerText = formatVirtue(calculateIPS());
            document.getElementById('click-display').innerText = formatVirtue(calculateClickPower());
            document.getElementById('karma-display').innerText = formatVirtue(game.karma);
            document.getElementById('transmigration-count').innerText = game.transmigrations;

            // 任意転生ボタンの制御
            const pending = getPendingKarma();
            document.getElementById('pending-karma-ui').innerText = formatVirtue(pending);
            const manBtn = document.getElementById('manual-prestige-btn');
            manBtn.disabled = pending <= 0;
            // 2周目以降のみ表示
            document.getElementById('manual-reincarnate-area').style.display = (game.transmigrations > 0) ? 'block' : 'none';

            // 通常ショップボタン更新
            const updateBtn = (id, baseCost, count, power, type) => {
                const cost = Math.floor(baseCost * Math.pow(power, count));
                const btn = document.getElementById(type + '-btn-' + id);
                document.getElementById(type + '-cost-' + id).innerText = formatVirtue(cost);
                document.getElementById(type + '-cnt-' + id).innerText = `所持: ${count}`;
                btn.disabled = game.virtue < cost;
            };
            clickData.forEach((c, i) => updateBtn(i, c.cost, game.clicks[i], 1.5, 'c'));
            unitData.forEach((u, i) => updateBtn(i, u.cost, game.units[i], 1.15, 'u'));
            upgradeData.forEach((u, i) => updateBtn(i, u.cost, game.upgrades[i], 1.8, 'up'));

            // カルマショップ更新
            karmaShopData.forEach((k, i) => {
                const currentLv = game.karmaUpgrades[i];
                const btn = document.getElementById(`k-btn-${i}`);
                const cost = k.cost + (currentLv * Math.ceil(k.cost * 0.5));
                
                document.getElementById(`k-cnt-${i}`).innerText = `Lv: ${currentLv} / ${k.max}`;
                
                if (currentLv >= k.max) {
                    btn.disabled = true;
                    document.getElementById(`k-cost-${i}`).innerText = "MAX";
                } else {
                    btn.disabled = game.karma < cost;
                    document.getElementById(`k-cost-${i}`).innerText = formatVirtue(cost);
                }
            });
        }

        function applyRankTheme(r) {
            let name, color;

            if (r < 10) {
                // 通常ランク
                name = rankNames[r].name;
                color = rankNames[r].color;
            } else {
                // 無限ランク (プロシージャル生成)
                const layer = r - 9;
                const hue = (r * 45) % 360; // 色相を回転
                color = `hsl(${hue}, 100%, 50%)`;
                name = `第${r}曼荼羅：無限界・第${layer}層`;
            }

            document.getElementById('rank-name').innerText = name;
            document.getElementById('rank-name').style.color = (r >= 10) ? color : 'var(--text-gold)';
            
            const root = document.documentElement;
            root.style.setProperty('--theme-color', color);
            root.style.setProperty('--theme-glow', color + "80");
            
            // 回転速度はランクが高いほど速く、あるいは神々しくゆっくりに？ ここでは速くする
            const speed = Math.max(2, 60 / (r * 0.5 + 1));
            document.getElementById('layer1').style.animationDuration = speed + "s";
            document.getElementById('layer2').style.animationDuration = (speed * 0.7) + "s";
        }

        // --- 転生システム ---
        function triggerLiberation(isManual) {
            const overlay = document.getElementById('liberation-overlay');
            const pending = getPendingKarma();
            
            document.getElementById('total-virtue-end').innerText = formatVirtue(game.totalVirtue);
            document.getElementById('pending-karma').innerText = formatVirtue(pending);
            document.getElementById('liberation-title').innerText = isManual ? "輪廻" : "解脱";
            
            overlay.style.display = 'flex';
        }

        function doPrestige() {
            const earned = getPendingKarma();
            game.karma += earned;
            game.transmigrations++;

            // リセット対象
            game.virtue = 0;
            game.totalVirtue = 0;
            game.rank = 0;
            
            // 初期ボーナス（徳の残滓）
            const startBonus = (game.karmaUpgrades[0] || 0) * karmaShopData[0].val;
            game.virtue += startBonus;
            
            game.clicks.fill(0);
            game.units.fill(0);
            game.upgrades.fill(0);

            document.getElementById('liberation-overlay').style.display = 'none';
            document.getElementById('karma-shop-section').style.display = 'block'; // ショップ解禁
            
            applyRankTheme(0);
            saveGame();
            updateDisplay();
        }

        // --- セーブ/ロード ---
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = 1; setTimeout(() => t.style.opacity = 0, 2000);
        }
        function saveGame() {
            game.lastSave = Date.now();
            localStorage.setItem('mandalaSave_v7', JSON.stringify(game));
            showToast("記録しました");
        }
        function loadGame() {
            const saved = localStorage.getItem('mandalaSave_v7');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    game = { ...game, ...parsed };
                    
                    // 配列拡張時の補正
                    if (game.karmaUpgrades === undefined) game.karmaUpgrades = new Array(karmaShopData.length).fill(0);
                    if (game.karmaUpgrades.length < karmaShopData.length) game.karmaUpgrades = game.karmaUpgrades.concat(new Array(karmaShopData.length - game.karmaUpgrades.length).fill(0));
                    
                    // その他配列補正
                    if (game.clicks.length < clickData.length) game.clicks = game.clicks.concat(new Array(clickData.length - game.clicks.length).fill(0));
                    if (game.units.length < unitData.length) game.units = game.units.concat(new Array(unitData.length - game.units.length).fill(0));
                    
                    showToast("記録を読み込みました");
                } catch(e) { console.error(e); }
            }
        }
        function exportSave() { saveGame(); prompt("呪文をコピー:", btoa(JSON.stringify(game))); }
        function importSave() {
            const s = prompt("呪文を入力:");
            if(s){ try{ game={...game,...JSON.parse(atob(s))}; applyRankTheme(game.rank); updateDisplay(); saveGame(); showToast("復活"); }catch(e){alert("無効");} }
        }
        function resetGame() { if(confirm("完全リセットしますか？")) { localStorage.removeItem('mandalaSave_v7'); location.reload(); } }

        // --- ループ ---
        let lastTime = Date.now();
        function gameLoop() {
            const now = Date.now();
            const dt = (now - lastTime) / 1000;
            lastTime = now;
            
            // 初回ランク9未満、または2周目以降なら常に加算
            if (game.transmigrations > 0 || game.rank < 9) {
                const ips = calculateIPS();
                if (ips > 0) addVirtue(ips * dt);
                updateDisplay();
            }
            requestAnimationFrame(gameLoop);
        }

        init();
    </script>
</body>
</html>
